/*
_comments - Bool; [optional];
 Set this flag to true to prevent removing comments from @text ( minxml and mincss functions only. )

 Examples:
 vkbeautify.xml(text); // pretty print XML
 vkbeautify.json(text, 4 ); // pretty print JSON
 vkbeautify.css(text, '. . . .'); // pretty print CSS
 vkbeautify.sql(text, '----'); // pretty print SQL

 vkbeautify.xmlmin(text, true);// minify XML, preserve comments
 vkbeautify.jsonmin(text);// minify JSON
 vkbeautify.cssmin(text);// minify CSS, remove comments ( default )
 vkbeautify.sqlmin(text);// minify SQL

*/
(function(){var a=false,c=/xyz/.test(function(){})?/\b_super\b/:/.*/;this.Class=function(){};Class.extend=function(f){function b(){!a&&this.init&&this.init.apply(this,arguments)}var k=this.prototype;a=true;var m=new this;a=false;for(var h in f)m[h]=typeof f[h]=="function"&&typeof k[h]=="function"&&c.test(f[h])?function(l,d){return function(){var g=this._super;this._super=k[l];var j=d.apply(this,arguments);this._super=g;return j}}(h,f[h]):f[h];b.prototype=m;b.prototype.constructor=b;b.extend=arguments.callee;
return b}})();
var localstoragedetect=function(){var a=null,c=null;return{localStorageSupported:function(){if(a===null){a=true;c=false;try{if(!("localStorage"in window))throw Error("No localStorage object.");try{var f=window.localStorage}catch(b){c=true;throw Error("Permission denied accessing localStorage object.");}if(f===null)throw Error("localStorage object is null.");localStorage.setItem("localStorageTestKey","dummy");if(localStorage.getItem("localStorageTestKey")!=="dummy")throw Error("localStorage test key had wrong value when getItem called.");localStorage.removeItem("localStorageTestKey")}catch(k){a=
false}}return a},permissionDeniedAccessingLocalStorage:function(){return c}}}(),appdetect=function(){function a(){c=true;if(localstoragedetect.localStorageSupported()){var k=localStorage.getItem(b);if(k!==null){k=parseInt(k);if(typeof IOS_APP_VERSION==="undefined")window.IOS_APP_VERSION=k;localStorage.removeItem(b)}}f=typeof IOS_APP_VERSION!=="undefined"}var c=false,f=null,b="IOS_APP_VERSION";return{isIOSApp:function(){c||a();return f},getIOSAppVersion:function(){c||a();return IOS_APP_VERSION}}}();
(function(){function a(f){var b="    ";if(isNaN(parseInt(f)))b=f;else switch(f){case 1:b=" ";break;case 2:b="  ";break;case 3:b="   ";break;case 4:b="    ";break;case 5:b="     ";break;case 6:b="      ";break;case 7:b="       ";break;case 8:b="        ";break;case 9:b="         ";break;case 10:b="          ";break;case 11:b="           ";break;case 12:b="            "}f=["\n"];for(ix=0;ix<100;ix++)f.push(f[ix]+b);return f}function c(){this.step="    ";this.shift=a(this.step)}c.prototype.xml=function(f,
b){var k=f.replace(/>\s{0,}</g,"><").replace(/</g,"~::~<").replace(/\s*xmlns\:/g,"~::~xmlns:").replace(/\s*xmlns\=/g,"~::~xmlns=").split("~::~"),m=k.length,h=false,l=0,d="",g=0,j=b?a(b):this.shift;for(g=0;g<m;g++)if(k[g].search(/<!/)>-1){d+=j[l]+k[g];h=true;if(k[g].search(/--\>/)>-1||k[g].search(/\]>/)>-1||k[g].search(/!DOCTYPE/)>-1)h=false}else if(k[g].search(/--\>/)>-1||k[g].search(/\]>/)>-1){d+=k[g];h=false}else if(/^<\w/.exec(k[g-1])&&/^<\/\w/.exec(k[g])&&/^<[\w:\-\.\,]+/.exec(k[g-1])==/^<\/[\w:\-\.\,]+/.exec(k[g])[0].replace("/",
"")){d+=k[g];h||l--}else if(k[g].search(/<\w/)>-1&&k[g].search(/<\//)==-1&&k[g].search(/\/>/)==-1)d=!h?d+=j[l++]+k[g]:d+=k[g];else if(k[g].search(/<\w/)>-1&&k[g].search(/<\//)>-1)d=!h?d+=j[l]+k[g]:d+=k[g];else if(k[g].search(/<\//)>-1)d=!h?d+=j[--l]+k[g]:d+=k[g];else if(k[g].search(/\/>/)>-1)d=!h?d+=j[l]+k[g]:d+=k[g];else d+=k[g].search(/<\?/)>-1?j[l]+k[g]:k[g].search(/xmlns\:/)>-1||k[g].search(/xmlns\=/)>-1?j[l]+k[g]:k[g];return d[0]=="\n"?d.slice(1):d};c.prototype.json=function(f,b){b=b?b:this.step;
if(typeof JSON==="undefined")return f;if(typeof f==="string")return JSON.stringify(JSON.parse(f),null,b);if(typeof f==="object")return JSON.stringify(f,null,b);return f};c.prototype.css=function(f,b){var k=f.replace(/\s{1,}/g," ").replace(/\{/g,"{~::~").replace(/\}/g,"~::~}~::~").replace(/\;/g,";~::~").replace(/\/\*/g,"~::~/*").replace(/\*\//g,"*/~::~").replace(/~::~\s{0,}~::~/g,"~::~").split("~::~"),m=k.length,h=0,l="",d=0,g=b?a(b):this.shift;for(d=0;d<m;d++)if(/\{/.exec(k[d]))l+=g[h++]+k[d];else if(/\}/.exec(k[d]))l+=
g[--h]+k[d];else{/\*\\/.exec(k[d]);l+=g[h]+k[d]}return l.replace(/^\n{1,}/,"")};c.prototype.sql=function(f,b){var k=f.replace(/\s{1,}/g," ").replace(/\'/ig,"~::~'").split("~::~"),m=k.length,h=[],l=0,d=this.step,g=0,j="",o=0,n=b?a(b):this.shift;for(o=0;o<m;o++)h=o%2?h.concat(k[o]):h.concat(k[o].replace(/\s{1,}/g," ").replace(/ AND /ig,"~::~"+d+d+"AND ").replace(/ BETWEEN /ig,"~::~"+d+"BETWEEN ").replace(/ CASE /ig,"~::~"+d+"CASE ").replace(/ ELSE /ig,"~::~"+d+"ELSE ").replace(/ END /ig,"~::~"+d+"END ").replace(/ FROM /ig,
"~::~FROM ").replace(/ GROUP\s{1,}BY/ig,"~::~GROUP BY ").replace(/ HAVING /ig,"~::~HAVING ").replace(/ IN /ig," IN ").replace(/ JOIN /ig,"~::~JOIN ").replace(/ CROSS~::~{1,}JOIN /ig,"~::~CROSS JOIN ").replace(/ INNER~::~{1,}JOIN /ig,"~::~INNER JOIN ").replace(/ LEFT~::~{1,}JOIN /ig,"~::~LEFT JOIN ").replace(/ RIGHT~::~{1,}JOIN /ig,"~::~RIGHT JOIN ").replace(/ ON /ig,"~::~"+d+"ON ").replace(/ OR /ig,"~::~"+d+d+"OR ").replace(/ ORDER\s{1,}BY/ig,"~::~ORDER BY ").replace(/ OVER /ig,"~::~"+d+"OVER ").replace(/\(\s{0,}SELECT /ig,
"~::~(SELECT ").replace(/\)\s{0,}SELECT /ig,")~::~SELECT ").replace(/ THEN /ig," THEN~::~"+d+"").replace(/ UNION /ig,"~::~UNION~::~").replace(/ USING /ig,"~::~USING ").replace(/ WHEN /ig,"~::~"+d+"WHEN ").replace(/ WHERE /ig,"~::~WHERE ").replace(/ WITH /ig,"~::~WITH ").replace(/ ALL /ig," ALL ").replace(/ AS /ig," AS ").replace(/ ASC /ig," ASC ").replace(/ DESC /ig," DESC ").replace(/ DISTINCT /ig," DISTINCT ").replace(/ EXISTS /ig," EXISTS ").replace(/ NOT /ig," NOT ").replace(/ NULL /ig," NULL ").replace(/ LIKE /ig,
" LIKE ").replace(/\s{0,}SELECT /ig,"SELECT ").replace(/\s{0,}UPDATE /ig,"UPDATE ").replace(/ SET /ig," SET ").replace(/~::~{1,}/g,"~::~").split("~::~"));m=h.length;for(o=0;o<m;o++){g-=h[o].replace(/\(/g,"").length-h[o].replace(/\)/g,"").length;if(/\s{0,}\s{0,}SELECT\s{0,}/.exec(h[o]))h[o]=h[o].replace(/\,/g,",\n"+d+d+"");if(/\s{0,}\s{0,}SET\s{0,}/.exec(h[o]))h[o]=h[o].replace(/\,/g,",\n"+d+d+"");if(/\s{0,}\(\s{0,}SELECT\s{0,}/.exec(h[o])){l++;j+=n[l]+h[o]}else if(/\'/.exec(h[o])){g<1&&l&&l--;j+=
h[o]}else{j+=n[l]+h[o];g<1&&l&&l--}}return j=j.replace(/^\n{1,}/,"").replace(/\n{1,}/g,"\n")};c.prototype.xmlmin=function(f,b){return(b?f:f.replace(/\<![ \r\n\t]*(--([^\-]|[\r\n]|-[^\-])*--[ \r\n\t]*)\>/g,"").replace(/[ \r\n\t]{1,}xmlns/g," xmlns")).replace(/>\s{0,}</g,"><")};c.prototype.jsonmin=function(f){if(typeof JSON==="undefined")return f;return JSON.stringify(JSON.parse(f),null,0)};c.prototype.cssmin=function(f,b){return(b?f:f.replace(/\/\*([^*]|[\r\n]|(\*+([^*/]|[\r\n])))*\*+\//g,"")).replace(/\s{1,}/g,
" ").replace(/\{\s{1,}/g,"{").replace(/\}\s{1,}/g,"}").replace(/\;\s{1,}/g,";").replace(/\/\*\s{1,}/g,"/*").replace(/\*\/\s{1,}/g,"*/")};c.prototype.sqlmin=function(f){return f.replace(/\s{1,}/g," ").replace(/\s{1,}\(/,"(").replace(/\s{1,}\)/,")")};window.vkbeautify=new c})();
var LZString={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",_f:String.fromCharCode,compressToBase64:function(a){if(a==null)return"";var c="",f,b,k,m,h,l,d=0;for(a=this.compress(a);d<a.length*2;){if(d%2==0){f=a.charCodeAt(d/2)>>8;b=a.charCodeAt(d/2)&255;k=d/2+1<a.length?a.charCodeAt(d/2+1)>>8:NaN}else{f=a.charCodeAt((d-1)/2)&255;if((d+1)/2<a.length){b=a.charCodeAt((d+1)/2)>>8;k=a.charCodeAt((d+1)/2)&255}else b=k=NaN}d+=3;m=f>>2;f=(f&3)<<4|b>>4;h=(b&15)<<2|k>>6;l=k&63;
if(isNaN(b))h=l=64;else if(isNaN(k))l=64;c=c+this._keyStr.charAt(m)+this._keyStr.charAt(f)+this._keyStr.charAt(h)+this._keyStr.charAt(l)}return c},decompressFromBase64:function(a){if(a==null)return"";var c="",f=0,b,k,m,h,l,d,g=0,j=this._f;for(a=a.replace(/[^A-Za-z0-9\+\/\=]/g,"");g<a.length;){k=this._keyStr.indexOf(a.charAt(g++));m=this._keyStr.indexOf(a.charAt(g++));l=this._keyStr.indexOf(a.charAt(g++));d=this._keyStr.indexOf(a.charAt(g++));k=k<<2|m>>4;m=(m&15)<<4|l>>2;h=(l&3)<<6|d;if(f%2==0){b=
k<<8;if(l!=64)c+=j(b|m);if(d!=64)b=h<<8}else{c+=j(b|k);if(l!=64)b=m<<8;if(d!=64)c+=j(b|h)}f+=3}return this.decompress(c)},compressToUTF16:function(a){if(a==null)return"";var c="",f,b,k,m=0,h=this._f;a=this.compress(a);for(f=0;f<a.length;f++){b=a.charCodeAt(f);switch(m++){case 0:c+=h((b>>1)+32);k=(b&1)<<14;break;case 1:c+=h(k+(b>>2)+32);k=(b&3)<<13;break;case 2:c+=h(k+(b>>3)+32);k=(b&7)<<12;break;case 3:c+=h(k+(b>>4)+32);k=(b&15)<<11;break;case 4:c+=h(k+(b>>5)+32);k=(b&31)<<10;break;case 5:c+=h(k+
(b>>6)+32);k=(b&63)<<9;break;case 6:c+=h(k+(b>>7)+32);k=(b&127)<<8;break;case 7:c+=h(k+(b>>8)+32);k=(b&255)<<7;break;case 8:c+=h(k+(b>>9)+32);k=(b&511)<<6;break;case 9:c+=h(k+(b>>10)+32);k=(b&1023)<<5;break;case 10:c+=h(k+(b>>11)+32);k=(b&2047)<<4;break;case 11:c+=h(k+(b>>12)+32);k=(b&4095)<<3;break;case 12:c+=h(k+(b>>13)+32);k=(b&8191)<<2;break;case 13:c+=h(k+(b>>14)+32);k=(b&16383)<<1;break;case 14:c+=h(k+(b>>15)+32,(b&32767)+32);m=0}}return c+h(k+32)},decompressFromUTF16:function(a){if(a==null)return"";
for(var c="",f,b,k=0,m=0,h=this._f;m<a.length;){b=a.charCodeAt(m)-32;switch(k++){case 0:f=b<<1;break;case 1:c+=h(f|b>>14);f=(b&16383)<<2;break;case 2:c+=h(f|b>>13);f=(b&8191)<<3;break;case 3:c+=h(f|b>>12);f=(b&4095)<<4;break;case 4:c+=h(f|b>>11);f=(b&2047)<<5;break;case 5:c+=h(f|b>>10);f=(b&1023)<<6;break;case 6:c+=h(f|b>>9);f=(b&511)<<7;break;case 7:c+=h(f|b>>8);f=(b&255)<<8;break;case 8:c+=h(f|b>>7);f=(b&127)<<9;break;case 9:c+=h(f|b>>6);f=(b&63)<<10;break;case 10:c+=h(f|b>>5);f=(b&31)<<11;break;
case 11:c+=h(f|b>>4);f=(b&15)<<12;break;case 12:c+=h(f|b>>3);f=(b&7)<<13;break;case 13:c+=h(f|b>>2);f=(b&3)<<14;break;case 14:c+=h(f|b>>1);f=(b&1)<<15;break;case 15:c+=h(f|b);k=0}m++}return this.decompress(c)},compress:function(a){if(a==null)return"";var c,f,b={},k={},m="",h="",l="",d=2,g=3,j=2,o="",n=0,q=0,r,t=this._f;for(r=0;r<a.length;r+=1){m=a.charAt(r);if(!Object.prototype.hasOwnProperty.call(b,m)){b[m]=g++;k[m]=true}h=l+m;if(Object.prototype.hasOwnProperty.call(b,h))l=h;else{if(Object.prototype.hasOwnProperty.call(k,
l)){if(l.charCodeAt(0)<256){for(c=0;c<j;c++){n<<=1;if(q==15){q=0;o+=t(n);n=0}else q++}f=l.charCodeAt(0);for(c=0;c<8;c++){n=n<<1|f&1;if(q==15){q=0;o+=t(n);n=0}else q++;f>>=1}}else{f=1;for(c=0;c<j;c++){n=n<<1|f;if(q==15){q=0;o+=t(n);n=0}else q++;f=0}f=l.charCodeAt(0);for(c=0;c<16;c++){n=n<<1|f&1;if(q==15){q=0;o+=t(n);n=0}else q++;f>>=1}}d--;if(d==0){d=Math.pow(2,j);j++}delete k[l]}else{f=b[l];for(c=0;c<j;c++){n=n<<1|f&1;if(q==15){q=0;o+=t(n);n=0}else q++;f>>=1}}d--;if(d==0){d=Math.pow(2,j);j++}b[h]=
g++;l=String(m)}}if(l!==""){if(Object.prototype.hasOwnProperty.call(k,l)){if(l.charCodeAt(0)<256){for(c=0;c<j;c++){n<<=1;if(q==15){q=0;o+=t(n);n=0}else q++}f=l.charCodeAt(0);for(c=0;c<8;c++){n=n<<1|f&1;if(q==15){q=0;o+=t(n);n=0}else q++;f>>=1}}else{f=1;for(c=0;c<j;c++){n=n<<1|f;if(q==15){q=0;o+=t(n);n=0}else q++;f=0}f=l.charCodeAt(0);for(c=0;c<16;c++){n=n<<1|f&1;if(q==15){q=0;o+=t(n);n=0}else q++;f>>=1}}d--;if(d==0){d=Math.pow(2,j);j++}delete k[l]}else{f=b[l];for(c=0;c<j;c++){n=n<<1|f&1;if(q==15){q=
0;o+=t(n);n=0}else q++;f>>=1}}d--;d==0&&j++}f=2;for(c=0;c<j;c++){n=n<<1|f&1;if(q==15){q=0;o+=t(n);n=0}else q++;f>>=1}for(;;){n<<=1;if(q==15){o+=t(n);break}else q++}return o},decompress:function(a){if(a==null)return"";var c=[],f=4,b=4,k=3,m="",h="",l,d,g,j,o,n=this._f;a={string:a,val:a.charCodeAt(0),position:32768,index:1};for(h=0;h<3;h+=1)c[h]=h;m=0;g=Math.pow(2,2);for(j=1;j!=g;){d=a.val&a.position;a.position>>=1;if(a.position==0){a.position=32768;a.val=a.string.charCodeAt(a.index++)}m|=(d>0?1:0)*
j;j<<=1}switch(m){case 0:m=0;g=Math.pow(2,8);for(j=1;j!=g;){d=a.val&a.position;a.position>>=1;if(a.position==0){a.position=32768;a.val=a.string.charCodeAt(a.index++)}m|=(d>0?1:0)*j;j<<=1}o=n(m);break;case 1:m=0;g=Math.pow(2,16);for(j=1;j!=g;){d=a.val&a.position;a.position>>=1;if(a.position==0){a.position=32768;a.val=a.string.charCodeAt(a.index++)}m|=(d>0?1:0)*j;j<<=1}o=n(m);break;case 2:return""}for(l=h=c[3]=o;;){m=0;g=Math.pow(2,k);for(j=1;j!=g;){d=a.val&a.position;a.position>>=1;if(a.position==
0){a.position=32768;a.val=a.string.charCodeAt(a.index++)}m|=(d>0?1:0)*j;j<<=1}switch(o=m){case 0:m=0;g=Math.pow(2,8);for(j=1;j!=g;){d=a.val&a.position;a.position>>=1;if(a.position==0){a.position=32768;a.val=a.string.charCodeAt(a.index++)}m|=(d>0?1:0)*j;j<<=1}c[b++]=n(m);o=b-1;f--;break;case 1:m=0;g=Math.pow(2,16);for(j=1;j!=g;){d=a.val&a.position;a.position>>=1;if(a.position==0){a.position=32768;a.val=a.string.charCodeAt(a.index++)}m|=(d>0?1:0)*j;j<<=1}c[b++]=n(m);o=b-1;f--;break;case 2:return h}if(f==
0){f=Math.pow(2,k);k++}if(c[o])m=c[o];else if(o===b)m=l+l.charAt(0);else return null;h+=m;c[b++]=l+m.charAt(0);f--;l=m;if(f==0){f=Math.pow(2,k);k++}}}},CLIENT_VERSION=11,TIMEZONE_INFO=null,SHOW_COMPLETED=true,EVENTS={},TIMEOUTS={},CURRENTLY_ACTIVE_PAGE=null,DRAG_MOVE_MODE=false,TRACK_TAG_COUNTS=true,WINDOW_FOCUSED=true,WORD_CHARS="\\p{L}",WORD_CHARS_PLUS_DIGITS=WORD_CHARS+"\\p{Nd}",NAVIGABLE_PROJECTS_PATTERN=".project:visible:not(.parent, .mainTreeRoot)",DROP_TARGET_PATTERN=NAVIGABLE_PROJECTS_PATTERN+
", .childrenEnd:visible",URL_HASH_USERSTORAGE_KEY="urlhash",DO_NOT_INITIALIZE=false,READY_FOR_DOCUMENT_READY=false,DOCUMENT_READY_TRIGGERED=false,SHOULD_SHOW_LOGIN_REGISTER_SCREEN=false,UPDATE_INITIALIZATION_DATA_EVERY_N_DAYS=3,CHROME_APP_LOGGED_IN_KEY="logged_in",CONTENT_HtML_CONTAINER=null,SHORTCUT_KEYS=null,SHORTCUT_KEYS_WITH_META=null,FORMAT_FLAGS=null,FORMAT_FLAGS_SET_LOCATION=null;
if(IS_CHROME_APP){$.ajaxPrefilter(function(a){if(a.url.charAt(0)==="/"&&a.WF_doNotRewriteUrl!==true)a.url="https://workflowy.com"+a.url});$.ajax({url:"/ping"})}
if(IS_IOS&&FULL_OFFLINE_ENABLED)if(!localstoragedetect.localStorageSupported())if(localstoragedetect.permissionDeniedAccessingLocalStorage()){DO_NOT_INITIALIZE=true;setTimeout(function(){apphooks.exitWhenBackgrounded();setTimeout(function(){for(;;)alert('WorkFlowy cannot load properly if you are blocking cookies. To re-enable them, go to Settings -> Safari, and change the "Block Cookies" setting to something other than "Always". When you run the app again, it should work.')},0)},0)}
function fetchInitializationData(a){var c=function(){a(null)},f=typeof PROJECT_TREE_DATA_URL_PARAMS!=="undefined"?$.extend({},PROJECT_TREE_DATA_URL_PARAMS):{};f.client_version=!FULL_OFFLINE_ENABLED||IS_CHROME_APP?CLIENT_VERSION:"newest";f="/get_initialization_data?"+$.param(f);$.ajax({url:f,dataType:"json",success:function(b){if(b==null)c();else{b.fetchedWithClientVersion=CLIENT_VERSION;a(b)}},error:c})}
function doInitializationDataFetch(){fetchInitializationData(initializationDataFetchFinishedCallback)}
function getInitializationData(){IS_CHROME_APP?setTimeout(function(){indexeddbhelper.open(function(){indexeddbhelper.getStores().initializationData.readJSONWithTimestamp("initializationData",function(a,c){a===undefined?indexeddbhelper.getStores().otherData.read(CHROME_APP_LOGGED_IN_KEY,function(f){f===true?doInitializationDataFetch():showLoginRegisterScreen()}):initializationDataFetchFinishedCallback(a,c)})})},1):doInitializationDataFetch()}DO_NOT_INITIALIZE||getInitializationData();
function initializationDataFetchFinishedCallback(a,c){if(c===undefined)c=null;try{if(a===null)if(APPCACHE_ENABLED){window.location="/update_appcache";return}else if(IS_CHROME_APP){showLoginRegisterScreen();return}else throw Error("Initialization data load failed.");if(IS_CHROME_APP)if(c!==null){utils.debugMessage("Initialization data came from IndexedDB.");if(datetime.getCurrentTimeInMS()>c+UPDATE_INITIALIZATION_DATA_EVERY_N_DAYS*24*60*60*1E3){utils.debugMessage('Initialization data from IndexedDB is "stale"; fetching it again.');
(function(){fetchInitializationData(function(r){if(r!==null){utils.debugMessage("Initialization data re-fetch succeeded; writing it to IndexedDB.");writeInitializationDataToIndexedDB(r)}else utils.debugMessage("Initialization data re-fetch failed.")})})()}}else{utils.debugMessage("Initialization data came from server; writing it to IndexedDB.");writeInitializationDataToIndexedDB(a)}var f=a.globals,b=a.projectTreeData,k=a.settings,m="fetchedWithClientVersion"in a?a.fetchedWithClientVersion:0,h=0;for(;h<
f.length;h++){var l=f[h];window[l[0]]=l[1]}m<11&&convertProjectTreeDataFromPlainTextToContentText(b);PROJECT_TREE_DATA=b;CLIENT_ID=PROJECT_TREE_DATA.clientId;MAIN_PROJECT_TREE_INFO=PROJECT_TREE_DATA.mainProjectTreeInfo;AUXILIARY_PROJECT_TREE_INFOS=PROJECT_TREE_DATA.auxiliaryProjectTreeInfos;for(var d in k)if(d in SETTINGS)SETTINGS[d].value=k[d];var g=SETTINGS.theme.value,j=SETTINGS.font.value;localstoragehelper.init();var o=IS_CHROME_APP?SETTINGS.theme.value:g,n=IS_CHROME_APP?SETTINGS.font.value:
j;f=function(r,t){for(var v=0;v<r.length;v++)if(r[v].name===t)return true;return false};o=f(THEME_OPTIONS,o)?o:"default";n=f(FONT_OPTIONS,n)?n:"default";loadFontAndThemeCSS(o,n)}catch(q){handleExceptionDuringInitialization(q)}}function writeInitializationDataToIndexedDB(a){indexeddbhelper.getStores().initializationData.writeJSONWithTimestamp("initializationData",a)}
function convertProjectTreeDataFromPlainTextToContentText(a){function c(m){if("nm"in m)m.nm=content_text.xmlEscapeTextForContentText(m.nm);if("no"in m)m.no=content_text.xmlEscapeTextForContentText(m.no)}function f(m){c(m);if("ch"in m){m=m.ch;for(var h=0;h<m.length;h++)f(m[h])}}function b(m){m.rootProject!==null&&c(m.rootProject);for(var h=0;h<m.rootProjectChildren.length;h++)f(m.rootProjectChildren[h])}b(a.mainProjectTreeInfo);a=a.auxiliaryProjectTreeInfos;for(var k=0;k<a.length;k++)b(a[k])}
function showLoginRegisterScreen(){function a(b,k){if(k===undefined)k=false;forms.ajaxify(b,function(m){if(m==null){b.children(".errors").remove();b.prepend('<div class="errors">You must be online to initialize the application. Please login and try again.</div>')}else if("success"in m&&m.success){IS_CHROME_APP&&indexeddbhelper.getStores().otherData.write(CHROME_APP_LOGGED_IN_KEY,true);if(k)FIRST_LOAD_FLAGS.isNewUser=FIRST_LOAD_FLAGS.showNewUserTutorial=true;hideLoginRegisterScreen();doInitializationDataFetch()}else{m=
f.children(".form:visible");m.children(".errors").remove();m.prepend('<div class="errors">Oops, something went wrong on our end. Sorry! Please try again.</div>')}})}function c(b){f.find(".form").hide();$("."+b,f).show().find("input[type=text]:first").focus()}if(DOCUMENT_READY_TRIGGERED){SHOULD_SHOW_LOGIN_REGISTER_SCREEN=false;var f=$("#loginRegisterScreen");f.show();f.html($("#loginRegisterScreenTemplate").html());a($(".loginForm",f));a($(".registerForm",f),true);$(".showLoginScreen",f).live("click",
function(){c("loginScreen")});$(".showRegisterScreen",f).live("click",function(){c("registerScreen")});c("registerScreen")}else SHOULD_SHOW_LOGIN_REGISTER_SCREEN=true}function hideLoginRegisterScreen(){var a=$("#loginRegisterScreen");a.hide();a.html("")}function loadFontAndThemeCSS(a,c){function f(){b++;if(b===2){READY_FOR_DOCUMENT_READY=true;DOCUMENT_READY_TRIGGERED&&documentReadyFunc()}}var b=0;appearance.changeCSS({type:"theme",name:a},f);appearance.changeCSS({type:"font",name:c},f)}
function documentReadyFunc(){DOCUMENT_READY_TRIGGERED=true;SHOULD_SHOW_LOGIN_REGISTER_SCREEN&&showLoginRegisterScreen();if(READY_FOR_DOCUMENT_READY)try{utils.debugMessage("Debug mode ON");$("body").removeAttr("style");detectAndSetUpEnvironment();initializeGoogleAnalytics();TIMEZONE_INFO=jstz.determine_timezone().timezone;if(TIMEZONE_INFO===undefined){utils.debugMessage("Failed to detect timezone!");SEND_TIMEZONE_TO_SERVER=false}else utils.debugMessage("Time zone: "+TIMEZONE_INFO.olson_tz);FORMAT_FLAGS=
new content_text.FormatFlags;$.ajaxSetup({timeout:12E5});projecttree.initializeProjectTrees(MAIN_PROJECT_TREE_INFO,AUXILIARY_PROJECT_TREE_INFOS);CURRENTLY_ACTIVE_PAGE=createPage(true);payments.init();experiments.init();quota.init();location_history.init();addEvents();initializeShowCompleted();selectAndSearchUsingLocation(location_history.getLocationFromWindowHref());pushpoll.init();!IS_MOBILE&&FIRST_LOAD_FLAGS.showFriendRecommendation&&friend_recommendation.init();!IS_MOBILE&&FIRST_LOAD_FLAGS.showPrivateSharingNotice&&
ui_sugar.showAlertDialog("<strong>You are viewing a privately shared WorkFlowy.</strong><br><br>If you would like to add it to your personal account for easy access, click the button below. (Note that this button is always available in the lower right when viewing a shared list.)","Notice",false,[{text:"Add it to my account",click:function(){$(this).dialog("close");addSharedSubtreeToAccount()}}]);setInterval(function(){_gaq.push(["_trackEvent","Usage Statistic","30 minute ping"])},18E5)}catch(a){handleExceptionDuringInitialization(a)}finally{appdetect.isIOSApp()?
$("#loadingScreen").hide():$("#loadingScreen").fadeOut(150);apphooks.notifyDocumentReady()}}$(document).ready(documentReadyFunc);
function handleExceptionDuringInitialization(a){var c=String(a);utils.debugMessage("Error encountered during initialization: '"+c+"'");window._gaq!==undefined&&_gaq.push(["_trackEvent","Javascript Errors (on init)",c,SETTINGS.username.value]);if(a instanceof userstorage.InitializationError)setTimeout(function(){userstorage.isEnabled()&&userstorage.clear();reloadPageFromServer()},250);else{$("#pageContainer").hide();if(IS_CHROME_APP)throw a;else if(confirm('WorkFlowy encountered an error initializing.\n\nClick "OK" below to reload the page. If this error happens repeatedly, please email help@workflowy.com with the error message shown below (which you can copy-paste), as well as the name of the browser you are using.\n\nERROR: "'+
c+'"\n\n(This error is usually caused by browser extensions, so we recommend checking if disabling any that you have installed solves the problem.)'))setTimeout(reloadPageFromServer,250);else throw a;}}
function initializeGoogleAnalytics(){window._gaq=window._gaq||[];_gaq.push(["_setAccount","UA-11472180-1"]);_gaq.push(["_setCustomVar",1,"Cohort",COHORT,1]);FIRST_LOAD_FLAGS.isNewUser?_gaq.push(["_setCustomVar",2,"New user","Yes",2]):_gaq.push(["_setCustomVar",2,"Existing user","Yes",2]);_gaq.push(["_setCustomVar",3,"Experiments",experiments.getExperimentsStringForGoogleAnalytics(),2]);_gaq.push(["_setCustomVar",4,"Client version",CLIENT_VERSION,2]);_gaq.push(["_trackPageview"])}
function detectAndSetUpEnvironment(){if(DEMO_MODE)$.ajax=$.get=$.post=function(){};var a=false,c=false,f=window.navigator.userAgent;if(f.match(/windows/i)!==null){$("body").addClass("windows");a=true}if(f.match(/linux/i)!==null){$("body").addClass("linux");c=true}APPCACHE_ENABLED=APPCACHE_ENABLED&&"applicationCache"in window&&window.applicationCache!==null;if(IS_MOBILE)TRACK_TAG_COUNTS=false;if(IS_IE)CONTENT_HTML_CONTAINER=$("#contentHtmlContainer");SHORTCUT_KEYS=a||c?["alt"]:["ctrl"];SHORTCUT_KEYS_WITH_META=
SHORTCUT_KEYS.concat(["meta"])}function selectOnActivePage(a){a=a.split(",");for(var c=0;c<a.length;c++)a[c]=".page.active "+a[c];return $(a.join(", "))}function getActivePage(){return CURRENTLY_ACTIVE_PAGE}
function createPage(a){if(a===undefined)a=false;var c=projecttree.getMainProjectTree().isShared()?projecttree.getMainProjectTree().getName():"Home";c='<div class="page"><div class="top left corner"></div><div class="top edge"></div><div class="top right corner"></div><div class="right edge"></div><div class="bottom right corner"></div><div class="bottom edge"></div><div class="bottom left corner"></div><div class="left edge"></div><div class="pageStar"></div><div class="mainTreeRoot project open" projectid="None"><div class="name"><div class="content">'+content_text.getHtml(c)+
'</div><span class="parentArrow"></span></div><div class="children"></div><div class="addButton" title="Add new item">+</div></div><div class="footer"><h3 class="siteSlogan">Make Lists. Not War.</h3></div><div class="bottomPadding"></div></div>';c=$(c);$("#pageContainer").append(c);IS_MOBILE||c.setPageMargins();a&&c.addClass("active");return c}
function initializeShowCompleted(){var a=SHOW_COMPLETED_DEFAULT;if(localstoragehelper.localStorageSupported()){var c=projecttree.mainLocalStorageKey("completedMode");c=localstoragehelper.read(c);if(c==="show")a=true;else if(c==="hide")a=false}setShowCompleted(a)}
jQuery.fn.overwriteProjectChildrenHtml=function(a){var c=$(this);projecttree.getProjectReferenceFromDomProject(c).registerSubtreeRemovedFromDom(true);a=a();c.clearControlsUnderProject(true);c=c.children(".children");dom_utils.clearChildrenOfElement(c[0]);c.html(a)};
function selectAndSearchUsingLocation(a){var c=getCurrentlyFocusedContent();c!==null&&c.blur();c=projecttree.getAllProjectTreesHelper().findProjectByProjectId(a.getZoomedProjectId());if(c===null||!c.isValid())c=projecttree.getMainProjectTree().getRootProjectReference();a=a.getSearchQuery();selectProjectReferenceInstantly(c);if(a!==null)search.setSearchBoxAndSearch(a);else{search.inSearchMode()&&search.cancelSearch();IS_MOBILE||focusFirstChildOfSelected();$(window).scrollTop(0)}}
jQuery.fn.getChildren=function(){return $(this).children(".children").children(".project")};jQuery.fn.getVisibleChildren=function(){return $(this).getChildren().filter(":visible")};function getCurrentlyFocusedContent(){var a=$(document.activeElement);return a.length===1&&a.is(".content")?a:null}function getCurrentlyFocusedContentOrInput(){var a=$(document.activeElement);return a.length===1&&a.is(".content, input")?a:null}
jQuery.fn.selectIt=function(a,c){if(a===undefined)a="first_child";c=animations.getAnimationSpeed(c);var f=$(this),b=projecttree.getProjectReferenceFromDomProject(f);hideControls();if(!f.is(".selected")){var k=selectOnActivePage(".selected"),m=getCurrentlyFocusedContent(),h=null,l=null;if(m!==null){h=projecttree.getProjectReferenceFromDomProject(m.getProject());l=m.getCaret().start}getCurrentlyFocusedContentOrInput()!==null&&blurFocusedContentOrInput();var d=null;if(a==="first_child"){m=b.getPotentiallyVisibleChildren();
if(m.length>0)d=m[0];else b.isMainTreeRoot()||(d=b)}else if(a==="last_selected")d=projecttree.getProjectReferenceFromDomProject(k);var g=function(){location_history.setLocationModificationInProgress(true);search.inSearchMode()&&search.exitSearchMode();setTimeout(function(){b.setTitleAndFragmentPathForProject();location_history.setLocationModificationInProgress(false)},1);b.constructProjectTreeAsSelected();savedviews.notifyViewChanged()};m=function(){var x=f.getName();x.removeAttr("style");x.children(".content").removeAttr("style");
k.getName().children(".content").removeAttr("style");selectOnActivePage(".addButton").removeAttr("style");$(".nameAnimated").remove();g();var e=selectOnActivePage(".selected");e.addClass("highlighted");setTimeout(function(){e.removeClass("highlighted")},100);if(IS_MOBILE)$(window).scrollTop(0);else if(d!==null){x=h!==null?h.getMatchingDomProject():null;var p=d.getMatchingDomProject();c==="animate"&&animations.getAnimationCounter().setContentToFocus(p.getName().children(".content"));if(x!==null&&p.filter(x).length>
0)c==="animate"?animations.getAnimationCounter().setCaretPos(l):p.children(".name").children(".content").setCaret(l);else c!=="animate"&&p.children(".name").moveCursorToBeginning();a!=="last_selected"&&$(window).scrollTop(0)}};if(c==="animate"){animations.getAnimationCounter().addCallback(m);m=[{project:f},{project:k}];var j=selectOnActivePage(".mainTreeRoot"),o=j.getChildren(),n=j.attr("class");o.detach();b.constructProjectTreeAsSelected(false);for(var q=function(x){var e=null,p=null;x=x.getMatchingDomProject();
if(x.length===1){p=x.getName().children(".content");if(p.is(":visible"))e=p.offset();p={fontSize:p.css("fontSize"),lineHeight:p.css("lineHeight")}}return{offset:e,style:p}},r=0;r<m.length;r++){var t=m[r],v=projecttree.getProjectReferenceFromDomProject(t.project);v=q(v);t.newOffset=v.offset;t.newStyle=v.style}r=j.children(".children");r.html("");r.append(o);j.attr("class",n);for(r=0;r<m.length;r++){t=m[r];n=t.project.getName().children(".content");n.css("visibility","hidden");j=$('<div class="nameAnimated">'+
n.html()+"</div>");getActivePage().append(j);j.css({position:"absolute",zIndex:100,whiteSpace:n.css("whiteSpace"),fontSize:n.css("fontSize"),lineHeight:n.css("lineHeight")});if(t.newOffset===null){j.offset(n.offset());t={fontSize:"0px"}}else{j.offset(t.newOffset);o=j.position();n.is(":visible")?j.offset(n.offset()):j.css({fontSize:"0px",lineHeight:"0px"});t=t.newStyle;t.top=o.top;t.left=o.left}j.incrementAnimationCounter().animate(t,animations.getAnimationTiming("zoom"),function(){animations.getAnimationCounter().decrement()})}m=
k.getVisibleChildren();m.slice(0,10).incrementAnimationCounter().slideUp(animations.getAnimationTiming("zoom"),function(){animations.getAnimationCounter().decrement()});m.length>10&&m.slice(10).hide();selectOnActivePage(".addButton").hide();k.hasClass("noted")&&k.children(".notes").incrementAnimationCounter().animate({opacity:"hide"},animations.getAnimationTiming("zoom"),function(){animations.getAnimationCounter().decrement()});m=f.find(".parent");if(f.is(".parent"))m=m.add(f);m.children(".name").incrementAnimationCounter().animate({fontSize:"0px"},
animations.getAnimationTiming("zoom"),function(){animations.getAnimationCounter().decrement()});f.addClass("highlighted")}else m()}};
function selectProjectReferenceInstantly(a,c){if(c===undefined)c=false;if(!c){var f=selectOnActivePage(".selected");if(f.length===1&&projecttree.getProjectReferenceFromDomProject(f).equals(a)){var b=a.getAncestors();f=f.getAncestors();if(b.length==f.length){for(var k=true,m=0;m<b.length;m++){var h=b[m],l=f.eq(m);if(!h.equals(projecttree.getProjectReferenceFromDomProject(l))){k=false;break}}if(k)return}}}utils.debugMessage("Rebuilding DOM project tree in selectProjectReferenceInstantly because selected/ancestors changed.");
a.constructProjectTreeAsSelected();a.setTitleAndFragmentPathForProject();savedviews.notifyViewChanged()}function reconstructDomProjectTree(){projecttree.getProjectReferenceFromDomProject(selectOnActivePage(".selected")).constructProjectTreeAsSelected()}jQuery.fn.setExpanded=function(a){var c=$(this);projecttree.getProjectReferenceFromDomProject(c).setExpanded(a);return this};
jQuery.fn.refreshExpanded=function(){this.each(function(){var a=$(this);a.is(".mainTreeRoot")||a.is(".open")||projecttree.getProjectReferenceFromDomProject(a).isExpanded()&&$(this).showChildren("instant")});return this};
jQuery.fn.showChildren=function(a){a=animations.getAnimationSpeed(a);this.each(function(){var c=$(this),f=projecttree.getProjectReferenceFromDomProject(c);c.addClass("open");if(!c.is(".parent, .selected")){f.setIsExpandedInDom(true);c.overwriteProjectChildrenHtml(function(){var k=f.constructChildProjectTreeHtmls();return globalprojecttreeobject.constructChildren(k)});if(a!="instant"){var b=c.getVisibleChildren();animations.getAnimationCounter().addCallback(function(){b.removeAttr("style")});b.hide();
b.slice(0,30).incrementAnimationCounter().slideDown(animations.getAnimationTiming("children"),function(){animations.getAnimationCounter().decrement()})}}});return this};
jQuery.fn.hideChildren=function(a){a=animations.getAnimationSpeed(a);this.each(function(){var c=$(this),f=projecttree.getProjectReferenceFromDomProject(c);if(c.is(".parent, .selected"))c.removeClass("open");else{var b=function(){c.removeClass("open");f.setIsExpandedInDom(false);c.overwriteProjectChildrenHtml(function(){return globalprojecttreeobject.constructChildren([])})};a=="instant"?b():c.children(".children").incrementAnimationCounter().slideUp(animations.getAnimationTiming("children"),function(){$(this).removeAttr("style");
b();animations.getAnimationCounter().decrement()})}});return this};jQuery.fn.getProject=function(){return $(this).closest(".project")};jQuery.fn.getParent=function(){return $(this).parent(".children").parent(".project")};jQuery.fn.getAncestors=function(){for(var a=this,c=[];!a.is(".mainTreeRoot");){a=a.getParent();c=c.concat(a.get())}return $(c)};jQuery.fn.getPriority=function(){var a=$(this);if(a.is(".childrenEnd")){a=a.getParent();return projecttree.getProjectReferenceFromDomProject(a).getChildren().length}else return projecttree.getProjectReferenceFromDomProject(a).getPriority()};
function getCompletedProjectsToAnimate(){var a=selectOnActivePage(".selected > .children > .project.done, .selected > .children > .project.completedDescendantMatches:not(.matches,.uncompletedDescendantMatches), .selected .project.open:visible > .children > .project.done, .selected .project.open:visible > .children > .project.completedDescendantMatches:not(.matches,.uncompletedDescendantMatches)");a=a.filter(":visible");return a=a.slice(0,10)}
function showCompleted(a){a=animations.getAnimationSpeed(a);setShowCompleted(true);var c=operations.saveClientViewState();blurFocusedContent();reconstructDomProjectTree();if(a!=="instant"){animations.getAnimationCounter().addCallback(function(){operations.restoreClientViewState(c)});a=getCompletedProjectsToAnimate();a.hide();a.incrementAnimationCounter().slideDown(animations.getAnimationTiming("children"),function(){$(this).removeAttr("style");animations.getAnimationCounter().decrement()})}else IS_MOBILE||
operations.restoreClientViewState(c)}
function hideCompleted(a){function c(m){if(m===undefined)m=false;var h=null;if(k!==null){var l=k.getProject();if(!l.is(":visible")){var d=l.getPreviousProject();if(d.filter(l).length===0)h=projecttree.getProjectReferenceFromDomProject(d)}}reconstructDomProjectTree();if(h!==null){d=h.getMatchingDomProject();if(d.length===1&&d.is(":visible"))m?animations.getAnimationCounter().setContentToFocus(d.getName().children(".content")):d.getName().children(".content").setCaret(0)}else operations.restoreClientViewState(b)}a=
animations.getAnimationSpeed(a);var f=getCompletedProjectsToAnimate();setShowCompleted(false);var b=operations.saveClientViewState(),k=getCurrentlyFocusedContent();if(a!=="instant"&&f.length>0){animations.getAnimationCounter().addCallback(function(){c(true)});f.show();f.incrementAnimationCounter().slideUp(animations.getAnimationTiming("children"),function(){$(this).removeAttr("style");animations.getAnimationCounter().decrement()})}else c()}
function setShowCompleted(a){SHOW_COMPLETED=a;if(localstoragehelper.localStorageSupported()){var c=projecttree.mainLocalStorageKey("completedMode");localstoragehelper.write(c,a?"show":"hide")}if(a){getActivePage().addClass("showCompleted");$(".showCompletedButton > .show").hide();$(".showCompletedButton > .hide").show()}else{getActivePage().removeClass("showCompleted");$(".showCompletedButton > .show").show();$(".showCompletedButton > .hide").hide()}}
function shouldShowCompletedProjects(){return SHOW_COMPLETED}function toggleCompletedVisibility(){shouldShowCompletedProjects()?hideCompleted():showCompleted();settings.saveShowCompleted(shouldShowCompletedProjects())}jQuery.fn.getLastSavedContentText=function(){var a=$(this),c=projecttree.getProjectReferenceFromDomProject(a.getProject());return a.isName()?c.getName():c.getNote()};
jQuery.fn.contentChanged=function(){var a=$(this),c=a.getLastSavedContentText();return content_text.getTextForContent(a)!==c};jQuery.fn.saveContent=function(a){if(a===undefined)a=false;var c=$(this),f=projecttree.getProjectReferenceFromDomProject(c.getProject());if(f.isValid())if(!f.isReadOnly())if(c.contentChanged()){var b=c.isName(),k=c.getContentText();c=b?k:null;b=!b?k:null;a||undoredo.startOperationBatch(true);f.applyLocalEdit(c,b);a||undoredo.finishOperationBatch()}};
jQuery.fn.focusProject=function(){var a=$(this),c=a.getName().children(".content"),f=a.getNotes().children(".content"),b=document.activeElement;b===c[0]||b===f[0]||a.getName().moveCursorToBeginning()};jQuery.fn.setContentHtml=function(a){$(this).html(a)};jQuery.fn.setContentHtmlAsUserEdit=function(a){var c=$(this);c.setContentHtml(a);setSaveTimer(c)};jQuery.fn.getContentText=function(){var a=$(this);return content_text.getTextForContent(a)};
jQuery.fn.setContentText=function(a,c){var f=$(this);if(c===undefined)c=f.isNote();f.setContentHtml(content_text.getContentHtml(a,c))};jQuery.fn.setContentTextAsUserEdit=function(a,c){var f=$(this);if(c===undefined)c=f.isNote();f.setContentText(a,c);setSaveTimer(f)};jQuery.fn.setAndSaveContentText=function(a){var c=$(this);c.setContentText(a);c.saveContent(true)};
jQuery.fn.updateContentHtmlAfterUserEdit=function(){var a=$(this),c=a.isNote(),f=a.html();c=(new content_text.ContentText(a,c)).getContentHtml();var b=f===c;if(IS_IE&&!b){CONTENT_HTML_CONTAINER.html(c);b=CONTENT_HTML_CONTAINER.html();CONTENT_HTML_CONTAINER.html("");b=f===b}if(!b){if(f=document.activeElement===a[0])var k=a.getCaret();a.setContentHtml(c);f&&a.setCaret(k.start,k.end)}tagging.getTagAutocompleter().updateDisplay(a)};
function addEvents(){function a(){if(appdetect.isIOSApp())if(userstorage.isEnabled()){var f=window.location.hash.substring(1);userstorage.write(URL_HASH_USERSTORAGE_KEY,f)}}$(".dialogCloseButton").live("click",function(){$(this).closest(".ui-dialog-content").dialog("close")});$("#site_message .closeButton").click(function(){closeSiteMessage()});if(!IS_CHROME_APP)window.onbeforeunload=function(){if(projecttree.getAllProjectTreesHelper().haveUnsavedData())return"You have unsaved changes. Do you want to leave this page and discard your changes?"};
window.onerror=function(f,b,k){_gaq.push(["_trackEvent","Javascript Errors",f,SETTINGS.username.value+": "+b+":"+k])};IS_MOBILE||$(window).bind("resize",function(){getActivePage().setPageMargins();library.reposition()});if(!IS_CHROME_APP){$.address.externalChange(function(){location_history.notifyExternalFragmentChange();selectAndSearchUsingLocation(location_history.getLocationFromWindowHref());a()});$.address.internalChange(function(){setTimeout(function(){a()},1)})}$(window).focus(function(){WINDOW_FOCUSED=
true;$(".content.focusedButWindowBlurred").removeClass("focusedButWindowBlurred");localstoragehelper.localStorageSupported()&&localstoragehelper.notifyWindowFocus();pushpoll.pushPollAlreadyScheduled()||pushpoll.scheduleNextPushAndPoll(false,true,true);pushpoll.updateLastSyncedStrings()});$(window).blur(function(){WINDOW_FOCUSED=false;savedviews.updateModifierKeyStatus(false,false)});$(".saveButton.saveNow").clickOrTapHandler({event:function(){pushpoll.scheduleNextPushAndPoll(true)},mousedown:function(){return false}});
if(IS_MOBILE){$("#controlsLeft a.complete").tapHandler(null,function(){var f=$("#controls").getProject();f.completeIt();blurFocusedContentOrInput();f.tapIt();return false});$("#controlsLeft a.note").tapHandler(function(){return false},function(){if(getCurrentlyFocusedContent()!==null){var f=$("#controls").getProject(),b=f.getNotes();document.activeElement===b.children(".content")[0]?f.editName():f.editNote();return false}});$("#controlsLeft #moveMobile span").live("touchstart",function(){var f=$(this);
if(f.hasClass("disabled"))return false;f.css("background","#ccc");setTimeout(function(){f.removeAttr("style")},100);return false}).live("touchend",function(){var f=$(this),b=$("#controls").getProject();projecttree.getProjectReferenceFromDomProject(b);if(f.hasClass("disabled"))return false;if(f.hasClass("indent"))b.indentProject();else $(this).hasClass("outdent")&&b.outdentProject();return false})}if(!IS_MOBILE){$("#controlsLeft > .note").click(function(){$(this).getProject().editNote();hideControls()});
$("#controlsLeft > .complete").click(function(){$(this).getProject().completeIt()});$("#controlsLeft > .share").click(function(){$(this).getProject().showSharePopup();hideControls()});$("#controlsLeft .export").click(function(){$(this).getProject().exportIt();hideControls()});$("#controlsLeft .duplicate").click(function(){$(this).getProject().duplicateIt();hideControls()});$("#controlsLeft .delete").click(function(){$(this).getProject().deleteIt()});$("#controlsLeft a").click(function(){TIMEOUTS.highlight=
setTimeout(function(){selectOnActivePage(".highlighted").removeClass("highlighted")},300)})}if(!IS_MOBILE){jQuery.fn.initiateHideHoverControls=function(){var f=$(this).getProject(),b=f.children(".name").find("#controlsLeft");f.removeClass("highlighted");clearTimeout(TIMEOUTS.showControls);TIMEOUTS.hideHoverControls=setTimeout(function(){b.removeClass("hovered")},1)};jQuery.fn.initiateShowHoverControls=function(){var f=$(this).getProject();selectOnActivePage(".highlighted").removeClass("highlighted");
f.is(".selected")||f.addClass("highlighted");clearTimeout(TIMEOUTS.hideHoverControls);TIMEOUTS.showControls=setTimeout(function(){f.showControls()},500)};$(".page.active .bullet").live("mouseenter",function(){$(this).initiateShowHoverControls()}).live("mouseleave",function(){$(this).initiateHideHoverControls()});$("#controlsLeft").mouseenter(function(){var f=$(this).getProject();selectOnActivePage(".highlighted").removeClass("highlighted");f.addClass("highlighted");clearTimeout(TIMEOUTS.hideHoverControls)}).mouseleave(function(){$(this).initiateHideHoverControls()});
$(".page.active .selected .name").live("mouseenter",function(){$(this).placeControls()}).live("mouseleave",function(){if(!DRAG_MOVE_MODE)TIMEOUTS.hideControls=setTimeout(function(){hideControls()},50)});$(".page.active .selected:not(.mainTreeRoot) > .name").live("mouseenter",function(){$(this).initiateShowHoverControls()}).live("mouseleave",function(){$(this).initiateHideHoverControls()})}jQuery.fn.placeControls=function(){var f=$(this);clearTimeout(TIMEOUTS.hideControls);if(!DRAG_MOVE_MODE){var b=
f.children("#controls");if(b.length===0){b=$("#controls");b.children("#controlsLeft").removeClass("hovered");var k=projecttree.getProjectReferenceFromDomProject(f.getProject());b.removeClass("readOnly inReadOnlyTree");k.isReadOnly()&&b.addClass("readOnly");k.isInReadOnlyTree()&&b.addClass("inReadOnlyTree");f.append(b);clearTimeout(TIMEOUTS.hideHoverControls)}IS_MOBILE||$("#move",f).draggable("destroy").makeDraggable()}};jQuery.fn.showControls=function(){var f=$(this),b=projecttree.getProjectReferenceFromDomProject(f);
b=b.isReadOnly()&&!b.isAddedSubtreePlaceholder();if(IS_MOBILE){var k=f.children(".name");k.placeControls();h=k.children("#controls");k=h.find(".outdent");var m=h.find(".indent");k.add(m).removeClass("disabled");f.getNewNextProjectOrChildrenEndForOutdent()===null&&k.addClass("disabled");f.getNewNextProjectOrChildrenEndForIndent()===null&&m.addClass("disabled");h.offset({top:$("body").scrollTop(),left:0}).width($(window).width());f=$("#controlsLeft");f.addClass("hovered");b&&f.removeClass("hovered")}else if(!b){var h=
f.children(".name").find("#controlsLeft");h.fadeIn(50,function(){$(this).removeAttr("style")});h.addClass("hovered")}};if(IS_MOBILE){$("body").bind("touchstart",function(){$(this).data("touchmove",false);if(DRAG_MOVE_MODE)return false}).bind("touchmove",function(){$(this).data("touchmove",true)}).bind("touchend",function(f){if($(this).data("touchmove")===true){$(this).data("touchmove",false);return false}if(DRAG_MOVE_MODE)return false;f=$(f.target);if(!IS_ANDROID&&getCurrentlyFocusedContentOrInput()!==
null&&f.closest("#controls, .content, input, button, .addButton, .parentArrow, .bullet, #searchCancel").length===0){blurFocusedContentOrInput();return false}});$(window).scroll(function(){clearTimeout(TIMEOUTS.scroll);TIMEOUTS.scroll=setTimeout(function(){IS_IOS&&$(".tapped").removeClass("tapped");var f=getCurrentlyFocusedContent();if(f!==null)f.isOnScreen()?f.getProject().showControls():blurFocusedContentOrInput()},10)});$(".page.active .selected .content").tapHandler(moving.setupMobileDragging,
function(f){var b=$(this),k=b.getProject();if(!(READ_ONLY_MAIN_TREE||k.is(".mainTreeRoot")))if(!$(f.target).is(".contentTag, .contentLink")){k=getCurrentlyFocusedContentOrInput();if(k!==null)if(k[0]===b[0])return;else{blurFocusedContentOrInput();return false}if(IS_IOS){f=f.originalEvent.changedTouches[0];f=b.findCaretPositionForTouch(f.pageX,f.pageY);b.setCaret(f);return false}}},false)}if(IS_MOBILE){$(".page.active .parent > .name").addMobileZoomControlEvents();$(".page.active .selected .project .parentArrow").tapHandler(null,
function(){var f=$(this).getProject();blurFocusedContentOrInput();f.clickExpandButton();return false},true,"delay")}$(".page.active .selected .content .contentTag").clickOrTapHandler({untapBehavior:"never",mousedown:function(){return false},event:function(){function f(){var m=$('<div class="contentTagAnimated">'+k+"</div>");$("body").append(m);m.css({fontSize:b.css("fontSize"),lineHeight:b.css("lineHeight")});m.offset($("#searchBox").offset());var h=m.position();m.offset(b.offset());m.animate({top:h.top,
left:h.left,opacity:"0.5"},animations.getAnimationTiming("zoom"),function(){$(this).remove();search.toggleTagInCurrentSearch(k)})}var b=$(this),k=b.text();blurFocusedContentOrInput();if(search.tagIsInCurrentSearch(k)){search.toggleTagInCurrentSearch(k);return false}IS_IOS?setTimeout(function(){f()},1):f();return false}});$(".page.active .selected .content .contentLink").clickOrTapHandler({mousedown:function(){return false},event:function(f){var b=$(this).attr("href");blurFocusedContentOrInput();if(!f.ctrlKey&&
!f.metaKey){var k=function(h){var l=h.indexOf("#");if(l===-1)l=h.length;return[h.substring(0,l),h.substring(l)]},m=k(b);f=m[0];m=m[1];if(IS_CHROME_APP){if(f==="https://workflowy.com/"){b=location_history.getLocationFromFragment(m);location_history.notifyLocationChange(b);selectAndSearchUsingLocation(b);return false}}else{k=k(window.location.href)[0];if(f===k){window.location.href=b;return false}}}if(!appdetect.isIOSApp()||appdetect.getIOSAppVersion()>=6)window.open(b);return false}});$(".showCompletedButton").clickOrTapHandler({event:function(){toggleCompletedVisibility()},
mousedown:function(){return false}});$("#logo").clickOrTapHandler({event:function(){if(!animations.animationsAreInProgress()){var f=selectOnActivePage(".mainTreeRoot");if(f.is(".selected"))search.cancelSearch();else{$(this).transition({rotateY:"360deg"},250,function(){$(this).removeAttr("style")});f.selectIt()}}}}).dblclick(function(){var f=selectOnActivePage(".mainTreeRoot");if(f.is(".selected")){f.expandOrCollapseAllDescendantsOfProjectToggle();dom_utils.clearSelection()}});if(!IS_MOBILE){$(".page.active .project.parent > .name > .content").live("click",
function(){$(this).getProject().selectIt();return false});$(".page.active .selected > .name > .content").live("dblclick",function(){$(this).getProject().expandOrCollapseAllDescendantsOfProjectToggle();$(document.activeElement).setCaret(0);return false})}if(IS_MOBILE)$(".page.active .bullet").addMobileZoomControlEvents(true);else{$("#expandButton").live("click",function(){$(this).clickExpandButton(true);return false});$(".page.active .bullet").live("mouseenter",function(){var f=$(this),b=projecttree.getProjectReferenceFromDomProject(f.getProject()),
k=b.getLastModifiedDateString();b=b.getCompletedDateString();var m="";if(b!==null)m+="Completed: "+b;if(b===null||b!==k){if(m.length>0)m+=", \n";m+="Last changed: "+k}f.attr("title",m)}).live("click",function(f){if(!(f.ctrlKey||f.metaKey)){$(this).getProject().selectIt();return false}})}$("a.undelete").live("click",function(){$(this).undeleteIt();return false});$("#message > .close").click(function(){hideMessage()});IS_MOBILE||$("#controlsRight").hover(function(){$(this).getProject().addClass("highlighted moveHovered")},
function(){$(this).getProject().removeClass("highlighted moveHovered")}).mousedown(function(){blurFocusedContentOrInput()});$("a.refresh").live("click",function(){reloadPageFromServer();return false});IS_MOBILE||$(".page.active .mainTreeRoot").live("click",function(f){if($(f.target).hasClass("mainTreeRoot")){f=selectOnActivePage(".selected .project:visible:last");if(f.length===1)f.getName().moveCursorToEnd();else search.inSearchMode()||selectOnActivePage(".selected").appendChildProject();return false}});
IS_MOBILE?$(".page.active .addButton").tapHandler(null,function(){selectOnActivePage(".selected").appendChildProject();return false}):$(".page.active .addButton").live("click",function(){selectOnActivePage(".selected").appendChildProject();return false});addContentInteractionEventHandlers($(".page.active .selected .content"));addGlobalKeyboardShortcuts();$("#loginPopup").dialog({autoOpen:false,width:450,buttons:{Login:function(){$("#loginPopup form").submit()}},modal:true,position:["center",180],
title:"Login required for "+html_utils.htmlEscapeText(SETTINGS.username.value),dialogClass:"noClose",closeOnEscape:false});$("#exportPopup").dialog({autoOpen:false,width:550,buttons:{Close:function(){$(this).dialog("close")}},modal:false,position:["center",150],title:"Export List",close:function(){clearExportPopup()}});jQuery.fn.setShareButtons=function(f){if(f==="unshared")$(this).dialog("option",{buttons:{"Option 1: Let people view":function(){shareProject($(this).data("projectReference"),false)},
"Option 2: Let people edit":function(){shareProject($(this).data("projectReference"),true)},Cancel:function(){$(this).dialog("close")}}});else if(f==="shared")$(this).dialog("option",{buttons:{"Turn off sharing for this list":function(){unshareProject($(this).data("projectReference"))},Close:function(){$(this).dialog("close")}}});else f==="placeholder"&&$(this).dialog("option",{buttons:{Close:function(){$(this).dialog("close")}}})};$("#sharePopup").dialog({autoOpen:false,width:750,modal:true,position:["center",
200],title:"Share list"});$(".ui-dialog-titlebar-close").live("mousedown",function(){return false});$("#settingsButton").clickOrTapHandler({useBind:true,event:function(){dialog=$("#settingsPopup");dialog.dialog("isOpen")?dialog.dialog("close"):dialog.dialog("open");settings.hideMenu();return false}});var c=$("#reloadAppCacheButton");c.length===1&&c.clickOrTapHandler({event:function(){forceReloadAppCache();return false}});$(".logout.button").clickOrTapHandler({event:function(){projecttree.getAllProjectTreesHelper().haveUnsavedData()?
ui_sugar.showAlertDialog("<strong>You have unsaved changes.</strong> If you sign out now before saving them, they will be lost.","Warning",true,[{text:"Sign out now",click:function(){if(!IS_CHROME_APP)window.onbeforeunload=null;logoutUser()}}],"Cancel"):logoutUser();return false}});$("#loginPopupContents .loginForm").submit(function(){var f=$(this),b=$("#loginPopup");if(f.hasClass("submitting"))return false;f.addClass("submitting");b.setDialogButtonsDisable(true);var k={};f.find(":input").each(function(){k[$(this).attr("name")]=
$(this).val()});var m=function(){f.removeClass("submitting");b.setDialogButtonsDisable(false);f.find(".loginFormErrorMessage").text("Server did not respond. Please try again.").show();f.find(".loginFormPasswordInput").focus()};$.ajax({url:"/ajax_login",data:k,dataType:"json",type:"POST",success:function(h){if(h==null)m();else if("success"in h&&h.success){hideLoginPopup();pushpoll.notifyAjaxLoginComplete()}else{f.removeClass("submitting");b.setDialogButtonsDisable(false);f.find(".loginFormErrorMessage").text("Incorrect password.").show();
h=f.find(".loginFormPasswordInput");h.val("");h.focus()}},error:m});return false});$("#exportAllButton").click(function(){$(".page.active .mainTreeRoot").exportIt(true);return false});$("#printButton").click(function(){setTimeout(function(){window.print()},1)});$("#addSharedSubtreeToMyAccountButton").click(function(){addSharedSubtreeToAccount()});$("#addSharedSubtreeToMyAccountPopup").dialog({autoOpen:false,width:500,modal:true,position:["center",200],title:"Add shared list"});APPCACHE_ENABLED&&appcachehelper.init();
search.init();keyboard_shortcut_helper.init();sharing.init();settings.init();undoredo.init();referral.init();exporting.init();library.init();savedviews.init();video.init();upgrade_warning.init()}
function logoutUser(){if(IS_CHROME_APP)$.ajax({url:"/ajax_logout",dataType:"json",type:"POST",success:function(){userstorage.isEnabled()&&userstorage.clear();indexeddbhelper.getStores().otherData.remove(CHROME_APP_LOGGED_IN_KEY,function(){reloadChromeApp()})}});else{userstorage.isEnabled()&&userstorage.clear();apphooks.notifyThatAppCacheIsNowUncached();window.location="/offline_logout"}}
jQuery.fn.findCaretPositionForTouch=function(a,c){function f(s){s=Math.floor((s-l.top)/d);if(s<0)s=0;else if(s>g-1)s=g-1;return s}function b(s){k.setContentHtml(t.getContentHtml(s));var w=k.find(".contentCaret").offset(),u=f(w.top-d/2);if(u<o)return true;else if(u>o)return false;else{w=j.left-w.left;u=Math.abs(w);if(q<0||u<n){q=s;n=u}return w>0}}var k=$(this),m=k.isNote(),h=false;if(m&&!k.getProject().hasClass("selected")&&document.activeElement!==k[0]){k.addClass("showAsEditing");h=true}var l=k.offset(),
d=parseInt(k.css("lineHeight")),g=k.height()/d,j={left:a,top:c},o=h?0:f(j.top),n=-1,q=-1,r=k.html(),t=new content_text.ContentText(k,m);m=t.getPlainText();for(var v=0,x=m.length,e=0;v<=x;){var p=e===0?m.length:Math.floor((v+x)/2);if(b(p))v=p+1;else x=p-1;e++}k.setContentHtml(r);h&&k.removeClass("showAsEditing");return q};jQuery.fn.scrollToViewProjectForMobile=function(){var a=$(this),c=$("#controlsLeft").outerHeight();$("body").animate({scrollTop:a.offset().top-c*2},200)};
jQuery.fn.setPageMargins=function(){var a=$(this),c=Math.floor(($(window).width()-a.outerWidth())/2);if(c<0)c=0;a.css({marginLeft:c})};jQuery.fn.addMobileZoomControlEvents=function(a){if(a===undefined)a=false;$(this).tapHandler(function(){var c=$(this);a&&c.getProject().tapIt()},function(){$(this).getProject().selectIt();return false},true)};
jQuery.fn.clickExpandButton=function(a){if(a===undefined)a=false;var c=$(this),f=c.getProject();if(!f.is(".task")){var b=f.is(".open"),k=null;if(a){var m=datetime.getCurrentTimeInMS();a=c.data("lastClick");var h=c.data("openOnLastClick"),l=c.data("lastClickFinished");c.data("lastClick",m);c.data("openOnLastClick",b);c.removeData("lastClickFinished");setTimeout(function(){c.data("lastClick")===m&&c.data("lastClickFinished",datetime.getCurrentTimeInMS())},1);if(a!==undefined&&(l!==undefined&&m-l<250||
m-a<250))k=h?"collapse":"expand"}a=f.getName();if(k!==null){a.moveCursorToBeginning();k==="expand"?f.expandOrCollapseAllDescendantsOfProject(true):f.expandOrCollapseAllDescendantsOfProject(false)}else{k=a.children(".content");animations.getAnimationCounter().setContentToFocus(k);b?f.hideChildren().setExpanded(false):f.showChildren().setExpanded(true)}}};
jQuery.fn.expandOrCollapseAllDescendantsOfProject=function(a){var c=$(this);projecttree.getProjectReferenceFromDomProject(c).expandOrCollapseAllDescendants(a);c=c.getChildren().not(".task");a?c.showChildren("instant"):c.hideChildren("instant")};jQuery.fn.expandOrCollapseAllDescendantsOfProjectToggle=function(){var a=$(this);a.find(".project:not(.open,.task)").length>0?a.expandOrCollapseAllDescendantsOfProject(true):a.expandOrCollapseAllDescendantsOfProject(false)};
jQuery.fn.appendChildProject=function(){var a=$(this);if(projecttree.getProjectReferenceFromDomProject(a).canCreateChild()){var c=a.children(".children").children(".childrenEnd").getPriority();undoredo.startOperationBatch();a=createNewProject(a,c);a.getName().moveCursorToBeginning();if(IS_MOBILE){a=a.offset().top-50;$(window).scrollTop(a)}undoredo.finishOperationBatch()}};jQuery.fn.editNote=function(){var a=$(this).getProject();a.addClass("noted");a.getNotes().moveCursorToEnd()};
jQuery.fn.editName=function(){$(this).getProject().getName().moveCursorToEnd()};jQuery.fn.getName=function(){return $(this).children(".name")};jQuery.fn.getNotes=function(){return $(this).children(".notes")};jQuery.fn.projectIsEmpty=function(){var a=$(this);return(new content_text.ContentText(a.getName().children(".content"),false)).isEmpty()&&(new content_text.ContentText(a.getNotes().children(".content"),true)).isEmpty()&&a.is(".task")};
jQuery.fn.projectIsMergable=function(a){var c=$(this),f=projecttree.getProjectReferenceFromDomProject(c),b=c.hasClass("done"),k=a.hasClass("done");return c.is(".task")&&(new content_text.ContentText(c.getNotes().children(".content"),true)).isEmpty()&&!b&&!f.isReadOnly()&&!(k&&!b&&(new content_text.ContentText(a.getName().children(".content"),false)).isEmpty())};
jQuery.fn.caretAtEndOfText=function(a){if(a===undefined)a=false;var c=$(this),f=c.getCaret();if(f.start!==f.end)return false;c=content_text.getPlainTextForContent(c);a=a?c.replace(/\s*$/,"").length:c.length;return f.start>=a};jQuery.fn.caretAtBeginningOfText=function(){var a=$(this).getCaret();if(a.start!==a.end)return false;return a.start===0};jQuery.fn.focusHandler=function(){var a=$(this);if(IS_MOBILE){pushpoll.hideOfflineNotice();a.getProject().showControls()}};
jQuery.fn.blurHandler=function(){var a=$(this),c=a.getProject(),f=a.isNote();clearTimeout(TIMEOUTS.saveTimer);TIMEOUTS.saveTimer=null;a.saveContent();if(document.activeElement===a[0]){if(!IS_MOBILE&&f){a.addClass("focusedButWindowBlurred");setTimeout(function(){WINDOW_FOCUSED&&a.removeClass("focusedButWindowBlurred")},0)}}else FORMAT_FLAGS.clear();f&&!a.hasClass("copyOrPasteInProgress")&&!a.hasClass("focusedButWindowBlurred")&&(new content_text.ContentText(a,f)).isEmpty()&&c.removeClass("noted");
tagging.getTagAutocompleter().detach();IS_IOS&&setTimeout(function(){document.activeElement!==a[0]&&a.removeAttr("contenteditable")},0);if(IS_MOBILE){hideControls();pushpoll.unhideOfflineNotice()}};
jQuery.fn.clickOrTapHandler=function(a){a=$.extend({touchstart:false,mousedown:false,event:null,untapBehavior:"touchend",useBind:false},a);var c=$(this);if(IS_MOBILE)c.tapHandler(a.touchstart,a.event,true,a.untapBehavior,a.useBind);else if(a.useBind){c.bind("click",a.event);a.mousedown&&c.bind("mousedown",a.mousedown)}else{c.live("click",a.event);a.mousedown&&c.live("mousedown",a.mousedown)}return this};
jQuery.fn.tapHandler=function(a,c,f,b,k){function m(l,d){k?h.bind(l,d):h.live(l,d)}if(f===undefined)f=true;if(b===undefined)b="touchend";if(k===undefined)k=false;var h=$(this);m("touchstart",function(l){if(f)b==="never"?$(this).addClass("tapped"):$(this).tapIt();$(this).data("touchMove",false);if(typeof a==="function")return a.call(this,l)});m("touchmove",function(){$(this).data("touchMove",true);f&&$(this).removeClass("tapped")});m("touchend",function(l){if($(this).data("touchMove")===true)$(this).data("touchMove",
false);else{f&&b==="touchend"&&$(this).removeClass("tapped");return c.call(this,l)}})};jQuery.fn.tapIt=function(a){if(a===undefined)a="normal";var c=$(this);a=a==="fast"?100:250;c.addClass("tapped");setTimeout(function(){c.removeClass("tapped")},a)};
function addContentInteractionEventHandlers(a){function c(k,m){if(m===undefined)m=false;var h=m?function(l){return l.isInReadOnlyTree()}:function(l){return l.isReadOnly()};return function(l){var d=$(this).getProject();d=projecttree.getProjectReferenceFromDomProject(d);if(h(d))return false;return k.call(this,l)}}function f(k){return function(m){if(savedviews.HUDIsVisible())m.preventDefault();else return k.call(this,m)}}a.live("focus",function(){$(this).focusHandler()});a.live("blur",function(){$(this).blurHandler()});
a.live("click",function(){tagging.getTagAutocompleter().detach()});a.live("keydown",$.fn.keyDownHandler);a.live("keypress",$.fn.keyPressHandler);a.live("cut",function(){var k=$(this),m=k.getProject();if(projecttree.getProjectReferenceFromDomProject(m).isReadOnly())return false;k.handleCutInContent()});a.live("copy",function(){$(this).handleCopyInContent()});IS_IE||a.live("input",function(){var k=$(this);setSaveTimer(k);IS_IOS&&IOS_VERSION<7?setTimeout(function(){k.updateContentHtmlAfterUserEdit()},
0):k.updateContentHtmlAfterUserEdit()});var b=key_events.enableKeyEvents(a);b.addHandler("keydown","down",f($.fn.downArrowHandler));b.addHandler("keydown","up",f($.fn.upArrowHandler));b.addHandler("keydown","left",f($.fn.leftArrowHandler));b.addHandler("keydown","right",f($.fn.rightArrowHandler));b.addHandler("keydown","ctrl+p",$.fn.upArrowHandler);b.addHandler("keydown","ctrl+n",$.fn.downArrowHandler);b.addHandler("keydown","return",f($.fn.returnHandler));b.addHandler("keydown","shift+return",c($.fn.notesShortcut));
b.addHandler("keydown","ctrl+shift+backspace",c(function(){$(this).getProject().deleteIt();return false}));b.addHandler("keydown","ctrl+return",f(c(function(){$(this).getProject().completeIt();return false})));b.addHandler("keydown","alt+return",function(){return false});b.addHandler("keydown","ctrl+shift+return",function(){return false});b.addHandler("keydown","backspace",c(function(){var k=$(this),m=k.getProject(),h=k.isNote(),l=new content_text.ContentText(k,h);if(h){if(l.isEmpty()){m.children(".name").moveCursorToEnd();
return false}}else{h=k.getCaret();if(!(m.is(".selected")||h.start!=0||h.start!=h.end)){h=m.getPreviousProject();var d=h.projectIsMergable(m);if(h.is(".selected")||h.filter(m).length!=0||h.getParent().filter(m.getParent()).length==0||!d)if(m.projectIsEmpty()){m.deleteIt();return false}else return;undoredo.startOperationBatch();d=new content_text.ContentText(h.getName().children(".content"),false);l=d.concatenate(l);m.getName().children(".content").setAndSaveContentText(l.getText());h.deleteIt(true);
k.setCaret(d.getPlainText().length);IS_MOBILE&&m.scrollToViewProjectForMobile();undoredo.finishOperationBatch();return false}}}));b.addHandler("keydown","del",c(function(){var k=$(this),m=k.getProject(),h=k.isNote();if(!h){var l=new content_text.ContentText(k,h);h=l.getPlainText();k=k.getCaret();if(!(m.is(".selected")||k.start!=h.length||k.start!=k.end)){k=m.getNextProject();var d=projecttree.getProjectReferenceFromDomProject(k),g=m.projectIsMergable(k);if(!(k.filter(m).length!=0||k.getParent().filter(m.getParent()).length==
0||!g||d.isReadOnly())){undoredo.startOperationBatch();k=k.getName().children(".content");d=new content_text.ContentText(k,false);m.deleteIt(true);m=l.concatenate(d);k.setAndSaveContentText(m.getText());k.setCaret(h.length);undoredo.finishOperationBatch();return false}}}}));b.addHandler("keydown","tab",c(function(){var k=$(this);if(tagging.getTagAutocompleter().autocompleteSelectedTag(k))return false;if(k.isNote()){var m=new content_text.ContentText(k,true),h=k.getCaret();m=m.insertAtCaret("\t",h);
k.setContentTextAsUserEdit(m.getText());k.setCaret(h.start+1)}else k.indentProject();return false},true));b.addHandler("keydown","shift+tab",c(function(){var k=$(this);k.isName()&&k.outdentProject();return false},true));b.addHandlerForShortcuts("keydown","right",SHORTCUT_KEYS,f(function(){$(this).keyboardZoomIn();return false}));b.addHandlerForShortcuts("keydown","left",SHORTCUT_KEYS,f(function(){keyboardZoomOut();return false}));b.addHandlerForShortcuts("keydown",".",SHORTCUT_KEYS_WITH_META,f(function(){$(this).keyboardZoomIn();
return false}));b.addHandlerForShortcuts("keydown",",",SHORTCUT_KEYS_WITH_META,f(function(){keyboardZoomOut();return false}));b.addHandler("keydown","ctrl+up",f(function(){$(this).keyboardCollapse();return false}));b.addHandler("keydown","ctrl+down",f(function(){$(this).keyboardExpand();return false}));IS_FIREFOX||b.addHandler("keydown","ctrl+space",function(){$(this).keyboardExpandToggle();return false});b.addHandlerForShortcuts("keydown","shift+up",SHORTCUT_KEYS,f(c(function(){$(this).moveProjectUpOrDown("up");
return false},true)));b.addHandlerForShortcuts("keydown","shift+down",SHORTCUT_KEYS,f(c(function(){$(this).moveProjectUpOrDown("down");return false},true)));b.addHandlerForShortcuts("keydown","shift+left",SHORTCUT_KEYS,f(c(function(){$(this).outdentProject();return false},true)));b.addHandlerForShortcuts("keydown","shift+right",SHORTCUT_KEYS,f(c(function(){$(this).indentProject();return false},true)));b.addHandlerForShortcuts("keydown","b",["ctrl","meta"],function(){var k=$(this),m=k.getProject();
if(projecttree.getProjectReferenceFromDomProject(m).isReadOnly())return false;m=k.getCaret();if(m.start===m.end){FORMAT_FLAGS.setFormatFlagsSetLocation(k,m.start);FORMAT_FLAGS.toggleBold();return false}var h=new content_text.ContentText(k,k.isNote());h.toggleBoldForCaret(m);k.setContentHtmlAsUserEdit(h.getContentHtml());k.setCaret(m.start,m.end);return false});b.addHandlerForShortcuts("keydown","i",["ctrl","meta"],function(){var k=$(this),m=k.getProject();if(projecttree.getProjectReferenceFromDomProject(m).isReadOnly())return false;
m=k.getCaret();if(m.start===m.end){FORMAT_FLAGS.setFormatFlagsSetLocation(k,m.start);FORMAT_FLAGS.toggleItalic();return false}var h=new content_text.ContentText(k,k.isNote());h.toggleItalicForCaret(m);k.setContentHtmlAsUserEdit(h.getContentHtml());k.setCaret(m.start,m.end);return false});if(IS_IE){b.addHandlerForShortcuts("keydown","v",["ctrl","meta"],function(k){return $(this).handlePasteIntoContent(k)});b.addHandlerForShortcuts("keydown","v",["ctrl+shift","meta+shift"],function(k){return $(this).handlePasteIntoContent(k)});
b.addHandlerForShortcuts("keydown","insert",["shift"],function(k){return $(this).handlePasteIntoContent(k)})}a.live("paste",function(k){return $(this).handlePasteIntoContent(k,true)})}
function addGlobalKeyboardShortcuts(){function a(k){var m=k.ctrlKey||k.metaKey;savedviews.updateModifierKeyStatus(m&&k.shiftKey,m)}function c(k){search.inSearchMode()&&search.exitSearchMode(true);selectProjectReferenceInstantly(k);IS_MOBILE||focusFirstChildOfSelected();$(window).scrollTop(0)}var f=$(window),b=key_events.enableKeyEvents(f,true);b.addHandlerForShortcuts("keydown","left",SHORTCUT_KEYS,function(k){k.preventDefault()});b.addHandlerForShortcuts("keydown","right",SHORTCUT_KEYS,function(k){k.preventDefault()});
b.addHandlerForShortcuts("keydown",",",SHORTCUT_KEYS_WITH_META,function(k){k.preventDefault()});b.addHandlerForShortcuts("keydown",".",SHORTCUT_KEYS_WITH_META,function(k){k.preventDefault()});b.addHandlerForShortcuts("keydown","s",["ctrl","meta"],function(){saveEditingContent();pushpoll.scheduleNextPushAndPoll(true);return false});b.addHandlerForShortcuts("keydown","z",["ctrl","meta"],function(){undoredo.undo();return false});b.addHandlerForShortcuts("keydown","shift+z",["ctrl","meta"],function(){undoredo.redo();
return false});b.addHandlerForShortcuts("keydown","y",["ctrl","meta"],function(){undoredo.redo();return false});b.addHandlerForShortcuts("keydown","o",["ctrl","meta"],function(){toggleCompletedVisibility();return false});b.addHandlerForShortcuts("keydown","home",["ctrl","meta"],function(){var k=getCurrentlyFocusedContent();if(!(k!==null&&k.isNote())){focusFirstProject();return false}});b.addHandlerForShortcuts("keydown","end",["ctrl","meta"],function(){var k=getCurrentlyFocusedContent();if(!(k!==
null&&k.isNote())){focusLastProject();return false}});b.addHandler("keydown","esc",function(){var k=$(document.activeElement).is("#searchBox");if(undeleteMessageIsVisible()&&!k){hideMessage();return false}if(search.inSearchMode())search.cancelSearchAsUserAction();else if(k){$("#searchBox").blur();focusFirstProject()}else $("#searchBox").focus();return false});b.addHandlerForShortcuts("keydown","shift+/",["ctrl","meta"],function(){keyboard_shortcut_helper.toggle();return false});b.addHandlerForShortcuts("keydown",
"/",["ctrl","meta"],function(){keyboard_shortcut_helper.toggle();return false});b.addHandlerForShortcuts("keydown","shift+*",["ctrl","meta"],function(){savedviews.toggleCurrentViewSaved();savedviews.pretendModifierKeysNotPressedUntilTheyAreReleased();return false});b.addHandlerForShortcuts("keydown","shift+;",["ctrl","meta"],function(){savedviews.switchLeft();return false});b.addHandlerForShortcuts("keydown",";",["ctrl","meta"],function(){savedviews.switchRight();return false});f.bind("keydown",function(k){a(k);
if(savedviews.HUDIsVisible())switch(k.keyCode){case $.ui.keyCode.LEFT:savedviews.switchLeft();return false;case $.ui.keyCode.RIGHT:savedviews.switchRight();return false;case $.ui.keyCode.ENTER:savedviews.switchToSelectedViewIfAppropriate();return false;default:savedviews.hideIfModifierNotPressed()}});f.bind("keyup",a);b.addHandlerForShortcuts("keydown","(",["ctrl"],function(){var k=projecttree.getProjectReferenceFromDomProject(selectOnActivePage(".selected")).getPreviousPotentiallyVisibleSibling(true);
if(k===null)return false;c(k);return false});b.addHandlerForShortcuts("keydown",")",["ctrl"],function(){var k=projecttree.getProjectReferenceFromDomProject(selectOnActivePage(".selected")).getNextPotentiallyVisibleSibling(true);if(k===null)return false;c(k);return false});if(IS_CHROME_APP){b.addHandlerForShortcuts("keydown","[",["ctrl","meta"],function(){location_history.navigateBackward()});b.addHandlerForShortcuts("keydown","]",["ctrl","meta"],function(){location_history.navigateForward()})}APPCACHE_ENABLED&&
ON_DEVELOPMENT_SERVER&&b.addHandlerForShortcuts("keydown","shift+a",["ctrl","meta"],function(){forceReloadAppCache();return false})}function focusFirstChildOfSelected(){var a=selectOnActivePage(".selected"),c=a.getVisibleChildren();(c.length>0?c.first():a).getName().moveCursorToBeginning()}function focusFirstProject(){var a=$(NAVIGABLE_PROJECTS_PATTERN+":first");a.length===1&&a.getName().moveCursorToBeginning()}
function focusLastProject(){var a=$(NAVIGABLE_PROJECTS_PATTERN+":last");a.length===1&&a.getName().moveCursorToEnd()}function saveEditingContent(){var a=getCurrentlyFocusedContent();a!==null&&a.saveContent()}
jQuery.fn.keyDownHandler=function(a){var c=$(this),f=c.getProject();IS_MOBILE||hideControls();f.hasClass("highlighted")&&f.removeClass("highlighted");if(projecttree.getProjectReferenceFromDomProject(f).isReadOnly())if(!a.ctrlKey&&!a.altKey&&!a.metaKey)switch(a.keyCode){case $.ui.keyCode.DOWN:case $.ui.keyCode.UP:case $.ui.keyCode.LEFT:case $.ui.keyCode.RIGHT:break;default:a.preventDefault();return}if(IS_IE){setSaveTimer(c);setTimeout(function(){c.updateContentHtmlAfterUserEdit()},0)}};
jQuery.fn.keyPressHandler=function(a){var c=$(this);if(!IS_MOBILE){var f=String.fromCharCode(a.which);tagging.isTagStartChar(f)&&tagging.getTagAutocompleter().attach(c,f);if(!FORMAT_FLAGS.isEmpty()){var b=c.getCaret();FORMAT_FLAGS.clearFormatFlagsSetLocationIfChanged(c,b.start);FORMAT_FLAGS.isEmpty()||setTimeout(function(){if(document.activeElement===c[0]){var k=c.getCaret();if(k.start===b.start+1){var m=new content_text.ContentText(c,c.isNote()),h=m.getPlainText(),l={start:k.start-1,end:k.end};if(h.charAt(l.start)===
f){FORMAT_FLAGS.boldIsSet()&&m.toggleBoldForCaret(l);FORMAT_FLAGS.italicIsSet()&&m.toggleItalicForCaret(l);FORMAT_FLAGS.clear();c.setContentHtmlAsUserEdit(m.getContentHtml());c.setCaret(k.start,k.end)}}}},0)}}};function setSaveTimer(a){if(USE_EXPERIMENTAL_PUSHPOLL_TIMINGS){if(TIMEOUTS.saveTimer!==null)return}else clearTimeout(TIMEOUTS.saveTimer);TIMEOUTS.saveTimer=setTimeout(function(){TIMEOUTS.saveTimer=null;a.saveContent()},1E3)}
jQuery.fn.downArrowHandler=function(){var a=$(this);if(tagging.getTagAutocompleter().moveSelection(a,"down"))return false;var c=a.getProject();if(a.isNote()){if(a.caretAtEndOfText()){a=c.getNextProject();if(a.filter(c).length===0){a.getName().moveCursorToBeginning();return false}}}else{if(c.is(".selected")&&c.is(".noted")){c.getNotes().moveCursorToBeginning();return false}a=c.getNextProject();a.filter(c).length!=0?c.getName().moveCursorToEnd():a.getName().moveCursorToBeginning();return false}};
jQuery.fn.upArrowHandler=function(){var a=$(this);if(tagging.getTagAutocompleter().moveSelection(a,"up"))return false;var c=a.getProject();if(a.isNote()){if(a.caretAtBeginningOfText()){c.children(".name").moveCursorToBeginning();return false}}else{a=c.getPreviousProject();if(a.is(".selected")&&!c.is(".selected")&&a.is(".noted")){a.getNotes().moveCursorToEnd();return false}a.children(".name").moveCursorToBeginning();return false}};
jQuery.fn.leftArrowHandler=function(){var a=$(this),c=a.isNote();if(a.caretAtBeginningOfText()){a=a.getProject();if(c)a.getName().moveCursorToEnd();else{c=a.getPreviousProject();c.is(".selected")&&!a.is(".selected")&&c.is(".noted")?c.getNotes().moveCursorToEnd():c.getName().moveCursorToEnd()}return false}};
jQuery.fn.rightArrowHandler=function(){var a=$(this);if(a.caretAtEndOfText()){var c=a.isNote();a=a.getProject();if(!c&&a.is(".selected")&&a.is(".noted")){a.getNotes().moveCursorToBeginning();return false}var f=a.getNextProject();if(!c||f.filter(a).length===0){f.getName().moveCursorToBeginning();return false}}};
jQuery.fn.returnHandler=function(){var a=$(this);if(tagging.getTagAutocompleter().autocompleteSelectedTag(a))return false;var c=a.getProject(),f=a.isNote(),b=projecttree.getProjectReferenceFromDomProject(c).isReadOnly(),k=new content_text.ContentText(a,f);if(f){if(!b){var m=a.getCaret();c=k.insertAtCaret("\n",m);a.setContentTextAsUserEdit(c.getText(),true);a.setCaret(m.start+1)}return false}if(k.isEmpty())if(a.outdentProject())return false;if(c.is(".selected")||a.caretAtEndOfText(true)){if(c.is(".open, .selected")){f=
c;c=0}else{f=c.getParent();c=c.getPriority()+1}m=projecttree.getProjectReferenceFromDomProject(f);if(m.canCreateChild()){undoredo.startOperationBatch();f=createNewProject(f,c);f.getName().moveCursorToBeginning();undoredo.finishOperationBatch()}}else{f=c.getParent();m=projecttree.getProjectReferenceFromDomProject(f);if(m.canCreateChild()){m=a.getCaret();a=k.substring(0,m.start);k=k.substring(m.end);undoredo.startOperationBatch();f=createNewProject(f,c.getPriority());if(!b){f.getName().children(".content").setAndSaveContentText(a.getText());
c.getName().children(".content").setAndSaveContentText(k.getText());c.getName().moveCursorToBeginning()}undoredo.finishOperationBatch()}}return false};jQuery.fn.notesShortcut=function(){var a=$(this);a.isName()?a.editNote():a.editName();return false};
jQuery.fn.moveProjectUpOrDown=function(a){var c=$(this);if(c.isNote())return false;var f=c.getProject();if(f.is(".selected"))return false;for(var b=f,k=0;;){var m=a==="up"?b.getPreviousSibling():b.getNextSibling();if(k>0)for(;m.length===1&&m.is(":not(.task):not(.open)");)m=a==="up"?m.getPreviousSibling():m.getNextSibling();if(m.length===1)break;b=b.getParent();k++;if(b.is(".selected"))return false}if(k===0)a=a==="up"?m:m.getNextSibling(true);else{b=m;for(m=0;m<k-1;){var h=b.getVisibleChildren();if(h.length===
0)break;h=a==="up"?h.last():h.first();if(h.is(":not(.task):not(.open)"))break;b=h;m++}(k=b.is(".task"))&&b.showChildren("instant").setExpanded(true);a=a==="up"||k?b.children(".children").children(".childrenEnd"):b.getVisibleChildren().first()}if(!projecttree.getProjectReferenceFromDomProject(f).isValidMove(a))return false;c=c.getCaret();undoredo.startOperationBatch();f.moveProject(a).getName().children(".content").setCaret(c.start,c.end);undoredo.finishOperationBatch();return true};
jQuery.fn.getNewNextProjectOrChildrenEndForIndent=function(){var a=$(this),c=projecttree.getProjectReferenceFromDomProject(a);if(a.is(".selected"))return null;a=a.getPreviousSibling();if(a.length===0)return null;var f=a.children(".children").children(".childrenEnd");if(!c.isValidMove(f))return null;return{newNextProjectOrChildrenEnd:f,previousSibling:a}};
jQuery.fn.indentProject=function(){var a=$(this).getProject(),c=projecttree.getProjectReferenceFromDomProject(a),f=a.getNewNextProjectOrChildrenEndForIndent();if(f===null)return false;var b=f.newNextProjectOrChildrenEnd;f=f.previousSibling;var k=null,m=a.getName().children(".content");if(document.activeElement===m[0])k=m.getCaret();undoredo.startOperationBatch();a.moveProject(b);f.is(".open")||f.showChildren("instant").setExpanded(true);k!==null&&c.getMatchingDomProject().getName().children(".content").setCaret(k.start,
k.end);undoredo.finishOperationBatch();return true};jQuery.fn.getNewNextProjectOrChildrenEndForOutdent=function(){var a=$(this);if(a.is(".selected"))return null;var c=a.getParent();if(c.is(".mainTreeRoot")||c.is(".selected"))return null;c=c.next(".project, .childrenEnd");if(!projecttree.getProjectReferenceFromDomProject(a).isValidMove(c))return null;return{newNextProjectOrChildrenEnd:c}};
jQuery.fn.outdentProject=function(){var a=$(this).getProject(),c=a.getNewNextProjectOrChildrenEndForOutdent();if(c===null)return false;var f=c.newNextProjectOrChildrenEnd;c=null;var b=a.getName().children(".content");if(document.activeElement===b[0])c=b.getCaret();undoredo.startOperationBatch();a=a.moveProject(f);c!==null&&a.getName().children(".content").setCaret(c.start,c.end);undoredo.finishOperationBatch();return true};jQuery.fn.isName=function(){return $(this).parent(".name").length>0};
jQuery.fn.isNote=function(){return $(this).parent(".notes").length>0};function createNewProject(a,c){return projecttree.getProjectReferenceFromDomProject(a).applyLocalCreateChild(c).getMatchingDomProject()}
jQuery.fn.getPreviousProject=function(a,c){if(a===undefined)a=false;if(c===undefined)c=false;var f=$(this),b=a?DROP_TARGET_PATTERN:NAVIGABLE_PROJECTS_PATTERN,k=f.getPreviousSibling();if(k.length===0){k=f.getParent();if(k.is(b))return k;return f}else if(c)return k;else for(f=k;;){k=f.children(".children").children(b).last();if(k.length===0)return f;f=k}};
jQuery.fn.getNextProject=function(a,c){if(a===undefined)a=false;if(c===undefined)c=false;var f=$(this),b=c?DROP_TARGET_PATTERN:NAVIGABLE_PROJECTS_PATTERN;if(!a){var k=f.children(".children").children(b).first();if(k.length>0)return k}k=f;do{var m=k.getNextSibling(c);if(m.length>0)return m;k=k.getParent()}while(k.is(b));return f};jQuery.fn.getPreviousSibling=function(){return $(this).prevAll(NAVIGABLE_PROJECTS_PATTERN).last()};
jQuery.fn.getNextSibling=function(a){if(a===undefined)a=false;a=a?DROP_TARGET_PATTERN:NAVIGABLE_PROJECTS_PATTERN;return $(this).nextAll(a).first()};jQuery.fn.moveCursorToEnd=function(){$(this).children(".content").setCaret(-1);return this};jQuery.fn.moveCursorToBeginning=function(){$(this).children(".content").setCaret(0);return this};jQuery.fn.keyboardZoomIn=function(){$(this).getProject().selectIt("first_child");return this};
function keyboardZoomOut(){var a=selectOnActivePage(".selected");a.is(".mainTreeRoot")||a.getParent().selectIt("last_selected")}jQuery.fn.keyboardExpandToggle=function(){var a=$(this).getProject();a.is(".selected")?a.expandOrCollapseAllDescendantsOfProjectToggle():a.clickExpandButton(true)};
jQuery.fn.keyboardCollapse=function(){var a=$(this).getProject();if(a.is(".selected")){var c=a.find(".project.open:visible").getAncestorCounts();a=c.maxNumAncestors;c=c.numAncestorsToProjectMap;if(a!==undefined){a=c[a];for(var f in a)a[f].hideChildren("instant").setExpanded(false)}}else a.is(".task")||!a.is(".open")||a.hideChildren().setExpanded(false)};
jQuery.fn.keyboardExpand=function(){var a=$(this).getProject();if(a.is(".selected")){var c=a.find(".project:visible:not(.task):not(.open)").getAncestorCounts();a=c.minNumAncestors;c=c.numAncestorsToProjectMap;if(a!==undefined){a=c[a];for(var f in a)a[f].showChildren("instant").setExpanded(true)}}else a.is(".task")||a.is(".open")||a.showChildren().setExpanded(true)};
jQuery.fn.getAncestorCounts=function(){var a=$(this),c={},f=undefined,b=undefined;a.each(function(){var k=$(this),m=projecttree.getProjectReferenceFromDomProject(k).getAncestors().length;if(m in c)c[m].push(k);else c[m]=[k];f=f===undefined||m<f?m:f;b=b===undefined||m>b?m:b});return{numAncestorsToProjectMap:c,minNumAncestors:f,maxNumAncestors:b}};
function showMessage(a,c,f){if(c===undefined)c=false;var b=$("#message");b.removeClass();c&&b.addClass("errorMessage");f!=undefined&&b.addClass(f);b.find(".messageContent").html(a);if(!b.is(":visible")){b.children(".close").hide();b.slideDown("normal",function(){$(this).find(".close").show()})}}function hideMessage(){var a=$("#message");a.children(".close").hide();a.find(".messageContent").html("");a.slideUp()}
function undeleteMessageIsVisible(){return $("#message:visible > .messageContent > .undelete").length===1}
jQuery.fn.completeIt=function(){var a=$(this),c=projecttree.getProjectReferenceFromDomProject(a);undoredo.startOperationBatch();if(a.is(".done")){c.applyLocalUncomplete();IS_MOBILE||a.focusProject()}else{c.applyLocalComplete();a.show();shouldShowCompletedProjects()||setTimeout(function(){a.incrementAnimationCounter().slideUp(animations.getAnimationTiming("children"),function(){$(this).removeAttr("style");animations.getAnimationCounter().decrement()})},1E3);if(a.is(".selected"))setTimeout(function(){a.getParent().selectIt()},
500);else if(!IS_MOBILE){c=a.getNextProject(true);if(c.filter(a).length>0)for(;;){var f=c;c=c.getPreviousProject();if(c.filter(f).length>0)break;if(shouldShowCompletedProjects()||!c.is(".done"))break}c.filter(a).length===0&&c.children(".name").moveCursorToBeginning()}}undoredo.finishOperationBatch()};
jQuery.fn.deleteIt=function(a){if(a===undefined)a=false;var c=$(this),f=projecttree.getProjectReferenceFromDomProject(c),b=c.getParent();if(!a){var k=c.is(".selected"),m=c.projectIsEmpty(),h=f.isAddedSubtreePlaceholder(),l=c.getPreviousProject();if(l.filter(c).length>0)l=null;undoredo.startOperationBatch()}f.applyLocalDelete(!a);if(!a){if(k)b.selectIt();else if(l!==null){l.children(".name").moveCursorToEnd();IS_MOBILE&&l.scrollToViewProjectForMobile()}undoredo.finishOperationBatch();m||(h?showMessage('Embedded list removed from this account. <a class="undelete" href="#">Undo.</a>'):
showMessage('Item deleted. <a class="undelete" href="#">Undo.</a>'))}};jQuery.fn.undeleteIt=function(){undoredo.startOperationBatch();projecttree.getAllProjectTreesHelper().applyLocalUndeleteOfLastDeletedProject();undoredo.finishOperationBatch()};
jQuery.fn.duplicateIt=function(){var a=$(this),c=projecttree.getProjectReferenceFromDomProject(a),f=c.getPriority();a=projecttree.getProjectReferenceFromDomProject(a.getParent());c=c.duplicateProjectTreeForBulkCreate();undoredo.startOperationBatch();var b=a.applyLocalBulkCreateChildren(f+1,[c])[0].getMatchingDomProject();if(b.length>0&&b.is(":visible")){b.getName().moveCursorToBeginning();b.addClass("moving");setTimeout(function(){b.removeClass("moving")},500)}undoredo.finishOperationBatch()};
function showLoginPopup(){closeAllDialogs();var a=$("#loginPopup");a.append($("#loginPopupContents").children().clone(true));a.setDialogButtonsDisable(false);a.dialog("open");a.find(".loginFormPasswordInput").focus()}function hideLoginPopup(){var a=$("#loginPopup");a.html("");a.dialog("close")}function closeAllDialogs(){$(".ui-dialog:visible > .ui-dialog-content").dialog("close")}
jQuery.fn.moveProject=function(a){var c=$(this);c=projecttree.getProjectReferenceFromDomProject(c);var f=projecttree.getProjectReferenceFromDomProject(a.getParent());a=a.getPriority();c.applyLocalMove(f,a);return c.getMatchingDomProject()};function hideControls(){var a=$("#controlsLeft");$("#hidden").append($("#controls"));a.removeClass("hovered")}
jQuery.fn.clearControlsUnderProject=function(a){if(a===undefined)a=false;var c=$(this);a=a?c.children(".children"):c;a.find("#controls").length===1&&hideControls();(a=a.find("#sortDrop"))&&$("#hidden").append(a)};function blurFocusedContent(){var a=$(document.activeElement);a.length===1&&a.is(".content")&&a.blur()}function blurFocusedContentOrInput(){var a=$(document.activeElement);a.length===1&&a.is(".content, input")&&a.blur()}
jQuery.fn.setDialogButtonsDisable=function(a){$(this).parent().find("button").button("option","disabled",a)};function closeSiteMessage(){$("#site_message").slideUp();return this}
function addSharedSubtreeToAccount(){var a=projecttree.getMainProjectTree();if(a.isShared()){a=a.getRootProjectId();var c=$("#addSharedSubtreeToMyAccountPopup");c.removeClass("success failure");c.dialog("open");c.addSpinner();c.dialog("option",{buttons:{}});var f=function(b,k,m){if(m===undefined)m="There was an error communicating with the server. Please try again.";c.addClass("failure");c.find(".failureMessage").text(m);c.removeSpinner();c.dialog("option",{buttons:{Close:function(){c.dialog("close")}}})};
$.ajax({url:"/add_shared_subtree",data:{shared_projectid:a},dataType:"json",type:"POST",success:function(b,k){if(b==null)f();else if(b.success){c.addClass("success");c.removeSpinner();c.dialog("option",{buttons:{"View my account":function(){c.addSpinner();c.setDialogButtonsDisable(true);window.location="/"},Close:function(){c.dialog("close")}}});_gaq.push(["_trackEvent","Interaction","Added shared subtree"])}else{var m=undefined;switch(b.error){case "no_shared_project":m="This list is no longer shared.";
break;case "adding_own_shared_project":m="This is your own list. It's already in your account!";break;case "already_added_shared_project":m="You've already added this list to your account."}f(b,k,m)}},error:f})}}
function refreshVisibleChildrenUnderSelectedForAddButton(a){if(!IS_MOBILE){if(a===undefined)a=selectOnActivePage(".addButton");selectOnActivePage(".selected > .children > .project:visible:first").length>0?a.addClass("visibleChildrenUnderSelected"):a.removeClass("visibleChildrenUnderSelected")}}function reloadPageFromServer(){if(IS_CHROME_APP)reloadChromeApp();else APPCACHE_ENABLED?forceReloadAppCache():window.location.reload(true)}
function reloadChromeApp(){indexeddbhelper.getStores().initializationData.clear(function(){chrome.runtime.reload()})}function forceReloadAppCache(){localstoragehelper.localStorageSupported()&&localstoragehelper.write("next",window.location.pathname+window.location.search+window.location.hash);apphooks.notifyThatAppCacheIsNowUncached();window.location="/force_update_appcache"}
var localstoragehelper=function(){function a(k){return f.getItem(k)}function c(k){for(var m=f.length,h=[],l=0;l<m;l++){var d=f.key(l);h.push(d)}for(m=0;m<h.length;m++)k(h[m])}var f=null,b=null;return{init:function(){if(IS_CHROME_APP){b=true;f=indexeddbhelper.getLocalStorageAdapter()}else{b=localstoragedetect.localStorageSupported();f=window.localStorage;if(!b)return}userstorage.init();IS_CHROME_APP||$(window).bind("storage",function(k){if("originalEvent"in k&&"key"in k.originalEvent){k=k.originalEvent.key;
if(userstorage.isEnabled())if(userstorage.isUserStorageKey(k)){k=userstorage.stripKeyPrefix(k);userstorage.notifyChange(k)}}})},localStorageSupported:function(){return b},write:function(k,m){try{f.setItem(k,m)}catch(h){}},read:a,remove:function(k){f.removeItem(k)},forEachKey:c,dumpAll:function(){var k={};c(function(m){k[m]=a(m)});return k},notifyWindowFocus:function(){projecttree.getAllProjectTreesHelper().readLocalStorageExpandedProjects();userstorage.isEnabled()&&userstorage.notifyWindowFocus()}}}(),
userstorage=function(){function a(){this.name="InitializationError"}function c(p){if(p===undefined)p=false;var s=b(q);if(s!==null){p=p;if(p===undefined)p=false;for(var w in s){var u=s[w];if(w in SETTINGS){var A=u!==SETTINGS[w].value;SETTINGS[w].value=u;!p&&A&&settings.registerSettingChange(w)}}}}function f(p){var s=b(q);if(s===null)s={};for(var w in p)if(w in SETTINGS&&SETTINGS[w].saveToClient)s[w]=p[w];p=q;s=JSON.stringify(s);l(p,s)}function b(p){p=h(p);if(p===null)return null;try{return JSON.parse(p)}catch(s){return null}}
function k(){m(function(p){d(p)})}function m(p){localstoragehelper.forEachKey(function(s){if(g(s)){s=j(s);p(s)}})}function h(p){return localstoragehelper.read(n+p)}function l(p,s){return localstoragehelper.write(n+p,s)}function d(p){return localstoragehelper.remove(n+p)}function g(p){return utils.isPrefixMatch(p,n)}function j(p){return p.substring(n.length)}var o=false,n="userstorage.",q="settings",r=false;a.prototype=Error();var t=Class.extend({init:function(p,s,w){this.namespace=p;this.name=s;this.storageKey=
this.namespace+"."+this.name;this.value=w;this.isInStorage()?this.syncFromStorage():this.syncToStorage()},setValue:function(p){this.value=p;this.syncToStorage()},getValue:function(){return this.value},isInStorage:function(){if(!FULL_OFFLINE_ENABLED)return false;return userstorage.read(this.storageKey)!==null},syncFromStorage:function(){if(FULL_OFFLINE_ENABLED){var p=userstorage.read(this.storageKey);this.value=utils.parseJsonWithErrorHandling(p,function(){throw new a;})}},syncToStorage:function(){if(FULL_OFFLINE_ENABLED){var p=
JSON.stringify(this.value);userstorage.write(this.storageKey,p)}}}),v=t.extend({init:function(p,s){this._super(p,s,{})},set:function(p,s){this.value[p]=s;this.syncToStorage()},get:function(p){return this.value[p]},getDict:function(){return this.getValue()},clear:function(){this.setValue({})},copyTo:function(p){p.setValue(this.value)},overlayOn:function(p){for(var s in this.value)p[s]=this.value[s]},isEmpty:function(){return utils.objectIsEmpty(this.value)}}),x=Class.extend({type:null,init:function(p,
s){this.namespace=p;this.queueName=s;this.storagePrefix=this.namespace+"."+this.type+"."+this.queueName+".";this.list=null;this.isInStorage()?this.syncFromStorage():this.clear()},isInStorage:function(){if(!FULL_OFFLINE_ENABLED)return false;return this.readKey("length")!==null},syncFromStorage:function(){if(FULL_OFFLINE_ENABLED)this.list=this.readList()},syncToStorage:function(p){if(p===undefined)p=null;if(FULL_OFFLINE_ENABLED)p!==null?this.appendListInStorage(this.list,p):this.writeList(this.list)},
clear:function(){this.list=[];this.syncToStorage()},append:function(p){this.appendList([p])},appendList:function(p){var s=this.list.length;utils.pushArray(this.list,p);this.syncToStorage(s)},copyTo:function(p){p.list=this.list;p.syncToStorage()},prependTo:function(p){p.list=this.list.concat(p.list);p.syncToStorage()},setList:function(p){this.list=p;this.syncToStorage()},getLength:function(){return this.list.length},getList:function(){return this.list},applyToEachItemInList:function(p){for(var s=false,
w=0;w<this.list.length;w++)s|=p(this.list[w]);s&&this.syncToStorage()},readList:function(){var p=[],s=this.readKey("num_chunks");if(s===null)throw new a;s=parseInt(s);if(isNaN(s)||s<0)throw new a;for(var w=0;w<s;w++){var u=this.readChunk(w);if(u===null)throw new a;utils.pushArray(p,u)}return p},writeList:function(p){var s=this.readKey("num_chunks");s=s!==null?parseInt(s):0;for(var w=0;w<s;w++)this.removeKey(this.chunkKey(w));this.appendChunksInStorage(0,p);this.writeKey("length",p.length)},appendListInStorage:function(p,
s){var w=p.slice(s),u=this.readKey("num_chunks");if(u>0){var A=u-1,B=this.readChunk(A),E=10-B.length;if(E>0){E=w.splice(0,E);utils.pushArray(B,E);this.writeChunk(A,B)}}w.length>0&&this.appendChunksInStorage(u,w);this.writeKey("length",p.length)},appendChunksInStorage:function(p,s){for(var w=p,u=0;u<s.length;u+=10){var A=w,B=s.slice(u,u+10);this.writeChunk(A,B);w++}this.writeKey("num_chunks",w)},readChunk:function(p){p=this.readKey(this.chunkKey(p));if(p===null||p.length===0)return null;if(p.charAt(0)===
"*"){p=LZString.decompressFromUTF16(p.substring(1));if(p===null)return null}else p=p;try{var s=JSON.parse(p)}catch(w){return null}return s},writeChunk:function(p,s){var w=JSON.stringify(s);w="*"+LZString.compressToUTF16(w);this.writeKey(this.chunkKey(p),w)},chunkKey:function(p){return"chunk."+p},getUserStorageKeyName:function(p){return this.storagePrefix+p},readKey:function(p){return userstorage.read(this.getUserStorageKeyName(p))},writeKey:function(p,s){return userstorage.write(this.getUserStorageKeyName(p),
s)},removeKey:function(p,s){return userstorage.remove(this.getUserStorageKeyName(p),s)}}),e=x.extend({type:"operation_queue",init:function(p,s){this._super(p,s);o&&this._convertToNewContentTextFormat()},containsOperationType:function(p){for(var s=0;s<this.list.length;s++)if(this.list[s].type===p)return true;return false},_convertToNewContentTextFormat:function(){this.applyToEachItemInList(function(p){return operations.convertOperationToNewContentTextFormat(p)})}});x=x.extend({type:"operation_transaction_queue",
init:function(p,s){this._super(p,s);o&&this._convertToNewContentTextFormat()},getMostRecentOperationTransactionId:function(){return this.list.length===0?null:this.list[this.list.length-1].id},getMoreRecentOperationTransactions:function(p){var s=this.list.length;for(s=this.list.length;s>0;s--)if(this.list[s-1].id<=p)break;return this.list.slice(s)},_convertToNewContentTextFormat:function(){this.applyToEachItemInList(function(p){p=p.ops;for(var s=false,w=0;w<p.length;w++)s|=operations.convertOperationToNewContentTextFormat(p[w]);
return s})}});return{InitializationError:a,init:function(){r=true;var p=h("user_id");if(p===null||p!==USER_ID){utils.debugMessage("Clearing userstorage because of new or different user_id");k();l("user_id",USER_ID);l("format_version",2)}if(parseInt(h("format_version"))<2){o=true;l("format_version",2)}p=h("appcache_id");if(p===null||APPCACHE_ID!==p){utils.debugMessage("First run for this app cache version");l("appcache_id",APPCACHE_ID)}else{utils.debugMessage("Not the first run for this app cache version");
for(var s in FIRST_LOAD_FLAGS)FIRST_LOAD_FLAGS[s]=false}c(true)},isEnabled:function(){return r},read:h,write:l,remove:d,clear:k,isUserStorageKey:g,stripKeyPrefix:j,dumpAll:function(){var p={};m(function(s){p[s]=h(s)});return p},updateSettingsFromServer:function(p){f(p);c()},saveSettings:f,notifyChange:function(p){p===q&&c()},notifyWindowFocus:function(){c()},PersistentValue:t,PersistentDict:v,PersistentOperationQueue:e,PersistentOperationTransactionQueue:x}}(),appcachehelper=function(){function a(d,
g){for(var j=0;j<d.length;j++)(0,d[j])(g)}function c(){try{window.applicationCache.update()}catch(d){utils.debugMessage(d);utils.debugMessage("Exception thrown when applicationCache.update() called. Update failed.");a(h,false);a(l,false);h=[];l=[];m=false}}function f(d){if(d===undefined)d=null;if(k()){d!==null&&l.push(d);m=true}else{d!==null&&h.push(d);c()}}function b(d){if(k())h.push(function(){b(d)});else{utils.debugMessage("Marking cache manifest dirty on server so we can update app cache");$.ajax({url:"/mark_cache_manifest_dirty",
success:function(){f(d)}})}}function k(){return window.applicationCache.status===window.applicationCache.CHECKING||window.applicationCache.status===window.applicationCache.DOWNLOADING}var m=false,h=[],l=[];return{init:function(){window.applicationCache.onupdateready=window.applicationCache.oncached=window.applicationCache.onobsolete=window.applicationCache.onnoupdate=function(){a(h,window.applicationCache.status===window.applicationCache.UPDATEREADY);h=l;l=[];if(m){m=false;c()}else apphooks.notifyThatAppCacheIsNowCached()};
window.applicationCache.onerror=function(){utils.pushArray(h,l);l=[];if(m||h.length>0){m=false;c()}}},update:f,markCacheManifestDirtyAndThenUpdate:b,swapCache:function(){window.applicationCache.swapCache()},isCurrentlyDownloading:function(){return window.applicationCache.status===window.applicationCache.DOWNLOADING}}}(),indexeddbhelper=function(){var a=null,c=["initializationData","localStorage","otherData"],f=null,b=null,k=Class.extend({init:function(h){this._name=h},write:function(h,l,d){if(d===
undefined)d=null;a.transaction([this._name],"readwrite").objectStore(this._name).put(l,h).onsuccess=function(){d!==null&&d()}},read:function(h,l){a.transaction([this._name]).objectStore(this._name).get(h).onsuccess=function(d){l(d.target.result)}},writeJSON:function(h,l,d){l=JSON.stringify(l);this.write(h,l,d)},readJSON:function(h,l){this.read(h,function(d){d=d!==undefined?JSON.parse(d):undefined;l(d)})},writeJSONWithTimestamp:function(h,l,d){var g=this;this.writeJSON(h,l,function(){var j=datetime.getCurrentTimeInMS();
g.write(h+"__writeTimestamp",j,d)})},readJSONWithTimestamp:function(h,l){var d=this;this.readJSON(h,function(g){g===undefined?l(g,null):d.read(h+"__writeTimestamp",function(j){if(j===undefined)j=0;l(g,j)})})},readAll:function(h){var l={};a.transaction([this._name]).objectStore(this._name).openCursor().onsuccess=function(d){d=d.target.result;if(d===undefined||d===null)h(l);else{l[d.key]=d.value;d["continue"]()}}},remove:function(h,l){if(l===undefined)l=null;a.transaction([this._name],"readwrite").objectStore(this._name)["delete"](h).onsuccess=
function(){l!==null&&l()}},clear:function(h){if(h===undefined)h=null;a.transaction([this._name],"readwrite").objectStore(this._name).clear().onsuccess=function(){h!==null&&h()}}}),m=Class.extend({init:function(h){this._cachedKeyArray=this.length=this._keysToValues=null;var l=this;f.localStorage.readAll(function(d){l._keysToValues=d;l.length=utils.objectSize(d);h()})},setItem:function(h,l){h=String(h);l=String(l);h in this._keysToValues||this.length++;this._keysToValues[h]=l;f.localStorage.write(h,
l)},getItem:function(h){h=String(h);return h in this._keysToValues?this._keysToValues[h]:null},removeItem:function(h){h=String(h);if(h in this._keysToValues){this.length--;delete this._keysToValues[h];f.localStorage.remove(h)}},key:function(h){if(h===0)this._cachedKeyArray=utils.objectPropertyNames(this._keysToValues);if(h<0||h>=this._cachedKeyArray.length)return null;return this._cachedKeyArray[h]},clear:function(){this._keysToValues={};this.length=0;f.localStorage.clear()}});return{open:function(h){var l=
indexedDB.open("workflowy",1);l.onupgradeneeded=function(d){d=d.target.result;for(var g=0;g<c.length;g++)d.createObjectStore(c[g])};l.onsuccess=function(d){a=d.target.result;a.onerror=function(j){throw Error("IndexedDB database error: "+j.target.errorCode);};f={};for(d=0;d<c.length;d++){var g=c[d];f[g]=new k(g)}b=new m(function(){h()})};l.onerror=function(){throw Error("Error opening IndexedDB database.");}},getLocalStorageAdapter:function(){return b},getStores:function(){return f}}}(),dom_utils=
function(){function a(h){var l=[];if(h.nodeType===Node.TEXT_NODE)l.push(h);else{h=h.childNodes;for(var d=0,g=h.length;d<g;d++)l.push.apply(l,a(h[d]))}return l}function c(h,l,d){var g=h===l;if(h.nodeType===Node.TEXT_NODE)return g?{text:h.nodeValue.substring(0,d),containsBeforeContainer:true}:{text:h.nodeValue,containsBeforeContainer:false};else{h=h.childNodes;for(var j=g?d:h.length,o=false,n="",q=0;q<j;q++){var r=c(h[q],l,d);n+=r.text;if(r.containsBeforeContainer){o=true;break}}return{text:n,containsBeforeContainer:g||
o}}}function f(h){h=a(h);for(var l="",d=0;d<h.length;d++)l+=h[d].nodeValue;return l}var b=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame;if(b===undefined)b=function(h){h()};var k=IS_IE?function(h){return f(h)}:function(h){var l=document.createRange();l.selectNodeContents(h);return l.toString()},m=IS_IE?function(h){var l=document.body.createTextRange();l.moveToElementText(h);return l.text.replace(/\r\n/g,"\n")}:function(h){var l=
window.getSelection();l.selectAllChildren(h);h=l.toString();l.removeAllRanges();return h};jQuery.fn.getCaret=IS_IE?function(){var h=this[0],l=window.getSelection().getRangeAt(0),d=c(h,l.startContainer,l.startOffset).text;h=l.collapsed?d:c(h,l.endContainer,l.endOffset).text;return{start:d.length,end:h.length}}:function(){var h=this[0],l=window.getSelection().getRangeAt(0),d=l.cloneRange();d.selectNodeContents(h);d.setEnd(l.startContainer,l.startOffset);h=d.toString().length;l=h+l.toString().length;
return{start:h,end:l}};jQuery.fn.setCaret=function(h,l,d){if(l===undefined)l=h;if(d===undefined)d=null;if(!animations.animationsAreInProgress())if(!READ_ONLY_MAIN_TREE){var g=$(this);IS_IOS&&g.attr("contenteditable")===undefined&&g.attr("contenteditable","true");var j=null;if(d==="doNotScroll"||d==="doNotScrollIfOnScreen"&&g.isOnScreen()){var o=$(window);j=o.scrollTop()}g.focus();j!==null&&o.scrollTop(j);d=g[0];j=null;if(h===0&&l===0){h=document.createRange();h.setStart(d,0);h.setEnd(d,0);j=h}else{g=
content_text.getPlainTextForContent(g).length;h=h===-1?g:Math.min(h,g);l=l===-1?g:Math.min(l,g);h=h;g=l;l=document.createRange();l.selectNodeContents(d);j=a(d);o=false;for(var n=0,q,r=h===g,t=0,v;v=j[t++];){q=n+v.length;if(!o&&h>=n&&(h<q||r&&h===q)){l.setStart(v,h-n);o=true}if(o&&g<=q){l.setEnd(v,g-n);break}n=q}if(!o){h=d.childNodes.length;l.setStart(d,h);l.setEnd(d,h)}j=l}d=window.getSelection();d.removeAllRanges();d.addRange(j)}};jQuery.fn.getCaretForTextArea=function(){var h=$(this)[0];return{start:h.selectionStart,
end:h.selectionEnd}};jQuery.fn.setCaretForTextArea=function(h,l){if(l===undefined)l=h;var d=$(this),g=d[0];d.focus();g.setSelectionRange(h,l)};jQuery.fn.getContentCaretOffset=function(h){if(h===undefined)h=null;var l=$(this),d=l.isNote(),g=l.html(),j=l.getCaret();if(h===null)h=j.start;d=new content_text.ContentText(l,d);l.setContentHtml(d.getContentHtml(h));h=l.find(".contentCaret").offset();l.setContentHtml(g);l.setCaret(j.start,j.end);return h};jQuery.fn.isOnScreen=function(){var h=$(this),l=h.offset().top;
h=l+h.outerHeight();var d=$(window).scrollTop(),g=d+$(window).height();return l<g&&h>d};return{executeAfterRepaint:function(h){b(function(){b(h)})},clearSelection:function(){window.getSelection().removeAllRanges()},selectElementText:function(h){var l=window.getSelection(),d=document.createRange();d.selectNodeContents(h);l.removeAllRanges();l.addRange(d)},elementContainsSelection:function(h){var l=window.getSelection();if(l.rangeCount===0)return false;l=l.getRangeAt(0).commonAncestorContainer;return l===
h||$.contains($(h),$(l))},getInnerText:f,getElementText:k,getFormattedElementText:m,clearChildrenOfElement:function(h){for(;h.firstChild;)h.removeChild(h.firstChild)}}}(),content_text=function(){function a(u,A){for(var B="",E=1;u!==0;){if((u&1)!==0){var H=n[E].tag;if(A)B+="<"+H+">";else B="</"+H+">"+B}u>>=1;E<<=1}return B}function c(u,A){if(u===null)return A===null?null:A;else if(A===null)return u;for(var B=0;B<u.length;B++)u[B]|=A[B];return u}function f(u,A){if(u.nodeType===Node.TEXT_NODE)return utils.createArrayOfIdenticalElements(A,
u.nodeValue.length);else{var B=u.nodeName.toLowerCase();if(B==="parsererror")throw Error("Encountered parsererror");if(B in q)A|=q[B].flag;B=[];for(var E=u.childNodes,H=0;H<E.length;H++){var J=f(E[H],A);utils.pushArray(B,J)}return B}}function b(u,A,B,E,H){if(E===undefined)E=0;if(H===undefined)H=0;if(!A&&u.nodeType===Node.TEXT_NODE){E=E&~H;H=u.nodeValue;B.plainText+=H;utils.pushArray(B.formatFlagsForChars,utils.createArrayOfIdenticalElements(E,H.length))}else{if(!A){var J=u.className.split(" ");for(A=
0;A<J.length;A++){var L=J[A];if(L in r&&r[L].tag!==null)E|=r[L].flag}if(IS_IOS){A=u.nodeName.toLowerCase();if(A in q)E|=q[A].flag;A=u.style;if(A.fontWeight==="normal")H|=e;if(A.fontStyle==="normal")H|=p}}u=u.childNodes;A=0;for(J=u.length;A<J;A++)b(u[A],false,B,E,H)}}function k(u){return u.replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;")}function m(u,A,B,E,H){if(E===undefined)E=null;if(H===undefined)H=false;var J=null;if(search.inSearchMode())J=search.getSearchQuery().getMatchingChars(u,
g);B=c(J,B);var L=[];urls.forEachUrlInString(u,function(O,P,R){L.push({type:"url",spanStart:O,spanLength:P.length,urlContainsProtocol:R})});urls.forEachEmailAddressInString(u,function(O,P){L.push({type:"email",spanStart:O,spanLength:P.length})});tagging.forEachTagInString(u,function(O,P){L.push({type:"tag",spanStart:O,spanLength:P.length})},false);L.sort(function(O,P){if(O.spanStart==P.spanStart)return 0;return O.spanStart<P.spanStart?-1:1});J="";var K=0,N;for(N in L){var y=L[N],D=y.spanStart;if(!(D<
K)){J+=h(u,B,E,K,y.spanStart,H);K=D+y.spanLength;var G=u.substring(D,K);G=html_utils.htmlEscapeTextForContent(G);switch(y.type){case "url":G=G;y.urlContainsProtocol||(G="http://"+G);D=h(u,B,E,D,K,H);J+='<a class="contentLink" target="_blank" href="'+G+'">'+D+"</a>";break;case "email":D=h(u,B,E,D,K,H);J+='<a class="contentLink" target="_blank" href="mailto:'+G+'">'+D+"</a>";break;case "tag":var I=h(u,B,E,D,D+1,H);D=h(u,B,E,D+1,K,H);J+='<span class="contentTag" title="Filter '+G+'">'+I+'<span class="contentTagText">'+
D+"</span></span>"}K=y.spanStart+y.spanLength}}J+=h(u,B,E,K,u.length,H);if(A)J+="\n";return J}function h(u,A,B,E,H,J){if(A===null&&B===null)return html_utils.htmlEscapeTextForContent(u.substring(E,H));var L="";for(E=E;E<H;){var K=E,N;if(A!==null){N=A[E]|0;for(var y=N===0||!J?Number.MAX_VALUE:1;E<H&&E-K<y&&(A[E]|0)===N;)E++}else{N=0;E=H}y=E;if(B!==null&&B>=K&&B<y){K=u.substring(K,B);y=u.substring(B,y);K=html_utils.htmlEscapeTextForContent(K)+'<span class="contentCaretContainer"><span class="contentCaret"></span>'+
html_utils.htmlEscapeTextForContent(y.charAt(0))+"</span>"+html_utils.htmlEscapeTextForContent(y.substring(1))}else{K=u.substring(K,y);K=html_utils.htmlEscapeTextForContent(K)}if(N!==0){N=N;y="";for(var D=1,G=false;N!==0;){if((N&1)!==0){var I=n[D].contentClass;if(G)y+=" ";y+=I;G=true}N>>=1;D<<=1}L+='<span class="'+y+'">'+K+"</span>"}else L+=K}if(B!==null&&B===u.length&&H===u.length)L+='<span class="contentCaret"></span>';return L}for(var l=new window.DOMParser,d=/&|</,g=null,j="",o=[{tag:null,contentClass:"contentMatch"},
{tag:"b",contentClass:"contentBold"},{tag:"i",contentClass:"contentItalic"}],n={},q={},r={},t=0;t<o.length;t++){var v=o[t],x=Math.pow(2,t);v.flag=x;if(v.contentClass==="contentMatch")g=x;n[x]=v;if(v.tag!==null){q[v.tag]=v;j+=(j.length>0?", ":"")+"."+v.contentClass}r[v.contentClass]=v}var e=q.b.flag,p=q.i.flag,s=Class.extend({init:function(u){if(u===undefined)u=null;if(u!==null){this._formatFlags=u._formatFlags;this._setLocation=u._setLocation!==null?utils.copyObject(u._setLocation):null}else{this._formatFlags=
0;this._setLocation=null}},copy:function(){return new s(this)},isEmpty:function(){return this._formatFlags===0},boldIsSet:function(){return(this._formatFlags&e)!==0},italicIsSet:function(){return(this._formatFlags&p)!==0},clear:function(){this._formatFlags=0;this._setLocation=null},toggleBold:function(){this._formatFlags^=e},toggleItalic:function(){this._formatFlags^=p},setFormatFlagsSetLocation:function(u,A,B){if(B===undefined)B=false;var E=this._setLocation;u={projectReference:projecttree.getProjectReferenceFromDomProject(u.getProject()),
isNote:u.isNote(),caretPos:A};E=E!==null&&u.projectReference.equals(E.projectReference)&&u.isNote===E.isNote&&u.caretPos===E.caretPos;if(!E)this._formatFlags=0;this._setLocation=!E&&B?null:u},clearFormatFlagsSetLocationIfChanged:function(u,A){this.setFormatFlagsSetLocation(u,A,true)}}),w=Class.extend({init:function(u,A){if(u instanceof w){this._isForNote=u._isForNote;this._plainText=u._plainText;this._formatFlagsForChars=u._formatFlagsForChars}else{if(A===undefined)A=false;this._isForNote=A;if(typeof u===
"string")if(d.test(u)){var B=null;try{B=l.parseFromString("<root>"+u+"</root>","text/xml")}catch(E){B=null}var H=false;if(B!==null){var J=B.childNodes.length===1&&B.childNodes[0].nodeName.toLowerCase()==="root"?B.childNodes[0]:null,L=null;if(J!==null){H=true;try{var K=J.childNodes;L=K.length===1&&K[0].nodeType===Node.TEXT_NODE?null:f(J,0)}catch(N){H=false}}}if(H){this._plainText=dom_utils.getInnerText(J);this._formatFlagsForChars=L}else{this._plainText="";this._formatFlagsForChars=null}this._requiredParse=
true}else{this._plainText=u;this._formatFlagsForChars=null}else{L={plainText:"",formatFlagsForChars:[]};b(u[0],true,L);B=L.plainText;L=L.formatFlagsForChars;if(B.charAt(B.length-1)==="\n"){B=B.substring(0,B.length-1);L.splice(L.length-1,1)}this._plainText=B;this._formatFlagsForChars=L}}},requiredParse:function(){return this._requiredParse===true},containsFormatting:function(){if(this._formatFlagsForChars===null)return false;for(var u=0;u<this._formatFlagsForChars.length;u++)if(this._formatFlagsForChars[u]!==
0)return true;return false},getLines:function(){for(var u=[],A=0;A<this._plainText.length;){var B=this._plainText.indexOf("\n",A);if(B===-1)B=this._plainText.length;var E=this._plainText.substring(A,B);A=this._formatFlagsForChars!==null?this._formatFlagsForChars.slice(A,B):null;var H=this.copy();H._plainText=E;H._formatFlagsForChars=A;u.push(H);A=B+1}return u},getText:function(){if(this._formatFlagsForChars===null)return k(this._plainText);for(var u="",A=0,B=0;B<this._plainText.length;){for(var E=
B,H=this._formatFlagsForChars[E];B<this._plainText.length&&this._formatFlagsForChars[B]===H;)B++;var J=A&~H,L=H&~A,K=0;if(L!==0&&(A&~J)>L){for(var N=-2;(L&~N)===0;)N<<=1;K|=A&~J&N}if(J!==0&&(A&~J)>J){for(N=-2;(J&~N)===0;)N<<=1;K|=A&~J&N}J|=K;L|=K;if(J!==0)u+=a(J,false);if(L!==0)u+=a(L,true);A=this._plainText.substring(E,B);u+=k(A);A=H}if(A!==0)u+=a(A,false);return u},getContentHtml:function(u){if(u===undefined)u=null;return m(this._plainText,this._isForNote,this._formatFlagsForChars,u)},getContentHtmlWithSingleCharFormattingSpans:function(){return m(this._plainText,
this._isForNote,this._formatFlagsForChars,null,true)},getHtml:function(){return h(this._plainText,this._formatFlagsForChars,null,0,this._plainText.length,false)},getPlainText:function(){return this._plainText},isEmpty:function(){return this._plainText.length===0},copy:function(){return new w(this)},substring:function(u,A){var B=this.copy();B._plainText=B._plainText.substring(u,A);B._formatFlagsForChars=B._formatFlagsForChars!==null?B._formatFlagsForChars.slice(u,A):null;return B},concatenate:function(u){var A=
this.copy();if(A._formatFlagsForChars!==null||u._formatFlagsForChars!==null)A._formatFlagsForChars=(A._formatFlagsForChars||utils.createArrayOfIdenticalElements(0,A._plainText.length)).concat(u._formatFlagsForChars||utils.createArrayOfIdenticalElements(0,u._plainText.length));A._plainText+=u._plainText;return A},insertAtCaret:function(u,A){var B=this.copy();B._plainText=B._plainText.substring(0,A.start)+u+B._plainText.substring(A.end);if(B._formatFlagsForChars!==null){var E=A.start===0?0:B._formatFlagsForChars[A.start-
1];B._formatFlagsForChars=B._formatFlagsForChars.slice(0,A.start).concat(utils.createArrayOfIdenticalElements(E,u.length),B._formatFlagsForChars.slice(A.end))}return B},toggleBoldForCaret:function(u){this.toggleFormatFlagForCaret(e,u)},toggleItalicForCaret:function(u){this.toggleFormatFlagForCaret(p,u)},toggleFormatFlagForCaret:function(u,A){if(this._formatFlagsForChars===null)this._formatFlagsForChars=utils.createArrayOfIdenticalElements(0,this._plainText.length);for(var B=true,E=A.start;E<A.end;E++)if((this._formatFlagsForChars[E]&
u)===0){B=false;break}for(E=A.start;E<A.end;E++)if(B)this._formatFlagsForChars[E]&=~u;else this._formatFlagsForChars[E]|=u}});return{FormatFlags:s,ContentText:w,getContentHtml:function(u,A,B){if(B===undefined)B=null;return(new w(u,A)).getContentHtml(B)},getHtml:function(u){return(new w(u)).getHtml()},getPlainText:function(u){return(new w(u)).getPlainText()},getTextForContent:function(u){return(new w(u)).getText()},getPlainTextForContent:function(u){return(new w(u)).getPlainText()},createContentTextContainerFromPlainText:function(u,
A){return new w(k(u),A)},xmlEscapeTextForContentText:k,getContentClassesSelector:function(){return j}}}(),html_utils=function(){function a(c){return c.replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/\u00A0/g,"&nbsp;")}return{xmlEscapeText:function(c){return c.replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;").replace(/\n/g,"&#10;")},htmlEscapeTextForContent:a,htmlEscapeText:function(c){return a(c).replace(/"/g,"&quot;")}}}(),key_events=
function(){var a=["keydown","keyup","keypress"],c={8:"backspace",9:"tab",13:"return",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"insert",46:"del",91:"meta",93:"meta",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"*",107:"+",109:"-",111:"/",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",
144:"numlock",145:"scroll",186:";",188:",",190:".",191:"/",219:"[",221:"]",222:"'",224:"meta"},f={"`":"~","1":"!","2":"@","3":"#","4":"$","5":"%","6":"^","7":"&","8":"*","9":"(","0":")","-":"_","=":"+",";":": ","'":'"',",":"<",".":">","/":"?","\\":"|","[":"{","]":"}"},b=Class.extend({init:function(k,m){function h(j){function o(n){return l.handleEvent(this,j,n,arguments)}m?k.bind(j,o):k.live(j,o)}if(m===undefined)m=false;var l=this;this._useBind=m;this._boundHandlers={};for(var d=0;d<a.length;d++){var g=
a[d];this._boundHandlers[g]={};h(g)}},handleEvent:function(k,m,h,l){m=this._boundHandlers[m];var d=h.type!=="keypress"&&h.which in c?c[h.which]:null,g=String.fromCharCode(h.which).toLowerCase(),j="";if(h.altKey&&d!=="alt")j+="alt+";if(h.ctrlKey&&d!=="ctrl")j+="ctrl+";if(h.metaKey&&!h.ctrlKey&&d!=="meta")j+="meta+";if(h.shiftKey&&d!=="shift")j+="shift+";h={};if(d!==null)h[j+d]=true;else{h[j+g]=true;h[j+f[g]]=true;if(j==="shift+")h[f[g]]=true}d=false;for(var o in m)if(o in h){g=m[o];for(j=0;j<g.length;j++){var n=
g[j].apply(k,l);d|=n===false}}if(d)return false},addHandler:function(k,m,h){m=m.toLowerCase();k=this._boundHandlers[k];if(m in k)k[m].push(h);else k[m]=[h]},addHandlerForShortcuts:function(k,m,h,l){for(var d=0;d<h.length;d++)this.addHandler(k,h[d]+"+"+m,l)}});return{enableKeyEvents:function(k,m){return new b(k,m)}}}(),animations=function(){var a={zoom:150,children:100,pageSlide:400},c=new (Class.extend({init:function(){this._animationsInProgress=0;this._callbacks=[];this._contentToFocus=null;this._caretPos=
0},setContentToFocus:function(f){this._contentToFocus=f},setCaretPos:function(f){this._caretPos=f},addCallback:function(f){this._callbacks.push(f)},increment:function(){this._animationsInProgress++},decrement:function(){this._animationsInProgress--;if(this._animationsInProgress===0)this.animationsComplete();else this._animationsInProgress<0&&ui_sugar.showAlertDialog("Less than zero animations!")},animationsAreInProgress:function(){return this._animationsInProgress>0},animationsComplete:function(){$.each(this._callbacks,
function(k,m){m()});this._callbacks=[];var f=this._contentToFocus,b=this._caretPos;this._contentToFocus=null;this._caretPos=0;setTimeout(function(){IS_MOBILE||f!==null&&f.setCaret(b)},0)}}));jQuery.fn.incrementAnimationCounter=function(){$(this).each(function(){c.increment()});$(this).length===0&&!c.animationsAreInProgress()&&c.animationsComplete();return this};return{getAnimationTiming:function(f){return a[f]},setAnimationTiming:function(f,b){a[f]=b},getAnimationSpeed:function(f){if(NO_ANIMATIONS)return"instant";
if(f===undefined)return"animate";return f},animationsAreInProgress:function(){return c.animationsAreInProgress()},getAnimationCounter:function(){return c}}}(),projecttreeobject=function(){function a(q){return l in q}function c(q){return a(q)?q[l]:""}function f(q){return d in q}function b(q){return f(q)?q[d]:""}function k(q){if(a(q)){var r=new content_text.ContentText(c(q),false);if(r.requiredParse()){q[j]=r;return}}delete q[j]}function m(q){if(f(q)){var r=new content_text.ContentText(b(q),true);if(r.requiredParse()){q[o]=
r;return}}delete q[o]}function h(q){return g in q?q[g]:null}var l="nm",d="no",g="as",j="name_ct",o="note_ct",n={};n[l]="(removed by owner)";n.ch=[];return{create:function(q,r,t,v,x){if(r===undefined)r=null;if(t===undefined)t=null;if(v===undefined)v=null;if(x===undefined)x=null;var e={};e.id=q;if(r!==null)e[l]=r;if(t!==null)e[d]=t;if(v!==null)e.cp=v;if(x!==null)e.ch=x;return e},initialize:function(q,r){if(r.isAuxiliary())q.pt=r;"ch"in q||(q.ch=[]);k(q);m(q);q.tag_mgr=new tagging.ItemTagManager(q);
if("shared"in q){q.shared_info=new sharing.ItemSharedInfo(q.shared);delete q.shared}},getProjectId:function(q){return q.id},setProjectId:function(q,r){q.id=r},hasName:a,getName:c,setName:function(q,r){q[l]=r},hasNote:f,getNote:b,setNote:function(q,r){q[d]=r},isCompleted:function(q){return"cp"in q},getCompleted:function(q){return"cp"in q?q.cp:false},setCompleted:function(q,r){if(r===false)delete q.cp;else q.cp=r},getLastModified:function(q){return q.lm},setLastModified:function(q,r){q.lm=r},getSharedInfo:function(q){return"shared_info"in
q?q.shared_info:null},setSharedInfo:function(q,r){if(r===null)delete q.shared_info;else q.shared_info=r},getChildren:function(q){return q.ch},setChildren:function(q,r){q.ch=r},getParent:function(q){return q.pa},setParent:function(q,r){q.pa=r},updateNameContentText:k,updateNoteContentText:m,getNameInPlainText:function(q){return j in q?q[j].getPlainText():c(q)},getNoteInPlainText:function(q){return o in q?q[o].getPlainText():b(q)},getTagManager:function(q){return q.tag_mgr},hasSearchResult:function(q){return"search_result"in
q},getSearchResult:function(q){return"search_result"in q?q.search_result:null},setSearchResult:function(q,r){q.search_result=r},clearSearchResult:function(q){delete q.search_result},getProjectTree:function(q){return"pt"in q?q.pt:projecttree.getMainProjectTree()},isAddedSubtreePlaceholder:function(q){return h(q)!==null},getAddedSubtreeProjectId:h,setAddedSubtreeProjectId:function(q,r){q[g]=r},getAddedSubtree:function(q){return"added_subtree"in q?q.added_subtree:null},setAddedSubtree:function(q,r){q.added_subtree=
r},isInDom:function(q){return"in_dom"in q?q.in_dom:false},setInDom:function(q,r){if(r)q.in_dom=true;else delete q.in_dom},isExpandedInDom:function(q){return"is_expanded_in_dom"in q?q.is_expanded_in_dom:null},setIsExpandedInDom:function(q,r){if(r===null)delete q.is_expanded_in_dom;else q.is_expanded_in_dom=r},DANGLING_PLACEHOLDER_PROJECT_TREE_OBJECT:n}}(),globalprojecttreeobject=function(){function a(b){if(projecttreeobject.isAddedSubtreePlaceholder(b)){b=projecttreeobject.getAddedSubtree(b);return b!==
null?b.getRootProject():projecttreeobject.DANGLING_PLACEHOLDER_PROJECT_TREE_OBJECT}else return b}function c(b){if(projecttreeobject.isAddedSubtreePlaceholder(b)){b=projecttreeobject.getAddedSubtree(b);b!==null&&b.notifyContentsAreVisibleMayHaveChanged()}}function f(b){return b.join("")+'<div class="childrenEnd"></div>'}return{getProjectId:function(b){return projecttree.getProjectIdOfProjectTreeObject(b)},getProjectTree:function(b){return b===null?projecttree.getMainProjectTree():projecttreeobject.getProjectTree(b)},
hasName:function(b){return projecttreeobject.hasName(a(b))},getName:function(b){return projecttreeobject.getName(a(b))},setName:function(b,k){projecttreeobject.setName(a(b),k)},hasNote:function(b){return projecttreeobject.hasNote(a(b))},getNote:function(b){return projecttreeobject.getNote(a(b))},setNote:function(b,k){projecttreeobject.setNote(a(b),k)},isCompleted:function(b){return projecttreeobject.isCompleted(a(b))},getCompleted:function(b){return projecttreeobject.getCompleted(a(b))},setCompleted:function(b,
k){projecttreeobject.setCompleted(a(b),k)},getLastModified:function(b){return projecttreeobject.getLastModified(b)},setLastModified:function(b,k){projecttreeobject.setLastModified(b,k)},getSharedInfo:function(b){return projecttreeobject.getSharedInfo(a(b))},setSharedInfo:function(b,k){projecttreeobject.setSharedInfo(a(b),k)},getNameInPlainText:function(b){return projecttreeobject.getNameInPlainText(b)},getNoteInPlainText:function(b){return projecttreeobject.getNoteInPlainText(b)},getTagManager:function(b){return projecttreeobject.getTagManager(b)},
hasSearchResult:function(b){return projecttreeobject.hasSearchResult(b)},getSearchResult:function(b){b=projecttreeobject.getSearchResult(b);return b!==null?b:search.getNonMatchItemSearchResult()},setSearchResult:function(b,k){projecttreeobject.setSearchResult(b,k)},clearSearchResult:function(b){projecttreeobject.clearSearchResult(b)},getAddedSubtreeProjectId:function(b){return projecttreeobject.getAddedSubtreeProjectId(b)},isInDom:function(b){return b===null?true:projecttreeobject.isInDom(b)},setInDom:function(b,
k){projecttreeobject.setInDom(b,k);c(b)},isExpandedInDom:function(b){return projecttreeobject.isExpandedInDom(b)},setIsExpandedInDom:function(b,k){projecttreeobject.setIsExpandedInDom(b,k);c(b)},getChildren:function(b){if(b===null)return projecttree.getMainProjectTree().getRootProjectChildren();if(projecttreeobject.isAddedSubtreePlaceholder(b)){b=projecttreeobject.getAddedSubtree(b);return b!==null?b.getRootProjectChildren():projecttreeobject.getChildren(projecttreeobject.DANGLING_PLACEHOLDER_PROJECT_TREE_OBJECT)}else return projecttreeobject.getChildren(b)},
getParent:function(b){var k=projecttreeobject.getParent(b);if(k!==null)return k;else{b=globalprojecttreeobject.getProjectTree(b);return b.isAuxiliary()?projecttree.getMainProjectTree().getSharedSubtreePlaceholder(b.getRootProjectId()):null}},getSiblings:function(b){if(b===null)return[null];b=globalprojecttreeobject.getParent(b);return globalprojecttreeobject.getChildren(b)},isReadOnly:function(b){return READ_ONLY_MAIN_TREE||b===null||projecttreeobject.isAddedSubtreePlaceholder(b)||globalprojecttreeobject.isInReadOnlyTree(b)},
isInReadOnlyTree:function(b){return b!==null&&projecttreeobject.getProjectTree(b).isReadOnly()},getProjectReference:function(b){return(b===null?projecttree.getMainProjectTree():globalprojecttreeobject.getProjectTree(b)).getProjectReferenceByProjectTreeObject(b)},isExpanded:function(b){return globalprojecttreeobject.getProjectTree(b).projectIdIsExpanded(globalprojecttreeobject.getProjectId(b))},isAddedSubtreePlaceholder:function(b){return b!==null&&projecttreeobject.isAddedSubtreePlaceholder(b)},isPotentiallyVisible:function(b,
k){if(k===undefined)k=false;var m=shouldShowCompletedProjects(),h=false;if(!globalprojecttreeobject.isCompleted(b)||m)if(!k&&search.inSearchMode()){h=globalprojecttreeobject.getProjectReference(b);h=!globalprojecttreeobject.getSearchResult(b).isNeverVisibleForSearch(h,m)}else h=true;return h},getPotentiallyVisibleChildren:function(b,k){if(k===undefined)k=false;for(var m=globalprojecttreeobject.getChildren(b),h=[],l=0;l<m.length;l++){var d=m[l];globalprojecttreeobject.isPotentiallyVisible(d,k)&&h.push(d)}return h},
getPreviousPotentiallyVisibleSibling:function(b,k){for(var m=globalprojecttreeobject.getSiblings(b),h=utils.indexInArray(m,b)-1;h>=0;h--){var l=m[h];if(globalprojecttreeobject.isPotentiallyVisible(l,k))return l}return null},getNextPotentiallyVisibleSibling:function(b,k){for(var m=globalprojecttreeobject.getSiblings(b),h=utils.indexInArray(m,b)+1;h<m.length;h++){var l=m[h];if(globalprojecttreeobject.isPotentiallyVisible(l,k))return l}return null},getTreeForChildren:function(b){return b===null?projecttree.getMainProjectTree():
projecttreeobject.isAddedSubtreePlaceholder(b)?projecttreeobject.getAddedSubtree(b):projecttreeobject.getProjectTree(b)},childrenAreInReadOnlyTree:function(b){b=globalprojecttreeobject.getTreeForChildren(b);return b!==null?b.isReadOnly():true},constructProjectTreeAsSelected:function(b,k){if(k===undefined)k=true;var m=selectOnActivePage(".mainTreeRoot");m.overwriteProjectChildrenHtml(function(){var h=[];if(k){var l=globalprojecttreeobject.getChildren(b),d;for(d in l)h.push(globalprojecttreeobject.constructProjectTreeHtml(l[d]))}l=
true;d=b;for(h=h;d!==null;){h=[globalprojecttreeobject.constructProjectTreeHtml(d,h,l?"selected":"parent")];d=globalprojecttreeobject.getParent(d);l=false}return f(h)});m.removeClass("selected").removeClass("parent");b===null?m.addClass("selected"):m.addClass("parent");if(k){m=selectOnActivePage(".addButton");globalprojecttreeobject.childrenAreInReadOnlyTree(b)?m.addClass("selectedTreeIsReadOnly"):m.removeClass("selectedTreeIsReadOnly");refreshVisibleChildrenUnderSelectedForAddButton(m)}},constructProjectTreeHtml:function(b,
k,m){if(k===undefined)k=null;if(m===undefined)m="";var h=globalprojecttreeobject.getProjectReference(b),l=globalprojecttreeobject.getProjectId(b),d=globalprojecttreeobject.getName(b),g=globalprojecttreeobject.getNote(b),j=globalprojecttreeobject.isCompleted(b),o=globalprojecttreeobject.getSharedInfo(b)!==null,n=globalprojecttreeobject.isAddedSubtreePlaceholder(b),q=globalprojecttreeobject.getChildren(b),r=shouldShowCompletedProjects();if(k===null)if(j&&!r||search.inSearchMode()&&globalprojecttreeobject.getSearchResult(b).isNeverVisibleForSearch(h,
r))return"";var t=false;if(q.length>0)t=search.inSearchMode()?globalprojecttreeobject.getSearchResult(b).isExpandedForSearch(h):globalprojecttreeobject.isExpanded(b);globalprojecttreeobject.setInDom(b,true);globalprojecttreeobject.setIsExpandedInDom(b,k!==null||t);var v=r="",x="";if(q.length===0)r+="task ";if(j)r+="done ";if(g!=="")r+="noted ";if(o)r+="shared ";if(n)r+="addedShared ";if(t)r+="open ";r+=m+" ";if(search.inSearchMode()){h=globalprojecttreeobject.getSearchResult(b).getAdditionalClassesForSearch(h);
r+=h.project+" ";v+=h.name+" ";x+=h.note+" "}k=k!==null?k:t?globalprojecttreeobject.constructChildProjectTreeHtmls(b):[];m=!IS_IOS&&!READ_ONLY_MAIN_TREE&&m!=="parent"?" contenteditable":"";if(IS_MOBILE){h='<div class="bullet">&bull;<div></div></div>';j=""}else{h='<a class="bullet"'+(IS_CHROME_APP?"":' href="'+window.location.pathname+"#/"+l+'"')+">&bull;</a>";j='<div class="dropTarget"></div>'}b=globalprojecttreeobject.getProjectTree(b);b=b.isAuxiliary()?' data-tid="'+b.getTreeId()+'"':"";return'<div class="project '+
r+'" projectid="'+l+'"'+b+">"+j+'<div class="highlight"></div><div class="name '+v+'">'+h+'<div class="content"'+m+">"+content_text.getContentHtml(d,false)+'</div><span class="parentArrow"></span></div><div class="notes '+x+'"><div class="content"'+m+">"+content_text.getContentHtml(g,true)+'</div></div><div class="children">'+f(k)+"</div></div>"},constructChildProjectTreeHtmls:function(b){b=globalprojecttreeobject.getChildren(b);for(var k=[],m=0;m<b.length;m++)k.push(globalprojecttreeobject.constructProjectTreeHtml(b[m]));
return k},constructChildren:f,registerSubtreeRemovedFromDom:function(b,k){if(k===undefined)k=false;if(!k){if(!globalprojecttreeobject.isInDom(b))return;globalprojecttreeobject.setInDom(b,false);globalprojecttreeobject.setIsExpandedInDom(b,null)}for(var m=globalprojecttreeobject.getChildren(b),h=0;h<m.length;h++)globalprojecttreeobject.registerSubtreeRemovedFromDom(m[h])},generateExportData:function(b,k){function m(n,q,r,t,v,x){if(x===undefined)x=true;if(x){var e=new content_text.ContentText(globalprojecttreeobject.getName(q),
false),p=new content_text.ContentText(globalprojecttreeobject.getNote(q),true),s=globalprojecttreeobject.isCompleted(q),w=e.getPlainText(),u=p.getPlainText(),A=e.getHtml(),B=p.getHtml();e=html_utils.xmlEscapeText(e.getText());p=html_utils.xmlEscapeText(p.getText());A=$("<span />").addClass("name").html(A);if(r>0)h+=t+"- ";l+="<outline ";if(s){A.addClass("done");h+="[COMPLETE] ";l+='_complete="true" '}n.append(A);h+=w+"\n";if(r==0)h+="\n";l+='text="'+e+'" ';if(u!=""){s=$("<span />").addClass("note").html(B);
n.append(r>0?$("<br />"):$("<br /><br />"));n.append(s);s=r>0?t+"  ":"";u=s+'"'+u.replace(/\n/g,"\n"+s)+'"\n';h+=u;if(r==0)h+="\n";l+='_note="'+p+'" '}}q=globalprojecttreeobject.getPotentiallyVisibleChildren(q,v);if(q.length>0){if(x)l+=">";u=$("<ul />");r=r+1;t=r>1?t+d:t;for(p=0;p<q.length;p++){s=q[p];w=$("<li />");m(w,s,r,t,v);u.append(w)}n.append(u);if(x)l+="</outline>"}else if(x)l+="/>"}var h="",l="",d="  ",g=b!==null,j=$("<div />");m(j,b,0,"",k,g);g=$("<pre />").text(h);var o='<?xml version="1.0"?><opml version="2.0"><head><ownerEmail>'+
html_utils.xmlEscapeText(SETTINGS.email.value)+"</ownerEmail></head><body>"+l+"</body></opml>";o=vkbeautify.xml(o,2);o=$("<pre />").text(o);return{htmlContainer:j,textContainer:g,opmlContainer:o}},duplicateProjectTreeForBulkCreate:function(b,k){if(k===undefined)k=true;var m={};globalprojecttreeobject.hasName(b)&&projecttreeobject.setName(m,globalprojecttreeobject.getName(b));globalprojecttreeobject.hasNote(b)&&projecttreeobject.setNote(m,globalprojecttreeobject.getNote(b));globalprojecttreeobject.isCompleted(b)&&
projecttreeobject.setCompleted(m,true);k&&projecttreeobject.setName(m,projecttreeobject.getName(m)+" (copy)");if(globalprojecttreeobject.isExpanded(b))m.expanded=true;var h=globalprojecttreeobject.getChildren(b);if(h.length>0){for(var l=[],d=0;d<h.length;d++){var g=globalprojecttreeobject.duplicateProjectTreeForBulkCreate(h[d],false);l.push(g)}projecttreeobject.setChildren(m,l)}return m}}}(),projecttree=function(){function a(e,p){if(p===undefined)p=false;var s=String(j);j++;var w=new v(e,s);g[s]=
w;p||k().registerAddedAuxiliaryProjectTree(w)}function c(e){for(var p=new tagging.TagCounter,s=globalprojecttreeobject.getChildren(e),w=0;w<s.length;w++){var u=c(s[w]);p.add(u)}if(e===null){tagging.setRootDescendantTagCounts(p);return p}else{e=globalprojecttreeobject.getTagManager(e);p.isEmpty()||e.setDescendantTagCounts(p);s=new tagging.TagCounter;s.add(e.getTagCounts());s.add(p);return s}}function f(e){return e in g?g[e]:null}function b(e,p){if(p===undefined)p=g;for(var s in p){var w=p[s];if(w.getRootProjectId()===
e)return w}return null}function k(){return g[d]}function m(e,p){for(var s={},w=0;w<e.length;w++){var u=e[w],A=globalprojecttreeobject.getProjectId(u);u=globalprojecttreeobject.getProjectTree(u).getTreeId();u in s||(s[u]=[]);s[u].push(A)}for(u in s)f(u).setExpandedForProjectIds(s[u],p)}function h(e){return e!==null?projecttreeobject.getProjectId(e):n}function l(){if(q===null)q=new x;return q}var d="main",g={},j=0,o={},n="None",q=null,r=Class.extend({init:function(e){this.treeId=e},getProjectTree:function(){return f(this.treeId)}}),
t=Class.extend({init:function(e,p){this.projectid=e;this.treeId=p},isValid:function(){return this.getProjectTree()!==null&&this.getProjectTreeObject()!==undefined},getProjectId:function(){return this.projectid},getProjectTreeObject:function(){return this.getProjectTree().getProjectTreeObjectByProjectId(this.projectid)},getProjectTree:function(){return f(this.treeId)},equals:function(e){return this.treeId===e.treeId&&this.projectid===e.projectid},isTreeRoot:function(){return this.projectid===n},isMainTreeRoot:function(){return this.treeId===
d&&this.isTreeRoot()},getUniqueIdentifier:function(){return this.treeId+":"+this.projectid},getName:function(){var e=this.getProjectTreeObject();return e!==null?globalprojecttreeobject.getName(e):null},getNote:function(){var e=this.getProjectTreeObject();return e!==null?globalprojecttreeobject.getNote(e):null},getSharedInfo:function(){var e=this.getProjectTreeObject();return e!==null?globalprojecttreeobject.getSharedInfo(e):null},getTagManager:function(){var e=this.getProjectTreeObject();return e!==
null?globalprojecttreeobject.getTagManager(e):null},getSharedUrl:function(){return"https://workflowy.com/shared/"+(this.isAddedSubtreePlaceholder()?globalprojecttreeobject.getAddedSubtreeProjectId(this.getProjectTreeObject()):this.projectid)+"/"},translateToGlobalProjectTreeObject:function(){if(this.projectid===n){var e=this.getProjectTree();if(e===null)return;if(e.isAuxiliary())return k().getSharedSubtreePlaceholder(e.getRootProjectId())}return this.getProjectTreeObject()},getPlaceholderReferenceIfApplicable:function(){var e=
this.translateToGlobalProjectTreeObject();return globalprojecttreeobject.getProjectReference(e)},getNonPlaceholderReferenceIfApplicable:function(){if(!this.isAddedSubtreePlaceholder())return this;var e=this.getProjectTreeObject();e=projecttreeobject.getAddedSubtree(e);return e!==null?e.getRootProjectReference():null},getMatchingDomProject:function(){var e=this.translateToGlobalProjectTreeObject();if(e!==undefined){if(!globalprojecttreeobject.isInDom(e))return $();var p=globalprojecttreeobject.getProjectTree(e).getTreeId();
e=globalprojecttreeobject.getProjectId(e)}else{if(this.projectid===n)return $();p=this.treeId;e=this.projectid}return selectOnActivePage(".project[projectid="+e+"]"+(p===d?":not([data-tid])":"[data-tid="+p+"]"))},getAncestors:function(){for(var e=this.getProjectTreeObject(),p=[];e!==null;){e=globalprojecttreeobject.getParent(e);p.push(globalprojecttreeobject.getProjectReference(e))}return p},isReadOnly:function(){return globalprojecttreeobject.isReadOnly(this.getProjectTreeObject())},isInReadOnlyTree:function(){return globalprojecttreeobject.isInReadOnlyTree(this.getProjectTreeObject())},
isAddedSubtreePlaceholder:function(){return globalprojecttreeobject.isAddedSubtreePlaceholder(this.getProjectTreeObject())},isInSameTree:function(e){return this.treeId===e.treeId},childrenAreInSameTree:function(e){var p=this.getProjectTreeObject();p=globalprojecttreeobject.getTreeForChildren(p);return p!==null?p.getTreeId()===e.treeId:false},childrenAreInReadOnlyTree:function(){return globalprojecttreeobject.childrenAreInReadOnlyTree(this.getProjectTreeObject())},getShareTypeForTreeForChildren:function(){var e=
this.getProjectTreeObject();e=globalprojecttreeobject.getTreeForChildren(e);return e.isShared()?e.getShareType():null},isDescendantOf:function(e){var p=this.getAncestors(),s=false;$.each(p,function(w,u){if(e.equals(u)){s=true;return false}});return s},isValidMove:function(e){if(e.is(".project")){e=projecttree.getProjectReferenceFromDomProject(e);if(!e.isInSameTree(this))return false;if(this.isAddedSubtreePlaceholder()&&e.hasSharedAncestor())return false;if(e.isDescendantOf(this))return false}else{e=
e.getProject();e=projecttree.getProjectReferenceFromDomProject(e);if(!e.childrenAreInSameTree(this))return false;if(this.isAddedSubtreePlaceholder()&&e.hasSharedAncestor(true))return false;if(e.isDescendantOf(this)||e.equals(this))return false}return true},canCreateChild:function(){var e=this.getProjectTreeObject();e=globalprojecttreeobject.getTreeForChildren(e);return e!==null?!e.isReadOnly():false},hasSharedAncestor:function(e){if(e===undefined)e=false;if(e&&this.isAddedSubtreePlaceholder())return false;
return this.getProjectTree().projectTreeObjectHasSharedAncestor(this.getProjectTreeObject(),e)},hasAddedSubtreeDescendant:function(){return this.getProjectTree().projectTreeObjectHasAddedSubtreeDescendant(this.getProjectTreeObject())},constructProjectTreeAsSelected:function(e){globalprojecttreeobject.constructProjectTreeAsSelected(this.getProjectTreeObject(),e)},constructChildProjectTreeHtmls:function(){return globalprojecttreeobject.constructChildProjectTreeHtmls(this.getProjectTreeObject())},getChildren:function(){for(var e=
globalprojecttreeobject.getChildren(this.getProjectTreeObject()),p=[],s=0;s<e.length;s++)p.push(globalprojecttreeobject.getProjectReference(e[s]));return p},getPotentiallyVisibleChildren:function(){for(var e=globalprojecttreeobject.getPotentiallyVisibleChildren(this.getProjectTreeObject()),p=[],s=0;s<e.length;s++){var w=globalprojecttreeobject.getProjectReference(e[s]);p.push(w)}return p},getPreviousPotentiallyVisibleSibling:function(e){e=globalprojecttreeobject.getPreviousPotentiallyVisibleSibling(this.getProjectTreeObject(),
e);return e!==null?globalprojecttreeobject.getProjectReference(e):null},getNextPotentiallyVisibleSibling:function(e){e=globalprojecttreeobject.getNextPotentiallyVisibleSibling(this.getProjectTreeObject(),e);return e!==null?globalprojecttreeobject.getProjectReference(e):null},setTitleAndFragmentPathForProject:function(){var e=this.getProjectTreeObject(),p=true;if(e===null){e=this.getProjectTree();if(e.isShared())e=content_text.getPlainText(e.getName());else{e="Organize your brain.";p=false}}else e=
content_text.getPlainText(globalprojecttreeobject.getName(e));if(e.length>100)e=e.substring(0,100)+"...";document.title=p?e+" - WorkFlowy":"WorkFlowy - "+e;location_history.notifyZoomChange(this.projectid)},setExpanded:function(e){this.getProjectTree().setExpandedForProjectIds([this.projectid],e)},isExpanded:function(){return globalprojecttreeobject.isExpanded(this.getProjectTreeObject())},expandOrCollapseAllDescendants:function(e){function p(A){var B=globalprojecttreeobject.getChildren(A);if(B.length>
0){w.push(A);for(A=0;A<B.length;A++)p(B[A])}}var s=this.getProjectTreeObject(),w=[];s=globalprojecttreeobject.getChildren(s);for(var u=0;u<s.length;u++)p(s[u]);m(w,e)},getLastModifiedDateString:function(){var e=this.getProjectTreeObject();e=globalprojecttreeobject.getLastModified(e);return this.getProjectTree().clientTimestampToString(e)},getCompletedDateString:function(){var e=this.getProjectTreeObject();e=globalprojecttreeobject.getCompleted(e);return e===false?null:this.getProjectTree().clientTimestampToString(e)},
getPriority:function(){var e=this.getProjectTreeObject(),p=globalprojecttreeobject.getSiblings(e);return utils.indexInArray(p,e)},generateExportData:function(e){return globalprojecttreeobject.generateExportData(this.getProjectTreeObject(),e)},duplicateProjectTreeForBulkCreate:function(){return globalprojecttreeobject.duplicateProjectTreeForBulkCreate(this.getProjectTreeObject())},registerSubtreeRemovedFromDom:function(e){globalprojecttreeobject.registerSubtreeRemovedFromDom(this.getProjectTreeObject(),
e)},setIsExpandedInDom:function(e){globalprojecttreeobject.setIsExpandedInDom(this.getProjectTreeObject(),e)},applyLocalEdit:function(e,p){this.getProjectTree().applyLocalEdit(this.getProjectTreeObject(),e,p)},applyLocalCreateChild:function(e){var p=this.getParentReferenceForCreate();return p.getProjectTree().applyLocalCreateChild(p.getProjectTreeObject(),e)},applyLocalBulkCreateChildren:function(e,p){var s=this.getParentReferenceForCreate();return s.getProjectTree().applyLocalBulkCreateChildren(s.getProjectTreeObject(),
e,p)},getParentReferenceForCreate:function(){var e=this.getProjectTreeObject();if(e!==null&&projecttreeobject.isAddedSubtreePlaceholder(e)){e=projecttreeobject.getAddedSubtree(e);if(e!==null)return e.getProjectReferenceByProjectId(n);else throw Error("Trying to create child of dangling placeholder.");}else return this},applyLocalComplete:function(){this.getProjectTree().applyLocalComplete(this.getProjectTreeObject())},applyLocalUncomplete:function(){this.getProjectTree().applyLocalUncomplete(this.getProjectTreeObject())},
applyLocalDelete:function(e){this.getProjectTree().applyLocalDelete(this.getProjectTreeObject(),e)},applyLocalMove:function(e,p){var s=this.getProjectTree(),w=e.getProjectTreeObject();if(w!==null&&projecttreeobject.isAddedSubtreePlaceholder(w)){var u=projecttreeobject.getAddedSubtree(w);if(u!==null){if(u===s)w=null}else throw Error("Trying to move an item under a dangling placeholder.");}s.applyLocalMove(this.getProjectTreeObject(),w,p)},applyLocalShare:function(e,p){this.getProjectTree().applyLocalShare(this.getProjectTreeObject(),
e,p)},applyLocalUnshare:function(){this.getProjectTree().applyLocalUnshare(this.getProjectTreeObject())},applyLocalAddSharedEmail:function(e,p){this.getProjectTree().applyLocalAddSharedEmail(this.getProjectTreeObject(),e,p)},applyLocalRemoveSharedEmail:function(e){this.getProjectTree().applyLocalRemoveSharedEmail(this.getProjectTreeObject(),e)}}),v=Class.extend({init:function(e,p){this.treeId=p;this.isMainProjectTree=p===d;this.isDefunct=false;var s=e.rootProject;this.namespace="tree."+(s!==null?
projecttreeobject.getProjectId(s):d);this.rootProject=s;this.rootProjectChildren=e.rootProjectChildren;this.initialMostRecentOperationTransactionId=e.initialMostRecentOperationTransactionId;this.initialPollingIntervalInMs=e.initialPollingIntervalInMs;this.serverExpandedProjectsList=e.serverExpandedProjectsList;this.readOnly=e.isReadOnly;this.dateJoinedTimestampInSeconds=e.dateJoinedTimestampInSeconds;if(this.rootProject!==null)this.overQuota=new userstorage.PersistentValue(this.namespace,"overQuota",
e.overQuota);else{this.itemsCreatedInCurrentMonth=new userstorage.PersistentValue(this.namespace,"itemsCreatedInCurrentMonth",e.itemsCreatedInCurrentMonth);this.monthlyItemQuota=new userstorage.PersistentValue(this.namespace,"monthlyItemQuota",e.monthlyItemQuota)}this.shareType="shareType"in e?e.shareType:null;this.isMainProjectTree?utils.debugMessage("Initializing main project tree."):utils.debugMessage("Initializing auxiliary project tree (id: "+p+") rooted at projectid: "+projecttreeobject.getProjectId(this.rootProject));
utils.debugMessage("Initial polling interval: "+this.initialPollingIntervalInMs+" ms");this.operationRunner=new operations.ProjectTreeOperationRunner(this);this.projectIdToProjectMap={};this.deletedProjectIdToProjectMap={};this.sharedSubtreePlaceholders={};this.expandedProjects={};this.localStorageExpandedProjects={};this.serverRunOperationTransactionQueue=new userstorage.PersistentOperationTransactionQueue(this.namespace,"server-run");this.pendingOperationQueue=new userstorage.PersistentOperationQueue(this.namespace,
"pending");this.inFlightOperationQueue=new userstorage.PersistentOperationQueue(this.namespace,"in-flight");this.pendingExpandedProjectsDelta=new userstorage.PersistentDict(this.namespace,"pendingExpandedProjectsDelta");this.inFlightExpandedProjectsDelta=new userstorage.PersistentDict(this.namespace,"inFlightExpandedProjectsDelta");this.mostRecentOperationTransactionId=new userstorage.PersistentValue(this.namespace,"mostRecentOperationTransactionId",this.initialMostRecentOperationTransactionId);this.pollingIntervalInMs=
new userstorage.PersistentValue(this.namespace,"pollingIntervalInMs",this.initialPollingIntervalInMs);this.pushPollInProgress=new userstorage.PersistentValue(this.namespace,"pushPollInProgress",false);this.mostRecentOperationTransactionIdWhenPushPollInitiated=new userstorage.PersistentValue(this.namespace,"mostRecentOperationTransactionIdWhenPushPollInitiated",null);this.lastPushPollCompleteTimestamp=new userstorage.PersistentValue(this.namespace,"lastPushPollCompleteTimestamp",datetime.getCurrentTimeInMS());
this.initializeProjectTree();FULL_OFFLINE_ENABLED&&this.initializeTreeStateFromUserstorage();this.initializeExpandedProjects()},getName:function(){return this.isShared()?projecttreeobject.getName(this.rootProject):"root"},isAuxiliary:function(){return!this.isMainProjectTree},isInGlobalTree:function(){return this.isAuxiliary()?k().getSharedSubtreePlaceholder(this.getRootProjectId())!==undefined:true},isShared:function(){return this.rootProject!==null},getShareType:function(){return this.shareType},
isReadOnly:function(){return READ_ONLY_MAIN_TREE||this.readOnly},getIsDefunct:function(){return this.isDefunct},makeDefunct:function(){this.isDefunct=true;k().registerRemovedAuxiliaryProjectTree(this);delete g[this.treeId];o[this.treeId]=this},isOverQuota:function(){return!this.isShared()?this.itemsCreatedInCurrentMonth.getValue()>this.monthlyItemQuota.getValue():this.overQuota.getValue()},getItemsCreatedInCurrentMonth:function(){return!this.isShared()?this.itemsCreatedInCurrentMonth.getValue():null},
getMonthlyItemQuota:function(){return!this.isShared()?this.monthlyItemQuota.getValue():null},localStorageKey:function(e){var p=this.getRootProjectId();return p===null?e:e+"-"+p},clientTimestampToString:function(e){return datetime.dateToDateTimeString(new Date((this.dateJoinedTimestampInSeconds+e*60)*1E3))},getCurrentClientTimestamp:function(){var e=datetime.getCurrentTimeInMS()/1E3-this.dateJoinedTimestampInSeconds;return Math.floor(e/60)},initializeProjectTree:function(){this.projectIdToProjectMap=
{};this.sharedSubtreePlaceholders={};for(var e=0;e<this.rootProjectChildren.length;e++)this.initializeProjectTreeSubtree(this.rootProjectChildren[e],null)},initializeProjectTreeSubtree:function(e,p){projecttreeobject.initialize(e,this);this.projectIdToProjectMap[projecttreeobject.getProjectId(e)]=e;projecttreeobject.setParent(e,p);var s=projecttreeobject.getAddedSubtreeProjectId(e);if(s!==null){this.registerAddedSharedSubtreePlaceholder(e);if(!this.isAuxiliary()&&!this.isShared()){s=b(s);s!==null&&
this.registerAddedAuxiliaryProjectTree(s)}}s=projecttreeobject.getChildren(e);for(var w=0;w<s.length;w++)this.initializeProjectTreeSubtree(s[w],e)},initializeTreeStateFromUserstorage:function(){var e=this.initialMostRecentOperationTransactionId==="None"?-1:parseInt(this.initialMostRecentOperationTransactionId),p,s=this.mostRecentOperationTransactionId.getValue();p=s==="None"?-1:parseInt(s);s=false;if(e>p){s=true;this.mostRecentOperationTransactionId.setValue(this.initialMostRecentOperationTransactionId)}p=
this.serverRunOperationTransactionQueue.getMostRecentOperationTransactionId();if(p!==null&&e>=p){utils.debugMessage("Clearing server-run queue because app cache project tree is at least as up-to-date.");this.serverRunOperationTransactionQueue.clear();p=null}if(this.operationRunner.reconstructTreeStateFromUserstorageOperations(this.serverRunOperationTransactionQueue.getMoreRecentOperationTransactions(e),s).errorEncountered){utils.debugMessage("Error encountered running operations in userstorage queues during initialization.");
throw new userstorage.InitializationError;}p!==null&&this.mostRecentOperationTransactionId.setValue(String(p));if(this.hasInFlightOperations()&&!this.pushPollIsInProgress())throw new userstorage.InitializationError;},registerAddedAuxiliaryProjectTree:function(e){var p=e.getRootProjectId();p in this.sharedSubtreePlaceholders&&projecttreeobject.setAddedSubtree(this.sharedSubtreePlaceholders[p],e)},registerRemovedAuxiliaryProjectTree:function(e){e=e.getRootProjectId();e in this.sharedSubtreePlaceholders&&
projecttreeobject.setAddedSubtree(this.sharedSubtreePlaceholders[e],null)},getSharedSubtreePlaceholder:function(e){return this.sharedSubtreePlaceholders[e]},registerAddedSharedSubtreePlaceholder:function(e){this.sharedSubtreePlaceholders[projecttreeobject.getAddedSubtreeProjectId(e)]=e},registerRemovedSharedSubtreePlaceholder:function(e){delete this.sharedSubtreePlaceholders[projecttreeobject.getAddedSubtreeProjectId(e)]},loadRefreshed:function(e){this.rootProjectChildren=e;this.initializeProjectTree()},
initializeExpandedProjects:function(){for(var e=0;e<this.serverExpandedProjectsList.length;e++){var p=this.serverExpandedProjectsList[e];this.expandedProjects[p]={expanded:true}}this.readLocalStorageExpandedProjects();for(p in this.localStorageExpandedProjects)this.expandedProjects[p]={expanded:this.localStorageExpandedProjects[p].expanded}},readLocalStorageExpandedProjects:function(){this.localStorageExpandedProjects={};var e=null;if(localstoragehelper.localStorageSupported()){e=this.localStorageKey("expanded");
e=localstoragehelper.read(e)}if(!(e===null||e.length===0)){e=e.split(",");for(var p in e){var s=e[p].split(":");this.localStorageExpandedProjects[s[0].substring(0,8)]={expanded:s.length===1||s[1]==="e"}}}},writeLocalStorageExpandedProjects:function(){var e=[];for(truncatedProjectId in this.localStorageExpandedProjects)e.push(truncatedProjectId+":"+(this.localStorageExpandedProjects[truncatedProjectId].expanded?"e":"c"));e=e.join(",");if(localstoragehelper.localStorageSupported()){var p=this.localStorageKey("expanded");
localstoragehelper.write(p,e)}},projectIdIsExpanded:function(e){e=e.substring(0,8);return e in this.expandedProjects?this.expandedProjects[e].expanded:false},setExpandedForProjectIds:function(e,p){var s=search.inSearchMode(),w;for(w in e){var u=e[w];if(!(s&&!search.isLocallyCreatedItemForCurrentSearch(this.getProjectReferenceByProjectId(u)))){u=u.substring(0,8);this.expandedProjects[u]={expanded:p};this.localStorageExpandedProjects[u]={expanded:p};this.pendingExpandedProjectsDelta.set(u,p)}}this.writeLocalStorageExpandedProjects()},
addSubtreeExpansionsToPendingDelta:function(e){var p=this.getChildrenOfProjectTreeObject(e);if(p.length!==0)if(e!==null){e=projecttreeobject.getProjectId(e);var s=this.projectIdIsExpanded(e);this.pendingExpandedProjectsDelta.set(e.substring(0,8),s);for(var w in p)this.addSubtreeExpansionsToPendingDelta(p[w])}},getProjectTreeObjectByProjectId:function(e){return e===n?null:this.projectIdToProjectMap[e]},getProjectReferenceByProjectId:function(e){return new t(e,this.treeId)},getProjectReferenceByProjectTreeObject:function(e){return new t(h(e),
this.treeId)},getRootProjectReference:function(){return this.getProjectReferenceByProjectId(n)},getChildrenOfProjectTreeObject:function(e){return e===null?this.rootProjectChildren:projecttreeobject.getChildren(e)},getSiblingsOfProjectTreeObject:function(e){return this.getChildrenOfProjectTreeObject(projecttreeobject.getParent(e))},getPriorityOfProjectTreeObject:function(e){var p=this.getSiblingsOfProjectTreeObject(e);return utils.indexInArray(p,e)},projectTreeObjectHasSharedAncestor:function(e,p){if(p===
undefined)p=false;for(var s=p?e:projecttreeobject.getParent(e);s!==null;){if(projecttreeobject.getSharedInfo(s)!==null)return true;s=projecttreeobject.getParent(s)}return false},projectTreeObjectHasAddedSubtreeDescendant:function(e){var p=false;this.applyToProjectSubtree(e,function(s){if(projecttreeobject.isAddedSubtreePlaceholder(s))p=true});return p},knowAboutProjectId:function(e){if(this.getProjectTreeObjectByProjectId(e)!==undefined)return true;var p=false,s;for(s in this.deletedProjectIdToProjectMap)this.applyToProjectSubtree(this.deletedProjectIdToProjectMap[s],
function(w){if(projecttreeobject.getProjectId(w)===e)p=true});return p},applyToProjectSubtree:function(e,p){e!==null&&p(e);for(var s=this.getChildrenOfProjectTreeObject(e),w=0;w<s.length;w++)this.applyToProjectSubtree(s[w],p)},applyLocalOperationAndAddToPendingQueue:function(e,p,s){if(s===undefined)s=null;var w=this.getCurrentClientTimestamp();if(s!==null){e=operations.createOperationWithUndoData(e,p,s,w);utils.debugMessage("Applying local undo/redo operation:");utils.debugMessage(e);try{this.operationRunner.applyOperations([e])}catch(u){utils.debugMessage(u);
return false}}else{e=operations.createOperation(e,p,w);e=this.operationRunner.applyOperations([e])[0];undoredo.addOperationToCurrentBatch(e,new r(this.treeId))}this.pendingOperationQueue.append(e);pushpoll.updateSaveStatus();pushpoll.scheduleNextPushAndPoll();return true},isLastLocallyDeletedProjectId:function(e){return l().isLastLocallyDeletedProject(this.getProjectReferenceByProjectId(e))},hasUnsavedData:function(){return this.pendingOperationQueue.getLength()>0||this.inFlightOperationQueue.getLength()>
0},pushPollIsInProgress:function(){return this.pushPollInProgress.getValue()},hasPendingOperations:function(){return this.pendingOperationQueue.getLength()>0},hasInFlightOperations:function(){return this.inFlightOperationQueue.getLength()>0},notifyContentsAreVisibleMayHaveChanged:function(){this.pushPollIsInProgress()||this.contentsAreVisible()&&datetime.getCurrentTimeInMS()-this.lastPushPollCompleteTimestamp.getValue()>this.pollingIntervalInMs.getValue()+1E3&&pushpoll.scheduleImmediatePollOnNextTick()},
contentsAreVisible:function(){if(this.isAuxiliary()){var e=k().getSharedSubtreePlaceholder(this.getRootProjectId());return e!==undefined&&globalprojecttreeobject.isInDom(e)&&globalprojecttreeobject.isExpandedInDom(e)}else return true},currentlySkippingPushPolls:function(){if(!this.isAuxiliary()||this.contentsAreVisible())return false;if(this.hasPendingOperations())return false;return datetime.getCurrentTimeInMS()<this.lastPushPollCompleteTimestamp.getValue()+6E5},beginPushAndPoll:function(){this.pushPollInProgress.setValue(true);
this.mostRecentOperationTransactionIdWhenPushPollInitiated.setValue(this.mostRecentOperationTransactionId.getValue());this.pendingOperationQueue.copyTo(this.inFlightOperationQueue);this.pendingOperationQueue.clear();this.pendingExpandedProjectsDelta.copyTo(this.inFlightExpandedProjectsDelta);this.pendingExpandedProjectsDelta.clear();return this.getPushPollData()},getPushPollData:function(){if(!this.pushPollInProgress.getValue())return null;var e={most_recent_operation_transaction_id:this.mostRecentOperationTransactionId.getValue()};
if(this.mostRecentOperationTransactionIdWhenPushPollInitiated.getValue()!==this.mostRecentOperationTransactionId.getValue())e.most_recent_operation_transaction_id_when_pushpoll_initiated=this.mostRecentOperationTransactionIdWhenPushPollInitiated.getValue();if(this.inFlightOperationQueue.getLength()>0)e.operations=this.inFlightOperationQueue.getList();if(!this.inFlightExpandedProjectsDelta.isEmpty())e.project_expansions_delta=this.inFlightExpandedProjectsDelta.getDict();if(this.isShared())e.shared_projectid=
this.getRootProjectId();return e},resetPushAndPoll:function(){this.pushPollInProgress.setValue(false);this.mostRecentOperationTransactionIdWhenPushPollInitiated.setValue(null);this.inFlightOperationQueue.prependTo(this.pendingOperationQueue);this.inFlightOperationQueue.clear();this.pendingExpandedProjectsDelta.overlayOn(this.inFlightExpandedProjectsDelta);this.inFlightExpandedProjectsDelta.clear()},completePushAndPoll:function(e,p){var s=false,w=false,u=false,A=false,B=false,E=this.inFlightOperationQueue.getLength()>
0;utils.debugMessage("Completing "+(E?"PUSH":"POLL")+' for tree "'+this.treeId+'".');var H="error"in e?e.error:null;if(H===null){var J="new_most_recent_operation_transaction_id"in e?e.new_most_recent_operation_transaction_id:null,L="server_run_operation_transaction_json"in e?e.server_run_operation_transaction_json:null,K="concurrent_remote_operation_transactions"in e?e.concurrent_remote_operation_transactions:null,N="error_encountered_in_remote_operations"in e?e.error_encountered_in_remote_operations:
false,y="new_polling_interval_in_ms"in e?e.new_polling_interval_in_ms:null,D="refreshed_project_tree"in e?e.refreshed_project_tree:null,G="need_refreshed_project_tree"in e&&e.need_refreshed_project_tree;H="over_quota"in e?e.over_quota:null;var I="items_created_in_current_month"in e?e.items_created_in_current_month:null,O="monthly_item_quota"in e?e.monthly_item_quota:null;if(J===null||E&&!p&&L===null||y===null||G&&D===null||K===null&&D===null||this.isShared()&&H===null||!this.isShared()&&(I===null||
O===null))s=true;if(!s){var P=null;if(L!==null)P=utils.parseJsonWithErrorHandling(L,function(){s=true});var R=null;if(K!==null)R=utils.parseJsonListWithErrorHandling(K,function(){s=true})}if(!s){utils.debugMessage("Polling interval from server: "+y+" ms");this.mostRecentOperationTransactionId.setValue(J);this.pollingIntervalInMs.setValue(y);N&&utils.debugMessage("Server returned error_encountered_in_remote_operations");J=this.operationRunner.applyConcurrentRemoteOperationTransactionsOrRefreshProjectTree(R,
D,G,p&&P===null);if((L=R!==null&&R.length>0)||P!==null){L&&this.serverRunOperationTransactionQueue.appendList(R);P!==null&&this.serverRunOperationTransactionQueue.append(P)}if(J.errorEncountered)u=true;if(J.loadedRefreshedProjectTree)A=true;if(this.isShared()){utils.debugMessage("Quota info from server: "+(H?"over":"under")+" quota");P=H!==this.overQuota.getValue();this.overQuota.setValue(H)}else{utils.debugMessage("Quota info from server: "+I+" / "+O+" items");P=I!==this.itemsCreatedInCurrentMonth.getValue()||
O!==this.monthlyItemQuota.getValue();this.itemsCreatedInCurrentMonth.setValue(I);this.monthlyItemQuota.setValue(O)}P&&quota.notifyQuotaStatsChangedForProjectTree(this);if(this.isOverQuota()&&(this.inFlightOperationQueue.containsOperationType("create")||this.inFlightOperationQueue.containsOperationType("bulk_create")))quota.notifyLocalCreateWhileOverQuotaForProjectTree(this)}}else{utils.debugMessage('Server error: "'+H+'"');if(H==="shared_project_does_not_exist"&&this.isAuxiliary())B=true;else if(E)w=
true;else s=true}H=s||w||u;E&&sharing.notifyShareOrUnshareCompleteIfNeeded(this.inFlightOperationQueue,H);this.pushPollInProgress.setValue(false);this.mostRecentOperationTransactionIdWhenPushPollInitiated.setValue(null);this.inFlightOperationQueue.clear();this.inFlightExpandedProjectsDelta.clear();this.lastPushPollCompleteTimestamp.setValue(datetime.getCurrentTimeInMS());return{invalidResult:s,errorEncounteredRunningClientOperationsOnServer:w,errorEncounteredRunningRemoteOperationsOnClient:u,loadedRefreshedProjectTree:A,
makeDefunct:B}},operationTransactionsContainUndeleteOfUnknownProject:function(e){return this.operationRunner.operationTransactionsContainUndeleteOfUnknownProject(e)},getPendingOperationList:function(){return this.pendingOperationQueue.getList()},getInFlightOperationList:function(){return this.inFlightOperationQueue.getList()},setPendingOperationList:function(e){this.pendingOperationQueue.setList(e)},setInFlightOperationList:function(e){this.inFlightOperationQueue.setList(e)},getStats:function(){var e=
0,p=0;this.applyToProjectSubtree(null,function(s){e++;projecttreeobject.isCompleted(s)&&p++});return{items:e,completed:p}},applyLocalEdit:function(e,p,s){e={projectid:projecttreeobject.getProjectId(e)};if(p!==null)e.name=p;if(s!==null)e.description=s;this.applyLocalOperationAndAddToPendingQueue("edit",e)},applyLocalCreateChild:function(e,p){var s=utils.generateUUID(),w=new t(s,this.treeId);search.inSearchMode()&&search.registerLocallyCreatedItemForCurrentSearch(w);this.applyLocalOperationAndAddToPendingQueue("create",
{projectid:s,parentid:h(e),priority:p});return w},applyLocalBulkCreateChildren:function(e,p,s){var w=[],u=[],A=[],B=this.treeId,E=function(J,L){if(L===undefined)L=false;var K=false;if("expanded"in J){K=true;delete J.expanded}var N=utils.generateUUID();projecttreeobject.setProjectId(J,N);var y=new t(N,B);w.push(y);search.inSearchMode()&&search.registerLocallyCreatedItemForCurrentSearch(y);N=projecttreeobject.getChildren(J);if(N!==undefined){if(K){u.push(y);L&&A.push(y)}for(K=0;K<N.length;K++)E(N[K])}},
H=0;for(;H<s.length;H++)E(s[H],true);this.applyLocalOperationAndAddToPendingQueue("bulk_create",{parentid:h(e),starting_priority:p,project_trees:JSON.stringify(s)});projecttree.setExpandedForProjectReferences(u,true);for(H=0;H<A.length;H++)A[H].getMatchingDomProject().showChildren("instant");return w},applyLocalComplete:function(e){this.applyLocalOperationAndAddToPendingQueue("complete",{projectid:projecttreeobject.getProjectId(e)})},applyLocalUncomplete:function(e){this.applyLocalOperationAndAddToPendingQueue("uncomplete",
{projectid:projecttreeobject.getProjectId(e)})},applyLocalDelete:function(e,p){if(p===undefined)p=false;projecttreeobject.getParent(e);var s=projecttreeobject.getProjectId(e),w=this.getPriorityOfProjectTreeObject(e);this.applyLocalOperationAndAddToPendingQueue("delete",{projectid:s});p&&l().setLocalUndeleteInfo(this.treeId,s,w)},applyLocalUndelete:function(e,p){this.applyLocalOperationAndAddToPendingQueue("undelete",{projectid:e,priority:p})},applyLocalMove:function(e,p,s){var w=this.getPriorityOfProjectTreeObject(e),
u=projecttreeobject.getParent(e);p===u&&s>w&&s--;this.applyLocalOperationAndAddToPendingQueue("move",{projectid:projecttreeobject.getProjectId(e),parentid:h(p),priority:s})},applyLocalShare:function(e,p,s){if(s===undefined)s=null;this.addSubtreeExpansionsToPendingDelta(e);var w=projecttreeobject.getSharedInfo(e);w!==null&&w.isSharedViaUrl();e={projectid:projecttreeobject.getProjectId(e),share_type:p};if(p==="url")e.write_permission=s;this.applyLocalOperationAndAddToPendingQueue("share",e)},applyLocalUnshare:function(e){this.applyLocalOperationAndAddToPendingQueue("unshare",
{projectid:projecttreeobject.getProjectId(e)})},applyLocalAddSharedEmail:function(e,p,s){var w=null,u=projecttreeobject.getSharedInfo(e).getInfoForEmail(p);if(u!==null)w=u.access_token;if(w===null)w=urls.generateUrlSafeRandomString(10);this.applyLocalOperationAndAddToPendingQueue("add_shared_email",{projectid:projecttreeobject.getProjectId(e),shared_email:p,write_permission:s,access_token:w})},applyLocalRemoveSharedEmail:function(e,p){projecttreeobject.getSharedInfo(e);this.applyLocalOperationAndAddToPendingQueue("remove_shared_email",
{projectid:projecttreeobject.getProjectId(e),shared_email:p})},getTreeId:function(){return this.treeId},getRootProject:function(){return this.rootProject},getRootProjectId:function(){return this.rootProject!==null?projecttreeobject.getProjectId(this.rootProject):null},getRootProjectChildren:function(){return this.rootProjectChildren},getProjectIdToProjectMap:function(){return this.projectIdToProjectMap},getDeletedProjectIdToProjectMap:function(){return this.deletedProjectIdToProjectMap},getPollingIntervalInMs:function(){return this.pollingIntervalInMs.getValue()},
getLastPushPollCompleteTimestamp:function(){return this.lastPushPollCompleteTimestamp.getValue()}}),x=Class.extend({init:function(){this.localUndeleteInfo=null},applyToAllProjectTrees:function(e){for(var p in g)e(g[p])},setLocalUndeleteInfo:function(e,p,s){this.localUndeleteInfo={treeId:e,projectid:p,priority:s}},isLastLocallyDeletedProject:function(e){if(this.localUndeleteInfo===null)return false;return e.equals(new t(this.localUndeleteInfo.projectid,this.localUndeleteInfo.treeId))},applyLocalUndeleteOfLastDeletedProject:function(){if(this.localUndeleteInfo!==
null){var e=f(this.localUndeleteInfo.treeId);e!==null&&e.applyLocalUndelete(this.localUndeleteInfo.projectid,this.localUndeleteInfo.priority)}},findProjectByProjectId:function(e){if(e===n)return k().getProjectReferenceByProjectId(e);for(var p in g){var s=g[p].getProjectReferenceByProjectId(e);if(s.isValid())return s}return null},haveUnsavedData:function(){for(var e in g)if(g[e].hasUnsavedData())return true;return false},readLocalStorageExpandedProjects:function(){for(var e in g)g[e].readLocalStorageExpandedProjects()},
getMinPollingInterval:function(){var e=null,p;for(p in g){var s=g[p];if(!s.currentlySkippingPushPolls()){s=s.getPollingIntervalInMs();if(e===null||s<e)e=s}}return e},getLastPushPollCompleteTimestamp:function(){var e=null,p;for(p in g){var s=g[p].getLastPushPollCompleteTimestamp();e=e===null?s:Math.max(e,s)}return e},pushPollIsInProgress:function(){for(var e in g)if(g[e].pushPollIsInProgress())return true;return false},havePendingOperations:function(){for(var e in g)if(g[e].hasPendingOperations())return true;
return false},haveInFlightOperations:function(){for(var e in g)if(g[e].hasInFlightOperations())return true;return false},beginPushAndPoll:function(){var e=[],p;for(p in g){var s=g[p];if(!s.currentlySkippingPushPolls()){s=s.beginPushAndPoll();e.push(s)}}return e},getPushPollData:function(){var e=[],p;for(p in g){var s=g[p].getPushPollData();s!==null&&e.push(s)}return e},resetPushAndPoll:function(){for(var e in g){var p=g[e];p.pushPollIsInProgress()&&p.resetPushAndPoll()}},markIfRefreshedProjectTreeNeededForRemoteUndeletes:function(e){if(!("results"in
e))return false;e=e.results;for(var p=0;p<e.length;p++){var s=e[p];if(!("need_refreshed_project_tree"in s&&s.need_refreshed_project_tree)){var w="concurrent_remote_operation_transactions"in s?s.concurrent_remote_operation_transactions:null,u="shared_projectid"in s?s.shared_projectid:null;if("remote_operations_contain_undelete"in s&&s.remote_operations_contain_undelete){utils.debugMessage("Remote operations contain undelete. Testing if we know about the item being undeleted...");if(w!==null){u=b(u);
if(u!==null){w=utils.parseJsonListWithErrorHandling(w);if(w!==null)if(u.operationTransactionsContainUndeleteOfUnknownProject(w)){utils.debugMessage("... We do not. Marking that we need a refreshed project tree.");s.need_refreshed_project_tree=true}else utils.debugMessage("... We do. No refreshed project tree needed.")}}}}}},needRefreshedProjectTreesOrAddedSharedSubtrees:function(e){if(!("results"in e))return false;var p=e.results;if(("newly_added_shared_project_projectids"in e?e.newly_added_shared_project_projectids:
[]).length>0)return true;for(e=0;e<p.length;e++){var s=p[e];if("need_refreshed_project_tree"in s&&s.need_refreshed_project_tree)return true}return false},extractRefreshedProjectTreesAndNewlyAddedSharedSubtreesFromNewProjectTreeData:function(e,p){function s(H){for(var J=0;J<e.auxiliaryProjectTreeInfos.length;J++){var L=e.auxiliaryProjectTreeInfos[J];if(projecttreeobject.getProjectId(L.rootProject)===H)return L}return null}var w="newly_added_shared_project_projectids"in p?p.newly_added_shared_project_projectids:
[],u=[],A=0;for(;A<w.length;A++){var B=w[A],E=s(B);if(E!==null){u.push(E);utils.debugMessage("Extracted newly added shared subtree with projectid "+B)}}if(u.length>0)p.newly_added_shared_project_trees=u;w=p.results;for(u=0;u<w.length;u++){A=w[u];if("need_refreshed_project_tree"in A&&A.need_refreshed_project_tree){B="shared_projectid"in A?A.shared_projectid:null;E=null;E=B===null?e.mainProjectTreeInfo:s(B);if(E!==null){A.refreshed_project_tree=E.rootProjectChildren;A.new_most_recent_operation_transaction_id=
E.initialMostRecentOperationTransactionId}}}},completePushAndPoll:function(e,p){if(!("results"in e))return{invalidData:true};var s=e.results,w="newly_added_shared_project_tree_jsons"in e?e.newly_added_shared_project_tree_jsons:null,u="newly_added_shared_project_trees"in e?e.newly_added_shared_project_trees:null,A=false,B=false,E=false,H=false,J=false;if(w!==null)if(u===null){u=[];for(var L=0;L<w.length;L++){var K=w[L];try{var N=JSON.parse(K)}catch(y){utils.debugMessage(y);A=true;continue}u.push(N)}}else A=
true;w=false;for(L=0;L<s.length;L++){K=s[L];if("concurrent_remote_operation_transactions"in K&&K.concurrent_remote_operation_transactions.length>0||"refreshed_project_tree"in K||"error"in K&&K.error==="shared_project_does_not_exist"){w=true;break}}if(u!==null)w=true;if(w){var D=operations.saveClientViewState();blurFocusedContent()}if(u!==null)for(L=0;L<u.length;L++){N=u[L];K=projecttreeobject.getProjectId(N.rootProject);b(K)===null&&b(K,o)===null&&a(N)}for(L=0;L<s.length;L++){K=s[L];N=b("shared_projectid"in
K?K.shared_projectid:null);if(N===null||!N.pushPollIsInProgress())A=true;else{K=N.completePushAndPoll(K,p);A|=K.invalidResult;B|=K.errorEncounteredRunningClientOperationsOnServer;E|=K.errorEncounteredRunningRemoteOperationsOnClient;H|=K.loadedRefreshedProjectTree;if(K.makeDefunct){N.makeDefunct();J=true}}}if(this.pushPollIsInProgress())A=true;if(w){s=false;if(H||u!==null||J){c(null);search.reapplyCurrentSearch();H&&undoredo.clearStacks();s=true}operations.restoreClientViewState(D,s,"doNotScroll")}return{invalidData:A,
errorEncounteredRunningClientOperationsOnServer:B,errorEncounteredRunningRemoteOperationsOnClient:E}},getStats:function(){var e={},p;for(p in g)e[p]=g[p].getStats();var s={};for(p in e){var w=e[p],u;for(u in w)s[u]=(u in s?s[u]:0)+w[u]}return{trees:e,totals:s}}});return{ROOT_PROJECTID:n,ProjectReference:t,setExpandedForProjectReferences:function(e,p){for(var s=[],w=0;w<e.length;w++)s.push(e[w].getProjectTreeObject());m(s,p)},initializeProjectTrees:function(e,p){for(var s=0;s<p.length;s++)a(p[s],true);
s=new v(e,d);g[d]=s;TRACK_TAG_COUNTS&&c(null)},initializeGlobalDescendantTagCounts:c,mainLocalStorageKey:function(e){return k().localStorageKey(e)},getMainProjectTree:k,getProjectTreeByRootProjectId:b,getProjectIdOfProjectTreeObject:h,getProjectReferenceFromDomProject:function(e){var p=e.attr("projectid");e=e.attr("data-tid");if(e===undefined)e=d;return new t(p,e)},getAllProjectTreesHelper:l}}(),operations=function(){function a(d,g,j){return{type:d,data:g,client_timestamp:j}}function c(d,g,j,o){d=
a(d,g,o);d.undo_data=j;return d}function f(d,g){if(g===undefined)g=false;for(var j=[],o=0;o<d.length;o++){var n=d[o];g&&utils.debugMessage(function(){return"remote operation transaction: "+JSON.stringify(n)});for(var q=n.ops,r=n.client_timestamp,t=0;t<q.length;t++)q[t].client_timestamp=r;utils.pushArray(j,q)}return j}function b(d){for(var g=[],j=d.length-1;j>=0;j--){var o=d[j];utils.debugMessage("inverting: "+o.type);o=k(o);g=g.concat(o)}return g}function k(d){var g=l(d,"type"),j=l(d,"data"),o=l(d,
"undo_data");d=l(d,"client_timestamp");switch(g){case "edit":var n=l(j,"projectid");g="name"in j?j.name:null;j="description"in j?j.description:null;var q=l(o,"previous_last_modified");n={projectid:n};d={previous_last_modified:d};if(g!==null){n.name=l(o,"previous_name");d.previous_name=g}if(j!==null){n.description=l(o,"previous_description");d.previous_description=j}return[c("edit",n,d,q)];case "create":o=l(j,"projectid");g=l(j,"parentid");j=l(j,"priority");return[c("delete",{projectid:o},{parentid:g,
priority:j,previous_last_modified:d},null)];case "complete":return h("complete",j,o,d);case "uncomplete":return h("uncomplete",j,o,d);case "delete":j=l(j,"projectid");g=l(o,"priority");o=l(o,"previous_last_modified");return[c("undelete",{projectid:j,priority:g},{previous_last_modified:d},o)];case "undelete":g=l(j,"projectid");j=l(j,"priority");o=l(o,"previous_last_modified");return[c("delete",{projectid:g},{priority:j,previous_last_modified:d},o)];case "move":g=l(j,"projectid");q=l(j,"parentid");
j=l(j,"priority");n=l(o,"previous_parentid");var r=l(o,"previous_priority");o=l(o,"previous_last_modified");return[c("move",{projectid:g,parentid:n,priority:r},{previous_parentid:q,previous_priority:j,previous_last_modified:d},o)];case "share":g=l(j,"projectid");q=l(j,"share_type");j="write_permission"in j?j.write_permission:null;n=l(o,"previous_share_type");r="previous_write_permission"in o?o.previous_write_permission:null;o=l(o,"previous_last_modified");if(n==="url"&&q==="url"){if(r===null)throw Error("Missing previous_write_permission when inverting a write_permission change to URL-based sharing.");
d=[c("share",{projectid:g,share_type:"url",write_permission:r},{previous_share_type:"url",previous_write_permission:j,previous_last_modified:d},o)]}else{n=new sharing.ItemSharedInfo;if(q==="url")n.shareViaUrl(j);else q==="email"&&n.shareViaEmail();j={projectid:g};d={previous_shared_info:n.makeCopyOfRawSharedInfo(),previous_last_modified:d};d=[c("unshare",j,d,o)]}return d;case "unshare":j=l(j,"projectid");g=l(o,"previous_shared_info");o=l(o,"previous_last_modified");g=new sharing.ItemSharedInfo(g);
return g.getOperationsToCreate(j,d,o);case "add_shared_email":g=l(j,"projectid");q=l(j,"shared_email");n=l(j,"write_permission");j=l(j,"access_token");r="previous_write_permission"in o?o.previous_write_permission:null;o=l(o,"previous_last_modified");d=r!==null?[c("add_shared_email",{projectid:g,shared_email:q,write_permission:r,access_token:j},{previous_write_permission:n,previous_last_modified:d},o)]:[c("remove_shared_email",{projectid:g,shared_email:q},{write_permission:n,access_token:j,previous_last_modified:d},
o)];return d;case "remove_shared_email":g=l(j,"projectid");j=l(j,"shared_email");q=l(o,"write_permission");n=l(o,"access_token");r="user_id"in o?o.user_id:null;o=l(o,"previous_last_modified");var t=[];t.push(c("add_shared_email",{projectid:g,shared_email:j,write_permission:q,access_token:n,send_email_if_new:false},{previous_last_modified:d},o));r!==null&&t.push(c("register_shared_email_user",{projectid:g,access_token:n,user_id:r},{previous_last_modified:d},o));return t;case "register_shared_email_user":g=
l(j,"projectid");q=l(j,"access_token");j="user_id"in j?j.user_id:null;n="previous_user_id"in o?o.previous_user_id:null;o=l(o,"previous_last_modified");g={projectid:g,access_token:q};if(n!==null){if(j!==null)throw Error("Unexpected 'register_shared_email_user' operation with both user_id and previous_user_id !== null");g.user_id=n}d={previous_last_modified:d};if(j!==null)d.previous_user_id=j;return[c("register_shared_email_user",g,d,o)];case "make_shared_subtree_placeholder":throw Error("Can't invert make_shared_subtree_placeholder - not implemented.");
case "bulk_create":return m(j,o,d);default:throw Error("Unrecognized operation type: '"+g+"'");}}function m(d,g,j){g=l(d,"parentid");var o=l(d,"starting_priority");d=l(d,"project_trees");d=JSON.parse(d);for(var n=[],q=d.length-1;q>=0;q--){var r={projectid:projecttreeobject.getProjectId(d[q])};r=c("delete",r,{parentid:g,priority:o+q,previous_last_modified:j},null);n.push(r)}return n}function h(d,g,j,o){g=l(g,"projectid");var n=l(j,"previous_completed");j=l(j,"previous_last_modified");return[c(n===
false?"uncomplete":"complete",{projectid:g},{previous_last_modified:o,previous_completed:d==="complete"?o:false},j)]}function l(d,g){if(!(g in d))throw Error("Expected field '"+g+"' not found.");return d[g]}return{ProjectTreeOperationRunner:Class.extend({init:function(d){this.projectTree=d},applyConcurrentRemoteOperationTransactionsOrRefreshProjectTree:function(d,g,j,o){if(j===undefined)j=false;if(o===undefined)o=false;if(g===null&&(d===null||d.length===0)&&!o)return{errorEncountered:false,loadedRefreshedProjectTree:false};
var n=false;if(j||d===null)if(g!==null){d=this.loadRefreshedProjectTree(g);d=d.errorEncountered;n=true}else d=true;else{d=this.applyConcurrentRemoteOperationTransactions(d,o);d=d.errorEncountered}return{errorEncountered:d,loadedRefreshedProjectTree:n}},loadRefreshedProjectTree:function(d){utils.debugMessage("loadRefreshedProjectTree called");var g;if(typeof d==="string")try{g=JSON.parse(d)}catch(j){utils.debugMessage(j);return{errorEncountered:true}}else g=d;utils.debugMessage("Installing refreshed_project_tree");
this.projectTree.loadRefreshed(g);selectOnActivePage(".mainTreeRoot").overwriteProjectChildrenHtml(function(){return""});this.applyPendingOperations(true);return{errorEncountered:false}},applyConcurrentRemoteOperationTransactions:function(d,g){if(g===undefined)g=false;utils.debugMessage("applyConcurrentRemoteOperationTransactions called");try{var j=f(d,true)}catch(o){utils.debugMessage(o);return{errorEncountered:true}}utils.debugMessage("num remote operations: "+j.length);var n=this.projectTree.getPendingOperationList(),
q=this.projectTree.getInFlightOperationList(),r=false;try{if(n.length>0){utils.debugMessage("undoing pending");this.undoLocalOperations(n)}if(q.length>0){utils.debugMessage("undoing in-flight");this.undoLocalOperations(q)}if(j.length>0){utils.debugMessage("applying remote");this.applyOperations(j,true,false);r=true}}catch(t){utils.debugMessage(t);return{errorEncountered:true}}g?utils.debugMessage("NOT applying in-flight because operations not applied on server for redo"):this.applyInFlightOperations(r,
true);this.applyPendingOperations(r,true);return{errorEncountered:false}},applyInFlightOperations:function(d,g,j){if(g===undefined)g=false;if(j===undefined)j=false;var o=this.projectTree.getInFlightOperationList();if(o.length>0){utils.debugMessage("applying in-flight");g=this.applyOperations(o,false,g,j);if(d){utils.debugMessage("(amending in-flight operations because they were run over a new baseline tree)");this.projectTree.setInFlightOperationList(g)}}},applyPendingOperations:function(d,g,j){if(g===
undefined)g=false;if(j===undefined)j=false;var o=this.projectTree.getPendingOperationList();if(o.length>0){utils.debugMessage("applying pending");g=this.applyOperations(o,false,g,j);if(d){utils.debugMessage("(amending pending operations because they were run over a new baseline tree)");this.projectTree.setPendingOperationList(g)}}},reconstructTreeStateFromUserstorageOperations:function(d,g){if(g===undefined)g=false;utils.debugMessage("reconstructTreeStateFromUserstorageOperations called");try{var j=
f(d,true)}catch(o){utils.debugMessage(o);return{errorEncountered:true}}utils.debugMessage("num server-run operations: "+j.length);if(j.length>0){utils.debugMessage("applying server-run");try{this.applyOperations(j,true,false,true)}catch(n){utils.debugMessage(n);return{errorEncountered:true}}}this.applyInFlightOperations(g,false,true);this.applyPendingOperations(g,false,true);return{errorEncountered:false}},operationTransactionsContainUndeleteOfUnknownProject:function(d){try{var g=f(d);d={};for(var j=
{},o=0;o<g.length;o++){var n=g[o],q=l(n,"type"),r=l(n,"data");if(q==="undelete"){var t=l(r,"projectid");d[t]=true}else if(q==="create"){t=l(r,"projectid");j[t]=true}else if(q==="bulk_create"){var v=l(r,"project_trees"),x=this.getProjectIdsToCreate(JSON.parse(v),false);for(t in x)j[t]=true}}for(var e in d)if(!this.projectTree.knowAboutProjectId(e)&&!(e in j))return true}catch(p){utils.debugMessage(p)}return false},applyOperations:function(d,g,j,o){if(g===undefined)g=true;if(j===undefined)j=false;if(o===
undefined)o=false;for(var n=[],q=0;q<d.length;q++){var r=d[q],t=false,v=null;try{var x=l(r,"type"),e=l(r,"data"),p=l(r,"client_timestamp");if("server_data"in r&&"was_noop"in r.server_data&&r.server_data.was_noop)continue;utils.debugMessage("apply: "+x);switch(x){case "edit":v=this.applyEditOperation(e,p,o);break;case "create":v=this.applyCreateOperation(e,p,o,j);break;case "complete":v=this.applyCompleteOperation(e,p,o);break;case "uncomplete":v=this.applyUncompleteOperation(e,p,o);break;case "delete":v=
this.applyDeleteOperation(e,p,o);break;case "undelete":v=this.applyUndeleteOperation(e,p,o);break;case "move":v=this.applyMoveOperation(e,p,o);break;case "share":v=this.applyShareOperation(e,p,o);break;case "unshare":v=this.applyUnshareOperation(e,p,o);break;case "add_shared_email":v=this.applyAddSharedEmailOperation(e,p,o);break;case "remove_shared_email":v=this.applyRemoveSharedEmailOperation(e,p,o);break;case "register_shared_email_user":v=this.applyRegisterSharedEmailUserOperation(e,p,o);break;
case "make_shared_subtree_placeholder":v=this.applyMakeSharedSubtreePlaceholderOperation(e,p,o);break;case "bulk_create":v=this.applyBulkCreateOperation(e,p,o,j);break;default:throw Error("Unrecognized operation type: '"+x+"'");}}catch(s){if(g)throw s;else t=true}if(!t){t=v;r=utils.deepCopyObject(r);r.undo_data=t;n.push(r)}}return n},applyEditOperation:function(d,g,j){var o=l(d,"projectid"),n="name"in d?d.name:null;d="description"in d?d.description:null;var q=this.getProjectTreeObjectByProjectIdOrThrowException(o),
r={previous_last_modified:projecttreeobject.getLastModified(q)};if(n!==null){r.previous_name=projecttreeobject.getName(q);projecttreeobject.setName(q,n);projecttreeobject.updateNameContentText(q)}if(d!==null){r.previous_description=projecttreeobject.getNote(q);projecttreeobject.setNote(q,d);projecttreeobject.updateNoteContentText(q)}projecttreeobject.setLastModified(q,g);projecttreeobject.getTagManager(q).nameOrNoteChanged(j);if(!j){g=this.projectTree.getProjectReferenceByProjectId(o).getMatchingDomProject();
if(g.length===1){j=document.activeElement;if(n!==null){o=g.getName().children(".content");j!==o[0]&&o.setContentText(n,false)}if(d!==null){n=g.getNotes().children(".content");if(j!==n[0]){n.setContentText(d,true);d.length>0?g.addClass("noted"):g.removeClass("noted")}}}}return r},applyCreateOperation:function(d,g,j,o){if(o===undefined)o=false;var n=l(d,"projectid"),q=l(d,"parentid");d=l(d,"priority");var r={};if(o){this.applyUndeleteOperation({projectid:n,priority:d},g,j);return r}o={};projecttreeobject.setProjectId(o,
n);this.createProjects(q,d,[o],g,j);return r},applyBulkCreateOperation:function(d,g,j,o){if(o===undefined)o=false;var n=l(d,"parentid"),q=l(d,"starting_priority"),r=l(d,"project_trees"),t={};if(o){g=m(d,{},g);g=b(g);for(n=0;n<g.length;n++){q=g[n];this.applyUndeleteOperation(q.data,q.client_timestamp,j)}return t}d=JSON.parse(r);this.createProjects(n,q,d,g,j);return t},createProjects:function(d,g,j,o,n){function q(e){var p=[],s=projecttreeobject.getChildren(e);if(s!==undefined)for(var w=0;w<s.length;w++){var u=
q(s[w]);p.push(u)}w=projecttreeobject.getProjectId(e);u=projecttreeobject.hasName(e)?projecttreeobject.getName(e):null;var A=projecttreeobject.hasNote(e)?projecttreeobject.getNote(e):null;e=projecttreeobject.isCompleted(e)?o:null;s=p.length>0?p:null;p=projecttreeobject.create(w,u,A,e,s);projecttreeobject.setLastModified(p,o);return p}this.getProjectIdsToCreate(j);d=this.getProjectTreeObjectByProjectIdOrThrowException(d);var r=this.projectTree.getChildrenOfProjectTreeObject(d);g=g>=r.length?r.length:
g;for(var t=[],v=0;v<j.length;v++){var x=q(j[v]);t.push(x)}j=[g,0].concat(t);r.splice.apply(r,j);j=this.projectTree.getProjectReferenceByProjectTreeObject(d);for(r=0;r<t.length;r++){x=t[r];this.projectTree.initializeProjectTreeSubtree(x,d);if(!n){projecttree.initializeGlobalDescendantTagCounts(x);projecttreeobject.getTagManager(x).itemMoved(null,j)}}if(!n)for(r=0;r<t.length;r++){x=t[r];this.addProjectToDOM(d,g+r,function(){return $(globalprojecttreeobject.constructProjectTreeHtml(x))})}},getProjectIdsToCreate:function(d,
g){function j(r){var t=projecttreeobject.getProjectId(r);if(g)if(t in o||n.getProjectTreeObjectByProjectId(t)!==undefined)throw Error("Trying to create project with already-existing projectid "+t);o[t]=true;r=projecttreeobject.getChildren(r);if(r!==undefined)for(t=0;t<r.length;t++)j(r[t])}if(g===undefined)g=true;for(var o={},n=this.projectTree,q=0;q<d.length;q++)j(d[q]);return o},addProjectToDOM:function(d,g,j){d=this.projectTree.getProjectReferenceByProjectTreeObject(d).getMatchingDomProject();if(d.length==
1){var o=d.is(".selected");if(!d.is("parent")&&(o||d.is(".open"))){j=j();for(var n=d.getChildren(),q=Math.min(g,n.length-1);q>=0;){var r=n.eq(q),t=projecttree.getProjectReferenceFromDomProject(r).getPriority();if(t<=g)break;q--}if(q<0)(n.length===0?d.children(".children").children(".childrenEnd"):n.eq(0)).before(j);else t===g?r.before(j):r.after(j);o&&refreshVisibleChildrenUnderSelectedForAddButton()}d.removeClass("task");d.refreshExpanded()}},applyCompleteOperation:function(d,g,j){var o=l(d,"projectid"),
n=this.getProjectTreeObjectByProjectIdOrThrowException(o);d={previous_last_modified:projecttreeobject.getLastModified(n),previous_completed:projecttreeobject.getCompleted(n)};projecttreeobject.setCompleted(n,g);projecttreeobject.setLastModified(n,g);if(!j){g=this.projectTree.getProjectReferenceByProjectId(o).getMatchingDomProject();g.length==1&&g.addClass("done")}return d},applyUncompleteOperation:function(d,g,j){var o=l(d,"projectid"),n=this.getProjectTreeObjectByProjectIdOrThrowException(o);d={previous_last_modified:projecttreeobject.getLastModified(n),
previous_completed:projecttreeobject.getCompleted(n)};projecttreeobject.setCompleted(n,false);projecttreeobject.setLastModified(n,g);if(!j){g=this.projectTree.getProjectReferenceByProjectId(o).getMatchingDomProject();if(g.length==1)g.removeClass("done");else{g=projecttreeobject.getParent(n);j=this.projectTree.getChildrenOfProjectTreeObject(g);j=utils.indexInArray(j,n);this.addProjectToDOM(g,j,function(){return $(globalprojecttreeobject.constructProjectTreeHtml(n))})}}return d},applyDeleteOperation:function(d,
g,j){var o=l(d,"projectid");d=this.getProjectTreeObjectByProjectIdOrThrowException(o,true);var n=projecttreeobject.getParent(d),q=this.projectTree.getChildrenOfProjectTreeObject(n),r=utils.indexInArray(q,d),t={previous_last_modified:projecttreeobject.getLastModified(d),priority:r};q.splice(r,1);var v=this.projectTree.getProjectIdToProjectMap(),x=this.projectTree;this.projectTree.applyToProjectSubtree(d,function(e){projecttreeobject.setLastModified(e,g);delete v[projecttreeobject.getProjectId(e)];
projecttreeobject.isAddedSubtreePlaceholder(e)&&x.registerRemovedSharedSubtreePlaceholder(e)});this.projectTree.getDeletedProjectIdToProjectMap()[o]=d;if(!j){j=this.projectTree.getProjectReferenceByProjectTreeObject(n);projecttreeobject.getTagManager(d).itemMoved(j,null);this.removeProjectFromDOM(d,n)}return t},removeProjectFromDOM:function(d,g){var j=this.projectTree.getProjectReferenceByProjectId(projecttreeobject.getProjectId(d)).getMatchingDomProject();if(j.length===1){var o=j.getParent().is(".selected");
j.clearControlsUnderProject();j.remove();globalprojecttreeobject.registerSubtreeRemovedFromDom(d);o&&refreshVisibleChildrenUnderSelectedForAddButton()}if(this.projectTree.getChildrenOfProjectTreeObject(g).length===0){j=this.projectTree.getProjectReferenceByProjectTreeObject(g).getMatchingDomProject();j.length===1&&j.addClass("task").hideChildren("instant")}},applyUndeleteOperation:function(d,g,j){var o=l(d,"projectid");d=l(d,"priority");var n=this.projectTree.getDeletedProjectIdToProjectMap();if(!(o in
n))throw Error("No deleted project with projectid "+o);var q=n[o],r=this.getProjectTreeObjectByProjectIdOrThrowException(projecttree.getProjectIdOfProjectTreeObject(projecttreeobject.getParent(q)));delete n[o];n={previous_last_modified:projecttreeobject.getLastModified(q)};var t=this.projectTree.getProjectIdToProjectMap(),v=this.projectTree;this.projectTree.applyToProjectSubtree(q,function(x){projecttreeobject.setLastModified(x,g);t[projecttreeobject.getProjectId(x)]=x;if(projecttreeobject.isAddedSubtreePlaceholder(x)){v.registerAddedSharedSubtreePlaceholder(x);
var e=projecttreeobject.getAddedSubtree(x);e!==null&&e.getIsDefunct()&&projecttreeobject.setAddedSubtree(x,null)}});this.insertProjectIntoProjectTree(q,r,d);if(!j){j=this.projectTree.getProjectReferenceByProjectTreeObject(r);projecttreeobject.getTagManager(q).itemMoved(null,j);this.addProjectToDOM(r,d,function(){return $(globalprojecttreeobject.constructProjectTreeHtml(q))});undeleteMessageIsVisible()&&this.projectTree.isLastLocallyDeletedProjectId(o)&&setTimeout(function(){hideMessage()},1)}return n},
applyMoveOperation:function(d,g,j){var o=l(d,"projectid"),n=l(d,"parentid");d=l(d,"priority");var q=this.getProjectTreeObjectByProjectIdOrThrowException(o,true);o=this.getProjectTreeObjectByProjectIdOrThrowException(n);n=projecttreeobject.getParent(q);var r=this.projectTree.getChildrenOfProjectTreeObject(n),t=utils.indexInArray(r,q),v={previous_parentid:projecttree.getProjectIdOfProjectTreeObject(n),previous_priority:t,previous_last_modified:projecttreeobject.getLastModified(q)};r.splice(t,1);this.insertProjectIntoProjectTree(q,
o,d);projecttreeobject.setLastModified(q,g);if(!j){g=this.projectTree.getProjectReferenceByProjectTreeObject(n);j=this.projectTree.getProjectReferenceByProjectTreeObject(o);projecttreeobject.getTagManager(q).itemMoved(g,j);this.removeProjectFromDOM(q,n);this.addProjectToDOM(o,d,function(){return $(globalprojecttreeobject.constructProjectTreeHtml(q))})}return v},insertProjectIntoProjectTree:function(d,g,j){projecttreeobject.getProjectId(d);var o=this.projectTree.getChildrenOfProjectTreeObject(g);o.splice(j>=
o.length?o.length:j,0,d);projecttreeobject.setParent(d,g)},applyShareOperation:function(d,g,j){var o=l(d,"projectid"),n="share_type"in d?d.share_type:"url",q="write_permission"in d?d.write_permission:null;if(n!=="url"&&n!=="email")throw Error("Encountered 'share' operation with unrecognized share_type: '"+n+"'");var r=this.getProjectTreeObjectByProjectIdOrThrowException(o),t=projecttreeobject.getSharedInfo(r),v=null;if(t!==null)v=t.isSharedViaUrl()?"url":"email";d={previous_share_type:v,previous_last_modified:projecttreeobject.getLastModified(r)};
if(v==="url")d.previous_write_permission=t.getUrlSharingWritePermission();if(t===null){t=new sharing.ItemSharedInfo;projecttreeobject.setSharedInfo(r,t)}if(n==="url")t.shareViaUrl(q);else n==="email"&&t.shareViaEmail();projecttreeobject.setLastModified(r,g);if(!j){g=this.projectTree.getProjectReferenceByProjectId(o);j=g.getMatchingDomProject();j.length===1&&j.addClass("shared");sharing.updateShareDialogIfOpenToProject(g)}return d},applyUnshareOperation:function(d,g,j){var o=l(d,"projectid"),n=this.getProjectTreeObjectByProjectIdOrThrowException(o);
d=projecttreeobject.getSharedInfo(n);d={previous_shared_info:d!==null?d.makeCopyOfRawSharedInfo():null,previous_last_modified:projecttreeobject.getLastModified(n)};projecttreeobject.setSharedInfo(n,null);projecttreeobject.setLastModified(n,g);if(!j){g=this.projectTree.getProjectReferenceByProjectId(o);j=g.getMatchingDomProject();j.length===1&&j.removeClass("shared");sharing.updateShareDialogIfOpenToProject(g)}return d},applyAddSharedEmailOperation:function(d,g,j){var o=l(d,"projectid"),n=l(d,"shared_email"),
q=l(d,"write_permission"),r=l(d,"access_token"),t=this.getProjectTreeObjectByProjectIdOrThrowException(o),v=projecttreeobject.getSharedInfo(t);if(v===null||!v.isSharedViaEmail())throw Error("'add_shared_email' applied to an item that isn't shared by email.");d={previous_last_modified:projecttreeobject.getLastModified(t)};var x=v.getInfoForEmail(n);if(x!==null)d.previous_write_permission=x.write_permission;v.addSharedEmail(n,q,r);projecttreeobject.setLastModified(t,g);if(!j){g=this.projectTree.getProjectReferenceByProjectId(o);
sharing.updateShareDialogIfOpenToProject(g)}return d},applyRemoveSharedEmailOperation:function(d,g,j){var o=l(d,"projectid"),n=l(d,"shared_email"),q=this.getProjectTreeObjectByProjectIdOrThrowException(o),r=projecttreeobject.getSharedInfo(q);if(r===null||!r.isSharedViaEmail())throw Error("'remove_shared_email' applied to an item that isn't shared by email.");var t=r.getInfoForEmail(n);if(t===null)throw Error("'remove_shared_email' applied to item that isn't shared for the given email.");d={write_permission:t.write_permission,
access_token:t.access_token,previous_last_modified:projecttreeobject.getLastModified(q)};if("user_id"in t)d.user_id=t.user_id;r.removeSharedEmail(n);projecttreeobject.setLastModified(q,g);if(!j){g=this.projectTree.getProjectReferenceByProjectId(o);sharing.updateShareDialogIfOpenToProject(g)}return d},applyRegisterSharedEmailUserOperation:function(d,g,j){var o=l(d,"projectid"),n=l(d,"access_token"),q="user_id"in d?d.user_id:null,r=this.getProjectTreeObjectByProjectIdOrThrowException(o),t=projecttreeobject.getSharedInfo(r);
if(t===null||!t.isSharedViaEmail())throw Error("'register_shared_email_user' applied to an item that isn't shared by email.");d={previous_last_modified:projecttreeobject.getLastModified(r)};var v=t.getSharedEmailUserId(n);if(v!==null)d.previous_user_id=v;t.registerSharedEmailUser(n,q);projecttreeobject.setLastModified(r,g);if(!j){g=this.projectTree.getProjectReferenceByProjectId(o);sharing.updateShareDialogIfOpenToProject(g)}return d},applyMakeSharedSubtreePlaceholderOperation:function(d){var g=l(d,
"projectid");d=l(d,"added_shared_project_projectid");if(this.projectTree.isShared())throw Error("Trying to run make_shared_subtree_placeholder in a shared tree.");g=this.getProjectTreeObjectByProjectIdOrThrowException(g);if(this.projectTree.projectTreeObjectHasSharedAncestor(g))throw Error("Trying to run make_shared_subtree_placeholder on a project with a shared ancestor.");if(this.projectTree.getChildrenOfProjectTreeObject(g).length>0)throw Error("Trying to run make_shared_subtree_placeholder on a project with children.");
if(this.projectTree.getProjectTreeObjectByProjectId(d)!==undefined)throw Error("Trying to add the user's own shared subtree to their account.");if(this.projectTree.getSharedSubtreePlaceholder(d))throw Error("Trying to add a shared subtree that's already been added.");projecttreeobject.setAddedSubtreeProjectId(g,d);d=projecttree.getProjectTreeByRootProjectId(d);d!==null&&projecttreeobject.setAddedSubtree(g,d);this.projectTree.registerAddedSharedSubtreePlaceholder(g);return null},undoLocalOperations:function(d){this.applyOperations(b(d))},
getProjectTreeObjectByProjectIdOrThrowException:function(d,g){if(g===undefined)g=false;var j=this.projectTree.getProjectTreeObjectByProjectId(d);if(j===undefined)throw Error("No project tree object with projectid "+d);if(j!==null&&projecttreeobject.isAddedSubtreePlaceholder(j)&&!g)throw Error("Tried to perform disallowed operation on placeholder with projectid "+d);return j}}),createOperation:a,createOperationWithUndoData:c,convertOperationToNewContentTextFormat:function(d){var g=d.type;d=d.data;
var j=false;if(g==="edit"){if("name"in d){g=content_text.xmlEscapeTextForContentText(d.name);if(g!==d.name){d.name=g;j=true}}if("description"in d){g=content_text.xmlEscapeTextForContentText(d.description);if(g!==d.description){d.description=g;j=true}}}else if(g==="bulk_create"){g=JSON.parse(d.project_trees);var o=function(q){if("nm"in q){var r=content_text.xmlEscapeTextForContentText(q.nm);if(r!==q.nm){q.nm=r;j=true}}if("no"in q){r=content_text.xmlEscapeTextForContentText(q.no);if(r!==q.no){q.no=
r;j=true}}if("ch"in q){q=q.ch;for(r=0;r<q.length;r++)o(q[r])}},n=0;for(;n<g.length;n++)o(g[n]);if(j)d.project_trees=JSON.stringify(g)}return j},invertLocalOperation:k,saveClientViewState:function(d,g){if(d===undefined)saveEditngContentText=true;if(g===undefined)g=true;var j=projecttree.getProjectReferenceFromDomProject(selectOnActivePage(".selected")),o=getCurrentlyFocusedContent(),n=null;if(o!==null){n={};n.projectReference=projecttree.getProjectReferenceFromDomProject(o.getProject());if(o.isName())n.contentType=
"name";else if(o.isNote())n.contentType="note";n.caret=o.getCaret();if(d){o=content.getContentText();if(o!==content.getLastSavedContentText())n.changedContentText=o}if(g){o=tagging.getTagAutocompleter();if(o.isAttached())n.tagAutocompleterState=o.saveState()}}return{selectedProjectReference:j,editingContentInfo:n,formatFlags:FORMAT_FLAGS.copy()}},restoreClientViewState:function(d,g,j){if(g===undefined)g=false;if(j===undefined)j="doNotScrollIfOnScreen";var o=d.selectedProjectReference,n=d.editingContentInfo;
d=d.formatFlags;o.isValid()||(o=projecttree.getMainProjectTree().getRootProjectReference());selectProjectReferenceInstantly(o,g);if(n!==null){g=n.projectReference.getMatchingDomProject();if(g.length===1&&g.is(":visible")){o=null;if(n.contentType==="name")o=g.getName().children(".content");else if(n.contentType==="note"){o=g.getNotes().children(".content");g.addClass("noted")}if(o!==null){"changedContentText"in n&&o.setContentText(n.changedContentText,n.contentType==="note");o.setCaret(n.caret.start,
n.caret.end,j);"tagAutocompleterState"in n&&tagging.getTagAutocompleter().restoreState(o,n.tagAutocompleterState)}}}FORMAT_FLAGS=d}}}(),pushpoll=function(){function a(){return o!==null}function c(){var w=projecttree.getAllProjectTreesHelper().haveInFlightOperations()||projecttree.getAllProjectTreesHelper().havePendingOperations();w=j&&n?"saving":w?"saveNow":"saved";$(".saveButton").removeClass("saving saveNow saved").addClass(w)}function f(){var w=projecttree.getAllProjectTreesHelper().getLastPushPollCompleteTimestamp();
w=datetime.getCurrentTimeInMS()-w;w=datetime.convertMillisecondsToTimeDeltaString(w);$(".lastSyncedString").text(w)}function b(w,u,A,B){if(w===undefined)w=false;if(u===undefined)u=false;if(A===undefined)A=false;if(B===undefined)B=false;if(!j){var E=a();if(A){A=datetime.getCurrentTimeInMS();var H=projecttree.getAllProjectTreesHelper().getLastPushPollCompleteTimestamp();if(A-H>6E5)q=true}if(v){if(E)return;w=d;o=setTimeout(k,w);n=projecttree.getAllProjectTreesHelper().haveInFlightOperations()}else{H=
E&&n;if(A=projecttree.getAllProjectTreesHelper().havePendingOperations()){if(H&&!w)return;w=w?1:B?d:l}else{if(H||E&&!u)return;if(!WINDOW_FOCUSED)return;w=u?1:projecttree.getAllProjectTreesHelper().getMinPollingInterval()}if(E){clearTimeout(o);o=null}o=setTimeout(k,w);n=A}utils.debugMessage("Scheduled "+(v?"REDO ":"")+"push/poll (type: "+(n?"push":"poll")+") to happen in "+w+" ms.")}}function k(){utils.debugMessage("pushAndPollServer called"+(v?" (in redo mode)":""));o=null;if(j||!v&&t.getValue()!==
null)ui_sugar.showAlertDialog("BAD: pushAndPollServer called while one is already in progress");else{j=true;var w,u;if(v){w=projecttree.getAllProjectTreesHelper().haveInFlightOperations();u=projecttree.getAllProjectTreesHelper().getPushPollData()}else{t.setValue(urls.generateUrlSafeRandomString(s));w=projecttree.getAllProjectTreesHelper().havePendingOperations();u=projecttree.getAllProjectTreesHelper().beginPushAndPoll()}FULL_OFFLINE_ENABLED?setTimeout(c,100):c();var A=function(){utils.debugMessage("pushAndPollServer failed. Retrying...");
g++;if(w)v=true;m();if(FULL_OFFLINE_ENABLED){if(g>0)if(q||g>=2){x=true;e||$("#offlineNotice").is(":visible")||$("#offlineNotice").slideDown()}}else if(w&&g>=2){g===2&&ui_sugar.showAlertDialog("We are unable to save your changes right now.<br /><br />Your internet connection may be down, or we may be unable to contact the server. Your changes will be saved when we can reconnect.","Warning");showMessage("<strong>Warning: We are unable to save your changes right now.</strong><br>Your changes will be saved when we can reconnect to the server.",
true,"connectionErrorMessage")}};u={client_id:CLIENT_ID,client_version:CLIENT_VERSION,push_poll_id:t.getValue(),push_poll_data:JSON.stringify(u)};if(projecttree.getMainProjectTree().isShared())u.shared_projectid=projecttree.getMainProjectTree().getRootProjectId();if(SEND_TIMEZONE_TO_SERVER)u.timezone=TIMEZONE_INFO.olson_tz;if(v)u.is_redo="true";if(FULL_OFFLINE_ENABLED)u.full_offline_enabled="true";u={url:"/push_and_poll",data:u,dataType:"json",type:"POST",success:function(B){function E(){var J=v;
j=false;t.setValue(null);var L=SEND_TIMEZONE_TO_SERVER=v=false,K=false,N=false;J=projecttree.getAllProjectTreesHelper().completePushAndPoll(H,J);if(!J.invalidData){L=true;K=J.errorEncounteredRunningClientOperationsOnServer;N=J.errorEncounteredRunningRemoteOperationsOnClient}c();f();if(L)if(K)showMessage("We're sorry, the server encountered an error while saving your data. Please <a href='#' class='refresh'>reload the page</a> and try again.",true);else N&&showMessage("An unexpected error occurred when applying the changes made in another session for this account. Please <a href='#' class='refresh'>reload the page</a> before continuing.",
true);else showMessage("We're sorry, the server returned an unexpected response. Please <a href='#' class='refresh'>reload the page</a> and try again.",true);"alert_message"in H&&ui_sugar.showAlertMessage(H.alert_message);"dropdown_message"in H&&showMessage(H.dropdown_message,true);b();w&&!projecttree.getAllProjectTreesHelper().havePendingOperations()&&apphooks.notifyThatAllChangesAreSaved()}if(B==null)A();else{utils.debugMessage("pushAndPollServer succeeded!");g=0;q=false;if(FULL_OFFLINE_ENABLED){x=
false;$("#offlineNotice").is(":visible")&&$("#offlineNotice").slideUp()}else $("#message.connectionErrorMessage:visible").length>0&&hideMessage();if("logged_out"in B&&B.logged_out)showLoginPopup();else{var H=B;projecttree.getAllProjectTreesHelper().markIfRefreshedProjectTreeNeededForRemoteUndeletes(H);FULL_OFFLINE_ENABLED&&projecttree.getAllProjectTreesHelper().needRefreshedProjectTreesOrAddedSharedSubtrees(H)?h(H,E):E()}}},error:A};if(!projecttree.getAllProjectTreesHelper().haveInFlightOperations())u.timeout=
3E4;$.ajax(u)}}function m(){j=false;if(!v){t.setValue(null);projecttree.getAllProjectTreesHelper().resetPushAndPoll()}c();b(false,false,false,true)}function h(w,u){function A(B){utils.debugMessage("New project tree data loaded. Attaching refreshed project trees and adding shared subtrees.");B=B.projectTreeData;var E=w;B.clientId!==CLIENT_ID&&projecttree.getAllProjectTreesHelper().extractRefreshedProjectTreesAndNewlyAddedSharedSubtreesFromNewProjectTreeData(B,E);u()}utils.debugMessage("getRefreshedProjectTreesAndAddedSharedSubtrees called");
IS_CHROME_APP?fetchInitializationData(function(B){writeInitializationDataToIndexedDB(B);A(B)}):appcachehelper.markCacheManifestDirtyAndThenUpdate(function(B){if(B){utils.debugMessage("App cache updated. Swapping to new cache and loading new project tree data.");appcachehelper.swapCache();fetchInitializationData(A)}else{utils.debugMessage("Failed to update app cache.");u()}})}var l=null,d=5E3,g=0,j=false,o=null,n=false,q=false,r=null,t=null,v=false,x=false,e=false,p=null,s=8;return{init:function(){l=
USE_EXPERIMENTAL_PUSHPOLL_TIMINGS?1:5E3;c();f();t=new userstorage.PersistentValue("pushpoll","currentId",null);var w=projecttree.getAllProjectTreesHelper().pushPollIsInProgress();if(w&&t.getValue()===null)throw new userstorage.InitializationError;if(t.getValue()!==null){var u=false;if(w)if(projecttree.getAllProjectTreesHelper().haveInFlightOperations()){utils.debugMessage("pushpoll init: Redoing push recovered from userstorage");u=n=v=true}else{utils.debugMessage("pushpoll init: Resetting poll recovered from userstorage");
projecttree.getAllProjectTreesHelper().resetPushAndPoll()}u||t.setValue(null)}w=FULL_OFFLINE_ENABLED||v?1:projecttree.getAllProjectTreesHelper().getMinPollingInterval();o=setTimeout(k,w);if(FULL_OFFLINE_ENABLED)q=true;setInterval(function(){f()},6E4)},updateSaveStatus:c,updateLastSyncedStrings:f,hideOfflineNotice:function(){e=true;if(p!==null){clearTimeout(p);p=null}$("#offlineNotice").hide()},unhideOfflineNotice:function(){e=false;if(p===null)if(x)p=setTimeout(function(){p=null;$("#offlineNotice").show()},
1)},notifyAjaxLoginComplete:function(){j&&m()},scheduleNextPushAndPoll:b,pushPollAlreadyScheduled:a,scheduleImmediatePollOnNextTick:function(){if(r===null)r=setTimeout(function(){r=null;b(false,true)},1)}}}(),location_history=function(){function a(){if(IS_CHROME_APP)return new g(projecttree.ROOT_PROJECTID);else{var j=$.address.pathNames(),o=$.address.parameter("q");return c(j,o)}}function c(j,o){if(o===undefined)o=null;return new g(j.length>0?j[0]:projecttree.ROOT_PROJECTID,o!==null?o.replace(/\+/g,
" "):null)}function f(j){if(!m.equals(j)){var o=m;m=j;b(o)}}function b(j){if(IS_CHROME_APP)if(!h)if(!(!l.isEmpty()&&j.equals(l.last()))){l.push(j);d.clear()}}function k(j){$.address.path("/"+(j!==projecttree.ROOT_PROJECTID?j:""))}var m=null,h=false,l=null,d=null,g=Class.extend({init:function(j,o){if(o===undefined)o=null;this._zoomedProjectId=j;this._searchQuery=o},getZoomedProjectId:function(){return this._zoomedProjectId},getSearchQuery:function(){return this._searchQuery},withNewZoomedProjectId:function(j){return new g(j,
this._searchQuery)},withNewSearchQuery:function(j){return new g(this._zoomedProjectId,j)},equals:function(j){return this._zoomedProjectId===j._zoomedProjectId&&this._searchQuery===j._searchQuery}});return{init:function(){l=new utils.Stack(200,100);d=new utils.Stack;if(!IS_CHROME_APP){$.address.tracker(null);if(appdetect.isIOSApp())if(userstorage.isEnabled()){var j=userstorage.read(URL_HASH_USERSTORAGE_KEY);j!==null&&$.address.value(j)}}m=a()},getLocationFromWindowHref:a,getLocationFromFragment:function(j){j=
urls.parseUrlFragment(j);return c(j.pathNames,j.parameters.q)},notifyZoomChange:function(j){!IS_CHROME_APP&&!h&&k(j);f(m.withNewZoomedProjectId(j))},notifySearchChange:function(j){if(j!==null&&j.length===0)j=null;!IS_CHROME_APP&&!h&&$.address.parameter("q",j);f(m.withNewSearchQuery(j))},notifyLocationChange:function(j){f(j)},notifyExternalFragmentChange:function(){var j=a();f(j)},setLocationModificationInProgress:function(j){if(!h&&j)b(m);else if(h&&!j)if(!IS_CHROME_APP){$.address.autoUpdate(false);
var o=m.getSearchQuery();$.address.parameter("q",o);$.address.autoUpdate(true);k(m.getZoomedProjectId())}h=j},navigateBackward:function(){if(!l.isEmpty()){var j=l.pop();d.push(m);m=j;selectAndSearchUsingLocation(j)}},navigateForward:function(){if(!d.isEmpty()){var j=d.pop();l.push(m);m=j;selectAndSearchUsingLocation(j)}}}}(),undoredo=function(){function a(){saveEditingContent();var g;if(h.isEmpty())g=null;else{g=h.pop();var j=f(g);l.push(j);g=g}if(g===null)return false;b(g);m();return true}function c(){saveEditingContent();
var g;if(l.isEmpty())g=null;else{g=l.pop();var j=f(g);h.push(j);g=g}if(g===null)return false;b(g);m();return true}function f(g){for(var j=[],o=g.operationInfos.length-1;o>=0;o--)for(var n=g.operationInfos[o],q=operations.invertLocalOperation(n.operation),r=0;r<q.length;r++)j.push({operation:q[r],projectTreeReference:n.projectTreeReference});return{operationInfos:j,preBatchClientViewState:g.postBatchClientViewState,postBatchClientViewState:g.preBatchClientViewState}}function b(g){var j=g.operationInfos;
g=g.postBatchClientViewState;blurFocusedContentOrInput();for(var o=false,n=0;n<j.length;n++){var q=j[n],r=q.operation;q=q.projectTreeReference.getProjectTree();if(q===null)o=true;else{r=q.applyLocalOperationAndAddToPendingQueue(r.type,r.data,r.undo_data);o&=r}}o||operations.restoreClientViewState(g)}function k(){return operations.saveClientViewState(false,false)}function m(){h.isEmpty()?$(".undo-button").removeClass("enabled"):$(".undo-button").addClass("enabled");l.isEmpty()?$(".redo-button").removeClass("enabled"):
$(".redo-button").addClass("enabled")}var h=null,l=null,d=null;return{init:function(){h=new utils.Stack(200,100);l=new utils.Stack;$(".undo-button.enabled").live("click",function(){a()});$(".redo-button.enabled").live("click",function(){c()})},startOperationBatch:function(g,j){if(g===undefined)g=false;if(j===undefined)j=null;if(d!==null){utils.debugAlert("Trying to start operation batch while one is already in progress.");_gaq.push(["_trackEvent","Miscellaneous","Trying to start operation batch while one is already in progress."])}else{g||
saveEditingContent();if(j===null)j=k();d={operationInfos:[],preBatchClientViewState:j,postBatchClientViewState:null};l.clear()}},addOperationToCurrentBatch:function(g,j){if(d===null){ui_sugar.showAlertDialog("Trying to add to operation batch while none are in progress.");_gaq.push(["_trackEvent","Miscellaneous","Trying to add to operation batch while none are in progress."])}d.operationInfos.push({operation:g,projectTreeReference:j})},finishOperationBatch:function(){if(d===null){utils.debugAlert("Trying to finish operation batch while none are in progress.");
_gaq.push(["_trackEvent","Miscellaneous","Trying to finish operation batch while none are in progress."])}else{var g=d;d=null;if(g.operationInfos.length!==0){g.postBatchClientViewState=k();g=f(g);h.push(g);m()}}},undo:a,redo:c,clearStacks:function(){h.clear();l.clear()},saveClientViewStateForUndoRedo:k}}(),search=function(){function a(){return r!==null}function c(y){return y.getUniqueIdentifier()in t}function f(y,D,G){if(D===undefined)D=false;if(G===undefined)G=null;y=new v(y);var I=false;if(y.isEmpty()){if(a()){k(D);
I=true}}else{b(y,D,G);I=true}I&&!D&&reconstructDomProjectTree()}function b(y,D,G){if(D===undefined)D=false;if(G===undefined)G=null;r=null;t={};m();G=G;if(G===undefined)G=null;var I=y.isOnlyNots();G=G===null?projecttree.getProjectReferenceFromDomProject(selectOnActivePage(".selected")):G;h(G.getProjectTreeObject(),y,I,true);r=y;getActivePage().addClass("searching");IS_MOBILE||$("#searchCancel").show();if(D||!$(document.activeElement).is("#searchBox"))g(y.getSearchString());D||savedviews.notifyViewChanged()}
function k(y){if(y===undefined)y=false;r=null;t={};m();getActivePage().removeClass("searching");IS_MOBILE||$("#searchCancel").hide();if(y||!$(document.activeElement).is("#searchBox"))g("");y||savedviews.notifyViewChanged()}function m(){projecttree.getAllProjectTreesHelper().applyToAllProjectTrees(function(y){y.applyToProjectSubtree(null,projecttreeobject.clearSearchResult);var D=y.getDeletedProjectIdToProjectMap(),G;for(G in D)y.applyToProjectSubtree(D[G],projecttreeobject.clearSearchResult)})}function h(y,
D,G,I,O){if(I===undefined)I=false;if(O===undefined)O=false;var P=y!==null?globalprojecttreeobject.isCompleted(y):false;P|=O;var R=O=false;if(!G||I||globalprojecttreeobject.isExpanded(y))for(var S=globalprojecttreeobject.getChildren(y),z=0;z<S.length;z++){I=h(S[z],D,G,false,P);O|=I.uncompletedDescendantMatches;R|=I.completedDescendantMatches}G=false;if(y!==null){I=S=false;I=D.matches(y);G=I.matches;S=I.nameMatches;I=I.noteMatches;if(G||O||R){D=new K(G,O,R,S,I);globalprojecttreeobject.setSearchResult(y,
D)}}return{uncompletedDescendantMatches:!P&&G||O,completedDescendantMatches:P&&G||R}}function l(){if("search"in TIMEOUTS){clearTimeout(TIMEOUTS.search);delete TIMEOUTS.search}f($("#searchBox").val());$(window).scrollTop(0);clearTimeout(TIMEOUTS.setSearchInFragment);TIMEOUTS.setSearchInFragment=setTimeout(function(){location_history.notifySearchChange($("#searchBox").val())},1E3)}function d(){clearTimeout(TIMEOUTS.search);TIMEOUTS.search=setTimeout(function(){var y=$("#searchBox").val();clearTimeout(TIMEOUTS.search);
if(!(a()&&y===r.getSearchString())){y=y.length;TIMEOUTS.search=setTimeout(function(){l()},y==0||y>2?1:500)}},1)}function g(y){$("#searchBox").val(y);var D=$.trim(y);D.length>0?$("#searchForm").addClass("clearPrompt"):$("#searchForm").removeClass("clearPrompt");location_history.notifySearchChange(D.length>0?y:null)}function j(y){g(y);l()}function o(){if(a())if(IS_MOBILE)$("#searchBox").val("").blur();else{$("#searchBox").val("");l()}}function n(){var y=null;if(getCurrentlyFocusedContent()!==null){saveEditingContent();
y=operations.saveClientViewState()}blurFocusedContentOrInput();o();y!==null&&operations.restoreClientViewState(y);getCurrentlyFocusedContent()===null&&focusFirstProject()}function q(y){return $("#searchBox").val().match(RegExp("(^|\\s)"+y+"(?=$|\\s)","ig"))!==null}var r=null,t={},v=Class.extend({init:function(y){function D(C){C=C.split(/\s+/);for(var M=0;M<C.length;M++){var Q=C[M];Q.length>0&&G.push(Q)}}for(var G=[],I=RegExp('(^|\\s)(-?"[^"]*")($|\\s)',"g"),O=0;;){var P=I.exec(y);if(P==null)break;
var R=P[0],S=P[2];P=P.index;D(y.substring(O,P));G.push(S);O=P+R.length}D(y.substring(O));O=y.length>0&&y.charAt(y.length-1).match(/\s/)!==null;R=[];I=[R];for(S=0;S<G.length;S++){var z=G[S];if(z==="OR"){R=[];I.push(R)}else{P=false;if(z.charAt(0)==="-"){P=true;z=z.substring(1);if(z.length===0)continue}var F=z.length>=2&&z.charAt(0)==='"'&&z.charAt(z.length-1)==='"';if(!(F&&z.length===2)){z=z.toLowerCase();if(F){z=z.substring(1,z.length-1);z=new L(z)}else if(utils.isPrefixMatch(z,"last-changed:")){z=
z.split(":")[1];z=new A(z)}else if(utils.isPrefixMatch(z,"completed:")){z=z.split(":")[1];z=new B(z)}else z=z==="is:shared"?new E:z==="is:complete"?new H:z==="is:embedded"?new J:new w(z,S===G.length-1&&!O);if(P)z=new e(z);R.push(z)}}}O=[];for(R=0;R<I.length;R++){S=I[R];if(S.length!==0){S=S.length>1?new p(S):S[0];O.push(S)}}I=O.length===0?new p([]):O.length>1?new s(O):O[0];this.searchString=y;this.rootNode=I},getSearchString:function(){return this.searchString},matches:function(y){return this.rootNode.matches(y)},
getMatchingChars:function(y,D){var G=Array(y.length);this.rootNode.markMatchingChars(y,G,D);return G},isEmpty:function(){return this.rootNode.isEmpty()},isOnlyNots:function(){return this.rootNode.isOnlyNots()}}),x=Class.extend({init:function(){},matches:function(){return{matches:false,nameMatches:false,noteMatches:false}},markMatchingChars:function(){},isEmpty:function(){return false},isOnlyNots:function(){return false}}),e=x.extend({init:function(y){this._super();this.child=y},matches:function(y){y=
this.child.matches(y);y.matches=!y.matches;if(!y.matches)y.nameMatches=y.noteMatches=false;return y},isOnlyNots:function(){return true}}),p=x.extend({init:function(y){this._super();this.children=y},matches:function(y){for(var D=false,G=false,I=0;I<this.children.length;I++){var O=this.children[I].matches(y);if(!O.matches)return{matches:false,nameMatches:false,noteMatches:false};D|=O.nameMatches;G|=O.noteMatches}return{matches:true,nameMatches:D,noteMatches:G}},markMatchingChars:function(y,D,G){for(var I=
0;I<this.children.length;I++)this.children[I].markMatchingChars(y,D,G)},isEmpty:function(){for(var y=0;y<this.children.length;y++)if(!this.children[y].isEmpty())return false;return true},isOnlyNots:function(){if(this.children.length===0)return false;for(var y=0;y<this.children.length;y++)if(!this.children[y].isOnlyNots())return false;return true}}),s=x.extend({init:function(y){this._super();this.children=y},matches:function(y){for(var D=false,G=false,I=false,O=0;O<this.children.length;O++){var P=
this.children[O].matches(y);D|=P.matches;G|=P.nameMatches;I|=P.noteMatches}return{matches:D,nameMatches:G,noteMatches:I}},markMatchingChars:function(y,D,G){for(var I=0;I<this.children.length;I++)this.children[I].markMatchingChars(y,D,G)},isEmpty:function(){for(var y=0;y<this.children.length;y++)if(!this.children[y].isEmpty())return false;return true},isOnlyNots:function(){if(this.children.length===0)return false;for(var y=0;y<this.children.length;y++)if(this.children[y].isOnlyNots())return true;return false}}),
w=x.extend({init:function(y,D){this._super();var G=utils.regExpEscapeString(y),I="(?=$|[^"+WORD_CHARS_PLUS_DIGITS+"])";G="(^|[^"+WORD_CHARS_PLUS_DIGITS+"])("+G+")";D||(G+=I);this.term=y;this.termRegExp=XRegExp(G,"ig")},matches:function(y){var D={};D.nameMatches=globalprojecttreeobject.hasName(y)&&globalprojecttreeobject.getNameInPlainText(y).match(this.termRegExp)!==null;D.noteMatches=globalprojecttreeobject.hasNote(y)&&globalprojecttreeobject.getNoteInPlainText(y).match(this.termRegExp)!==null;D.matches=
D.nameMatches||D.noteMatches;return D},markMatchingChars:function(y,D,G){for(this.termRegExp.lastIndex=0;;){var I=this.termRegExp.exec(y);if(I==null)break;var O=I[2];for(var P=I=I.index+I[1].length;P<I+O.length;P++)D[P]=G}}}),u=x.extend({init:function(y){this._super();var D=parseInt(y);if(isNaN(D)||D<0)D=0;if(y.length>0){y=y.charAt(y.length-1);if(y==="h")D*=60;else if(y==="d")D*=1440}var G={};projecttree.getAllProjectTreesHelper().applyToAllProjectTrees(function(I){G[I.getTreeId()]=I.getCurrentClientTimestamp()});
this.minutesToGoBack=D;this.treeIdToCurrentClientTimestampMap=G}}),A=u.extend({init:function(y){this._super(y)},matches:function(y){var D=globalprojecttreeobject.getLastModified(y);return{matches:this.treeIdToCurrentClientTimestampMap[globalprojecttreeobject.getProjectTree(y).getTreeId()]-D<this.minutesToGoBack,nameMatches:false,noteMatches:false}}}),B=u.extend({init:function(y){this._super(y)},matches:function(y){var D=false;if(globalprojecttreeobject.isCompleted(y)){D=globalprojecttreeobject.getCompleted(y);
D=this.treeIdToCurrentClientTimestampMap[globalprojecttreeobject.getProjectTree(y).getTreeId()]-D<this.minutesToGoBack}return{matches:D,nameMatches:false,noteMatches:false}}}),E=x.extend({init:function(){this._super()},matches:function(y){return{matches:globalprojecttreeobject.getSharedInfo(y)!==null,nameMatches:false,noteMatches:false}}}),H=x.extend({init:function(){this._super()},matches:function(y){return{matches:globalprojecttreeobject.isCompleted(y),nameMatches:false,noteMatches:false}}}),J=
x.extend({init:function(){this._super()},matches:function(y){return{matches:globalprojecttreeobject.isAddedSubtreePlaceholder(y),nameMatches:false,noteMatches:false}}}),L=x.extend({init:function(y){this._super();var D=utils.regExpEscapeString(y);this.literalString=y;this.literalStringRegExp=XRegExp(D,"ig")},matches:function(y){var D={};D.nameMatches=globalprojecttreeobject.hasName(y)&&globalprojecttreeobject.getNameInPlainText(y).match(this.literalStringRegExp)!==null;D.noteMatches=globalprojecttreeobject.hasNote(y)&&
globalprojecttreeobject.getNoteInPlainText(y).match(this.literalStringRegExp)!==null;D.matches=D.nameMatches||D.noteMatches;return D},markMatchingChars:function(y,D,G){for(this.literalStringRegExp.lastIndex=0;;){var I=this.literalStringRegExp.exec(y);if(I==null)break;for(var O=I[0],P=I.index;P<I.index+O.length;P++)D[P]=G}}}),K=Class.extend({init:function(y,D,G,I,O){this.matches=y;this.uncompletedDescendantMatches=D;this.completedDescendantMatches=G;this.nameMatches=I;this.noteMatches=O},isExpandedForSearch:function(y){return c(y)?
y.isExpanded():this.isByDefaultExpandedForSearch()},isByDefaultExpandedForSearch:function(){return this.uncompletedDescendantMatches||this.completedDescendantMatches},isNeverVisibleForSearch:function(y,D){if(this.matches||this.uncompletedDescendantMatches||D&&this.completedDescendantMatches||c(y))return false;var G=globalprojecttreeobject.getParent(y.getProjectTreeObject());if(G===null||globalprojecttreeobject.getSearchResult(G).isByDefaultExpandedForSearch())return true;return false},getAdditionalClassesForSearch:function(y){var D=
{project:"",name:"",note:""};y=c(y);if(this.matches||y){D.project+="matches ";if(y||!this.uncompletedDescendantMatches&&!this.completedDescendantMatches)D.project+="terminalMatch "}if(this.uncompletedDescendantMatches)D.project+="uncompletedDescendantMatches ";if(this.completedDescendantMatches)D.project+="completedDescendantMatches ";if(this.nameMatches)D.name+="matches ";if(this.noteMatches)D.note+="matches ";return D}}),N=new K(false,false,false,false,false);return{init:function(){function y(){IS_MOBILE||
d()}function D(){if(a())n();else IS_MOBILE&&$("#searchBox").val("").blur();return false}$("#searchBox").val("");$("#searchForm").submit(function(){IS_MOBILE?$("#searchBox").blur():l();return false});var G=$("#searchPrompt");if(IS_MOBILE){G.live("touchstart",function(){$(this).tapIt()});G.live("touchend",function(){function I(){$("#searchBox").focus()}$("#searchForm").addClass("clearPrompt");IS_IOS?dom_utils.executeAfterRepaint(I):I();return false})}else G.click(function(){$("#searchBox").focus()});
G=$("#searchBox");G.bind("keydown",function(I){var O=$(this);if(!IS_MOBILE){setTimeout(function(){tagging.getTagAutocompleter().updateDisplay(O)},1);I.keyCode===$.ui.keyCode.TAB||I.keyCode===$.ui.keyCode.ESCAPE||I.keyCode===$.ui.keyCode.DOWN||d()}});G.bind("keypress",function(I){var O=$(this);if(!IS_MOBILE){I=String.fromCharCode(I.which);tagging.isTagStartChar(I)&&tagging.getTagAutocompleter().attach(O,I)}});G.bind("cut",y);G.bind("paste",y);G.bind("click",function(){tagging.getTagAutocompleter().detach()});
G.focus(function(){$("#searchForm").addClass("clearPrompt")});G.blur(function(){var I=$.trim($(this).val()).length===0,O=$("#searchForm");I?O.removeClass("clearPrompt"):O.addClass("clearPrompt");tagging.getTagAutocompleter().detach();IS_MOBILE&&l()});G=key_events.enableKeyEvents(G,"true");G.addHandler("keydown","tab",function(){if(tagging.getTagAutocompleter().autocompleteSelectedTag($(this)))return false;focusFirstProject();return false});G.addHandler("keydown","return",function(){if(tagging.getTagAutocompleter().autocompleteSelectedTag($(this)))return false});
G.addHandler("keydown","up",function(){if(tagging.getTagAutocompleter().moveSelection($(this),"up"))return false});G.addHandler("keydown","down",function(){if(tagging.getTagAutocompleter().moveSelection($(this),"down"))return false;if($(this).caretAtEndOfText()){focusFirstProject();return false}});IS_MOBILE?$("#searchCancel").tapHandler(function(){return false},D):$("#searchCancel").click(D).mousedown(function(){return false})},inSearchMode:a,getSearchQuery:function(){return r},getNonMatchItemSearchResult:function(){return N},
registerLocallyCreatedItemForCurrentSearch:function(y){if(a())t[y.getUniqueIdentifier()]=true},isLocallyCreatedItemForCurrentSearch:c,setSearchBoxAndSearch:j,cancelSearch:o,cancelSearchAsUserAction:n,reapplyCurrentSearch:function(){a()&&b(r)},searchProjectTree:f,exitSearchMode:k,searchWithSearchBoxAfterChange:d,tagIsInCurrentSearch:q,toggleTagInCurrentSearch:function(y){var D=$("#searchBox").val();if(q(y))D=D.replace(RegExp("(^|\\s)"+y+"(?=$|\\s)","ig"),"");else D+=" "+y;D=$.trim(D);if(D.length>0)D+=
" ";j(D)}}}(),tagging=function(){function a(){if(h===null)h=new q;return h}function c(t){return d.indexOf(t)!==-1}function f(t,v,x){if(x===undefined)x=true;var e=null;if(x){e=Array(t.length);urls.forEachUrlInString(t,function(u,A){for(var B=u;B<u+A.length;B++)e[B]=true})}for(n.lastIndex=0;;){var p=n.exec(t);if(p==null)break;var s=p[2];p=p.index+p[1].length;if(!(x&&e[p]===true)){if(utils.isDigit(s.charAt(1))){var w=s.substring(1);if(w.length<4&&utils.isOnlyDigits(w))continue}v(p,s)}}}function b(t,
v){for(var x=t;x!==null;){globalprojecttreeobject.getTagManager(x).applyTagCountsDelta(v);x=globalprojecttreeobject.getParent(x)}a().add(v)}function k(){if(l===null)l=new r;return l}function m(t,v){if(v){var x=t.val();return content_text.createContentTextContainerFromPlainText(x,false)}else return new content_text.ContentText(t,t.isNote())}var h=null,l=null,d="#@",g="["+WORD_CHARS_PLUS_DIGITS+"]["+WORD_CHARS_PLUS_DIGITS+"\\-_]*",j=g+"(:("+g+"))*",o=XRegExp("^"+(g+"(:("+g+")?)*")+"$","i"),n=XRegExp("(^|\\s|[(),.!?';:\\/\\[\\]])(["+
d+"]("+j+"))(?=$|\\s|[(),.!?';:\\/\\[\\]])","ig"),q=Class.extend({init:function(t){if(t===undefined)t=null;this.tagInfoMap=t==null?{}:utils.deepCopyObject(t.tagInfoMap)},applyTagDelta:function(t,v){var x=t.toLowerCase();if(!(x in this.tagInfoMap)){var e={count:0};if(x!==t)e.canonicalName=t;this.tagInfoMap[x]=e}this.tagInfoMap[x].count+=v;this.tagInfoMap[x].count===0&&delete this.tagInfoMap[x]},add:function(t,v){if(v===undefined)v=false;for(var x in t.tagInfoMap){var e=t.tagInfoMap[x];this.applyTagDelta("canonicalName"in
e?e.canonicalName:x,v?-e.count:e.count)}},subtract:function(t){this.add(t,true)},incrementWithString:function(t){var v=this;f(t,function(x,e){v.applyTagDelta(e,1)})},isEmpty:function(){return utils.objectIsEmpty(this.tagInfoMap)},getTagList:function(t,v,x,e){if(t===undefined)t="";if(v===undefined)v=null;if(x===undefined)x=0;if(e===undefined)e=null;t=t.toLowerCase();var p=[],s;for(s in this.tagInfoMap)if(utils.isPrefixMatch(s,t)){var w=this.tagInfoMap[s],u="canonicalName"in w?w.canonicalName:s;if(e===
null||!(s in e))p.push({tag:u,count:w.count})}p.sort(function(A,B){if(A.count===B.count){var E=utils.isDigit(A.tag.charAt(1)),H=utils.isDigit(B.tag.charAt(1));return E&&!H?1:H&&!E?-1:A.tag<B.tag?-1:1}else return A.count<B.count?1:-1});return v!==null?p.slice(x,x+v):x>0?p.slice(x):p}});g=Class.extend({init:function(t){this.pto=t;this.descendantTagCounts=this.tagCounts=null;this.nameOrNoteChanged(true)},getTagCounts:function(){return this.tagCounts!==null?this.tagCounts:new q},setDescendantTagCounts:function(t){this.descendantTagCounts=
t},nameOrNoteChanged:function(t){if(t===undefined)t=false;if(TRACK_TAG_COUNTS){var v=this.tagCounts,x=new q;globalprojecttreeobject.hasName(this.pto)&&x.incrementWithString(globalprojecttreeobject.getNameInPlainText(this.pto));globalprojecttreeobject.hasNote(this.pto)&&x.incrementWithString(globalprojecttreeobject.getNoteInPlainText(this.pto));var e=new q(x);v!==null&&e.subtract(v);if(!e.isEmpty()){this.tagCounts=x;t||b(globalprojecttreeobject.getParent(this.pto),e)}}},itemMoved:function(t,v){if(!(t!==
null&&v!==null&&v.equals(t))){var x=this.getSubtreeTagCounts();if(!x.isEmpty()){if(t!==null){var e=new q;e.subtract(x);var p=t.translateToGlobalProjectTreeObject();b(p,e)}if(v!==null){e=v.translateToGlobalProjectTreeObject();b(e,x)}}}},applyTagCountsDelta:function(t){if(this.descendantTagCounts===null)this.descendantTagCounts=new q;this.descendantTagCounts.add(t)},getSubtreeTagCounts:function(){var t=new q;this.tagCounts!==null&&t.add(this.tagCounts);this.descendantTagCounts!==null&&t.add(this.descendantTagCounts);
return t}});var r=Class.extend({init:function(){function t(v){v.siblings(".autocompleteTag.selectedAutocompleteTag").removeClass("selectedAutocompleteTag");v.addClass("selectedAutocompleteTag")}this.autocompleteBox=$("#autocompleteBox");this.cachedTagCountsSecondary=this.cachedTagCountsPrimary=this.tagStartCaretPos=this.isAttachedToSearchBox=this.content=null;this.tagListStartPos=0;this.lastStartPosSearched=this.lastPrefixSearched=null;$("#autocompleteBox > .autocompleteTag").live("mouseenter",function(){var v=
$(this);t(v)}).live("mousedown",function(){var v=$(this);t(v);k().autocompleteSelectedTag()})},isAttached:function(){return this.content!==null||this.isAttachedToSearchBox},attach:function(t,v){this.isAttached()&&this.detach();var x=t.is("#searchBox"),e="\\s|[(),.!?';:\\/\\[\\]]";if(x)e+="|-";var p=XRegExp(e,"i"),s=m(t,x);e=(x?t.getCaretForTextArea():t.getCaret()).start;if(!(e>0&&s.getPlainText().charAt(e-1).match(p)===null)){x&&this.autocompleteBox.addClass("attachedToSearchBox");s=projecttree.getProjectReferenceFromDomProject(selectOnActivePage(".selected"));
p=s.isMainTreeRoot()?a():s.getTagManager().getSubtreeTagCounts();s=x||s.isMainTreeRoot()?null:a();this.content=x?null:t;this.isAttachedToSearchBox=x;this.tagStartCaretPos=e;this.cachedTagCountsPrimary=new q(p);this.cachedTagCountsSecondary=s!==null?new q(s):null;this.tagListStartPos=0;this.autocompleteBox.appendTo("body");this.updateDisplay(t,v)}},updateDisplay:function(t,v){if(v===undefined)v=null;if(this.isAttached()){var x=t.is("#searchBox"),e=m(t,x),p=x?t.getCaretForTextArea():t.getCaret();if(this.isAttachedToSearchBox){if(!x){this.detach();
return}}else if(t[0]!==this.content[0]){this.detach();return}if(v===null&&p.start!==p.end)this.detach();else if(p.start<this.tagStartCaretPos)this.detach();else{var s=v!==null?v:e.getPlainText().substring(this.tagStartCaretPos,p.start);if(s.length===0)this.detach();else{x=s.charAt(0);e=s.substring(1);if(!c(x)||e.length>0&&e.match(o)===null)this.detach();else{if(s!==this.lastPrefixSearched||this.tagListStartPos!==this.lastStartPosSearched){if(s!==this.lastPrefixSearched)this.tagListStartPos=0;var w=
this;e=function(){var u=w.cachedTagCountsPrimary.getTagList(s,8,w.tagListStartPos);if(u.length<8&&w.cachedTagCountsSecondary!==null){for(var A=w.cachedTagCountsPrimary.getTagList(s),B={},E=0;E<A.length;E++){var H=A[E].tag.toLowerCase();B[H]=true}A=w.cachedTagCountsSecondary.getTagList(s,8-u.length,u.length>0?0:w.tagListStartPos,B);u=u.concat(A)}return u=function(J){function L(N,y){if(!_(N).some(function(G){return y===G.tag})){var D=_.chain(N).map(function(G){return G.tag.search(y)>-1?true:false}).lastIndexOf(true).value();
N.splice(D+1,0,{count:1,tag:y})}}var K=function(N){return _.chain(N).filter(function(y){return y.tag.search(":")!==-1}).map(function(y){var D=y.tag.lastIndexOf(":");return y.tag.slice(0,D+1)}).uniq(function(y,D){return y.tag!==D.tag}).value()}(J);_(K).forEach(function(N){L(J,N)});return J}(u)};x=e();if(this.tagListStartPos>0&&x.length<8){this.tagListStartPos=Math.max(this.tagListStartPos-(8-x.length),0);x=e()}this.autocompleteBox.html("");for(e=0;e<x.length;e++){p=$('<div class="autocompleteTag">'+
x[e].tag+"</div>");e===0&&p.addClass("selectedAutocompleteTag");this.autocompleteBox.append(p)}x.length===0?this.autocompleteBox.hide():this.autocompleteBox.show();this.lastPrefixSearched=s;this.lastStartPosSearched=this.tagListStartPos}if(this.isAttachedToSearchBox){e=t.offset();p=t.height();x=t.width();e={top:e.top+p+7,left:e.left};x=x}else{e=this.content.getContentCaretOffset(this.tagStartCaretPos);e.top+=IS_IE?parseInt(this.content.css("lineHeight")):5;x="auto"}this.autocompleteBox.offset({top:Math.round(e.top),
left:Math.round(e.left)});this.autocompleteBox.width(x)}}}}},detach:function(){if(this.isAttached()){this.cachedTagCountsSecondary=this.cachedTagCountsPrimary=this.tagStartCaretPos=this.isAttachedToSearchBox=this.content=null;this.tagListStartPos=0;this.lastStartPosSearched=this.lastPrefixSearched=null;this.autocompleteBox.removeClass("attachedToSearchBox");this.autocompleteBox.appendTo("#hidden")}},saveState:function(){return{isAttachedToSearchBox:this.isAttachedToSearchBox,tagStartCaretPos:this.tagStartCaretPos,
cachedTagCountsPrimary:this.cachedTagCountsPrimary,cachedTagCountsSecondary:this.cachedTagCountsSecondary}},restoreState:function(t,v){this.isAttached()&&this.detach();this.content=!v.isAttachedToSearchBox?t:null;this.isAttachedToSearchBox=v.isAttachedToSearchBox;this.tagStartCaretPos=v.tagStartCaretPos;this.cachedTagCountsPrimary=v.cachedTagCountsPrimary;this.cachedTagCountsSecondary=v.cachedTagCountsSecondary;this.autocompleteBox.appendTo("body");this.updateDisplay(t)},moveSelection:function(t,
v){var x=this.getSelectedTag();if(x===null)return false;var e;if(v==="up"){e=x.prev(".autocompleteTag");if(e.length===0){if(this.tagListStartPos===0)this.detach();else{this.tagListStartPos--;this.updateDisplay(t)}return true}}else{e=x.next(".autocompleteTag");if(e.length===0){this.tagListStartPos++;this.updateDisplay(t);x=this.getSelectedTag();e=this.getDisplayedTags().last()}}x.removeClass("selectedAutocompleteTag");e.addClass("selectedAutocompleteTag");return true},autocompleteSelectedTag:function(t){function v(){var H=
t,J=A;B?H.val(J.getPlainText()):H.setContentTextAsUserEdit(J.getText());H=t;J=E;B?H.setCaretForTextArea(J):H.setCaret(J);B&&search.searchWithSearchBoxAfterChange()}if(t===undefined)t=null;var x=this.getSelectedTag();if(x===null)return false;var e;if(t===null){t=this.isAttachedToSearchBox?$("#searchBox"):this.content;e=true}else e=false;var p=x.text();x=m(t,this.isAttachedToSearchBox);for(var s=x.getPlainText(),w=0;this.tagStartCaretPos+w<s.length&&s.charAt(this.tagStartCaretPos+w).toLowerCase()===
p.charAt(w).toLowerCase();w++);if(w===0)return false;w=this.tagStartCaretPos+w;p=p;var u=p.charAt(p.length-1);if((w===s.length||s.charAt(w).match(/\s/)===null)&&u!==":")p+=" ";var A=x.insertAtCaret(p,{start:this.tagStartCaretPos,end:w}),B=this.isAttachedToSearchBox,E=this.tagStartCaretPos+p.length;e?setTimeout(v,1):v();this.detach();return true},getSelectedTag:function(){if(!this.isAttached())return null;var t=this.autocompleteBox.find(".autocompleteTag.selectedAutocompleteTag");return t.length===
1?t:null},getDisplayedTags:function(){return this.autocompleteBox.find(".autocompleteTag")}});return{TagCounter:q,ItemTagManager:g,getTagAutocompleter:k,isTagStartChar:c,forEachTagInString:f,getRootDescendantTagCounts:a,setRootDescendantTagCounts:function(t){h=t}}}(),urls=function(){var a=XRegExp("://|\\.([a-z]{2}[a-z]*)(?=$|[^.\\-"+WORD_CHARS_PLUS_DIGITS+"]|\\.$|\\.[^"+WORD_CHARS_PLUS_DIGITS+"])","ig"),c=/^[a-z0-9]([a-z0-9\-_]*[a-z0-9])?(\.[a-z0-9]([a-z0-9\-_]*[a-z0-9])?)*$/i,f=/[a-z0-9.\-_]/i,b=
WORD_CHARS_PLUS_DIGITS+"\\/\\:#?&%=~;$@\\-_+!*'(){}",k=XRegExp("^(["+(b+".,")+"]*["+b+"])","i"),m=/[a-z0-9._%+-]/i,h=/^[a-z0-9]+[a-z0-9\-.]*\.[a-z]+/i,l={AC:true,AD:true,AE:true,AERO:true,AF:true,AG:true,AI:true,AL:true,AM:true,AN:true,AO:true,AQ:true,AR:true,ARPA:true,AS:true,ASIA:true,AT:true,AU:true,AW:true,AX:true,AZ:true,BA:true,BB:true,BD:true,BE:true,BF:true,BG:true,BH:true,BI:true,BIZ:true,BJ:true,BM:true,BN:true,BO:true,BR:true,BS:true,BT:true,BV:true,BW:true,BY:true,BZ:true,CA:true,CAT:true,
CC:true,CD:true,CF:true,CG:true,CH:true,CI:true,CK:true,CL:true,CM:true,CN:true,CO:true,COM:true,COOP:true,CR:true,CU:true,CV:true,CW:true,CX:true,CY:true,CZ:true,DE:true,DJ:true,DK:true,DM:true,DO:true,DZ:true,EC:true,EDU:true,EE:true,EG:true,ER:true,ES:true,ET:true,EU:true,FI:true,FJ:true,FK:true,FM:true,FO:true,FR:true,GA:true,GB:true,GD:true,GE:true,GF:true,GG:true,GH:true,GI:true,GL:true,GM:true,GN:true,GOV:true,GP:true,GQ:true,GR:true,GS:true,GT:true,GU:true,GW:true,GY:true,HK:true,HM:true,
HN:true,HR:true,HT:true,HU:true,ID:true,IE:true,IL:true,IM:true,IN:true,INFO:true,INT:true,IO:true,IQ:true,IR:true,IS:true,IT:true,JE:true,JM:true,JO:true,JOBS:true,JP:true,KE:true,KG:true,KH:true,KI:true,KM:true,KN:true,KP:true,KR:true,KW:true,KY:true,KZ:true,LA:true,LB:true,LC:true,LI:true,LK:true,LR:true,LS:true,LT:true,LU:true,LV:true,LY:true,MA:true,MC:true,MD:true,ME:true,MG:true,MH:true,MIL:true,MK:true,ML:true,MM:true,MN:true,MO:true,MOBI:true,MP:true,MQ:true,MR:true,MS:true,MT:true,MU:true,
MUSEUM:true,MV:true,MW:true,MX:true,MY:true,MZ:true,NA:true,NAME:true,NC:true,NE:true,NET:true,NF:true,NG:true,NI:true,NL:true,NO:true,NP:true,NR:true,NU:true,NZ:true,OM:true,ORG:true,PA:true,PE:true,PF:true,PG:true,PH:true,PK:true,PL:true,PM:true,PN:true,POST:true,PR:true,PRO:true,PS:true,PT:true,PW:true,PY:true,QA:true,RE:true,RO:true,RS:true,RU:true,RW:true,SA:true,SB:true,SC:true,SD:true,SE:true,SG:true,SH:true,SI:true,SJ:true,SK:true,SL:true,SM:true,SN:true,SO:true,SR:true,ST:true,SU:true,SV:true,
SX:true,SY:true,SZ:true,TC:true,TD:true,TEL:true,TF:true,TG:true,TH:true,TJ:true,TK:true,TL:true,TM:true,TN:true,TO:true,TP:true,TR:true,TRAVEL:true,TT:true,TV:true,TW:true,TZ:true,UA:true,UG:true,UK:true,US:true,UY:true,UZ:true,VA:true,VC:true,VE:true,VG:true,VI:true,VN:true,VU:true,WF:true,WS:true,XXX:true,YE:true,YT:true,ZA:true,ZM:true,ZW:true};return{forEachUrlInString:function(d,g){for(a.lastIndex=0;;){var j=a.exec(d);if(j==null)break;var o=j[0],n=j.index,q;if(o==="://"){for(q=n=n;q>0&&utils.isAlpha(d.charAt(q-
1));)q--;if(q===n)continue;var r=n+o.length;j=k.exec(d.substring(r));if(j===null)continue;o=j[0];n=true;q=q;o=r+o.length}else{if(!(j[1].toUpperCase()in l))continue;for(r=j=n;r>0&&f.test(d.charAt(r-1));)r--;n=d.substring(r,j);if(!c.test(n))continue;n=false;q=r;o=j+o.length;if(o===d.length||d.charAt(o)!=="/")o=o;else{j=k.exec(d.substring(o));o=o+j[0].length}}r=d.substring(q,o);g(q,r,n);a.lastIndex=o}},forEachEmailAddressInString:function(d,g){for(var j=0;;){j=d.indexOf("@",j);if(j===-1)break;var o=
j;j+=1;for(var n=o;n>0&&m.test(d.charAt(n-1));)n--;if(n!==o){o=h.exec(d.substring(j));if(o!==null){j+=o[0].length;o=d.substring(n,j);g(n,o)}}}},generateUrlSafeRandomString:function(d){for(var g="",j=0;j<d;j++)g+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(Math.floor(Math.random()*62));return g},isValidEmailAddress:function(d){var g=d.lastIndexOf("@");if(g===-1)return false;d=d.substring(g+1);g=d.lastIndexOf(".");if(g===-1||g===d.length-1)return false;return true},parseUrlFragment:function(d){var g=
{pathNames:[],parameters:{}};if(d.charAt(0)==="#")d=d.substring(1);var j=d.indexOf("?");if(j===-1)j=d.length;var o=d.substring(0,j);d=d.substring(j+1);j=o.split("/");for(o=0;o<j.length;o++){var n=j[o];n.length>0&&g.pathNames.push(n)}d=d.split("&");for(o=0;o<d.length;o++){j=d[o];if(j.length!==0){n=j.split("=");j=n[0];n=(n.length>1?n[1]:"").replace(/\+/g," ");n=decodeURIComponent(n);g.parameters[j]=n}}return g}}}(),sharing=function(){function a(){var g=$("#sharePopup"),j=l,o=j.getSharedInfo();j.isAddedSubtreePlaceholder();
d=false;g.html($("#sharePopupTemplate").html());payments.removeFreeOrProAsNeededFromDOMSubtree(g);var n=g.children(".sharePopupContentsContainer");if(j.isAddedSubtreePlaceholder()){o=n.children(".embedded_settings");n.addClass("embedded");var q=!j.childrenAreInReadOnlyTree();o.addClass(q?"embeddedEditable":"embeddedViewOnly");if(j.getShareTypeForTreeForChildren()==="url"){o.addClass("embeddedSharedByUrl");o=o.find("input.shareLink");o.val(j.getSharedUrl());o.focus().select()}g.dialog("option",{buttons:{Close:function(){$(this).dialog("close")}}})}else if(o===
null){o=n.children(".share_prompt");o.find("#id_share_type_url").attr("checked","checked");o.find("#urlShareTypeOption").addClass("chosenShareTypeOption");var r=o.find("#urlShareTypeOption .shareTypeAdditionalInfo"),t=o.find("#emailShareTypeOption .shareTypeAdditionalInfo");r.show();t.hide();o.find("#url_editable_false, #email_editable_false").attr("checked","checked");g.dialog("option",{buttons:{Share:c,Cancel:function(){$(this).dialog("close")}}})}else{if(o.isSharedViaUrl()){r=n.children(".url_shared_settings");
n.addClass("sharedViaUrl");q=o.getUrlSharingWritePermission();o=r.find(".is_editable.buttonset");q?o.find("#url_settings_editable_true").attr("checked","checked"):o.find("#url_settings_editable_false").attr("checked","checked");o=r.find("input.shareLink");o.val(j.getSharedUrl());o.focus().select()}else{r=n.children(".email_shared_settings");n.addClass("sharedViaEmail");t="";for(var v=o.getSortedEmailInfos(),x=0;x<v.length;x++){var e=v[x],p="user_id"in e,s="shared_email_"+x+"_editable",w="shared_email_"+
x+"_editable_false",u="shared_email_"+x+"_editable_true",A;if(q=e.write_permission){A="";q='checked="checked"'}else{A='checked="checked"';q=""}q='<span class="is_editable buttonset smallButtonset"><span class="buttons"><input type="radio" id="'+w+'" name="'+s+'" data-editable="false" '+A+' /><label for="'+w+'">view</label><input type="radio" id="'+u+'" name="'+s+'"  data-editable="true" '+q+' /><label for="'+u+'">edit</label></span></span>';e=html_utils.htmlEscapeText(e.email);t+='<tr><td class="sharedEmail" title="'+
e+'">'+e+'</td><td class="sharedEmailActive">'+(p?"active":"inactive")+'</td><td class="sharedEmailWritePermissionToggle">'+q+'</td><td class="sharedEmailRemoveLinkContainer"><span class="sharedEmailRemoveLink">Remove</span></td></tr>'}v.length===0&&r.addClass("noSharedEmails");r.find("#sharedEmailsTable").children("tbody").html(t);r=r.find(".addPeopleWidget .is_editable.buttonset");o=o.getEmailInfos();(o.length>0?o[o.length-1].write_permission:false)?r.find("#shared_email_editable_true").attr("checked",
"checked"):r.find("#shared_email_editable_false").attr("checked","checked")}g.dialog("option",{buttons:{"Stop sharing this list":function(){n.addSpinner();d=true;g.setDialogButtonsDisable(true);undoredo.startOperationBatch();j.applyLocalUnshare();undoredo.finishOperationBatch();pushpoll.scheduleNextPushAndPoll(true)},Close:function(){$(this).dialog("close")}}})}n.find(".buttonset").buttonset()}function c(){var g=$("#sharePopup"),j=g.children(".sharePopupContentsContainer"),o=j.children(".share_prompt"),
n=l;j.addSpinner();d=true;g.setDialogButtonsDisable(true);if(o.find("#id_share_type_url, #id_share_type_email").filter(":checked").is("#id_share_type_url")){g=o.find("#url_editable_false, #url_editable_true").filter(":checked").is("#url_editable_true");b(n,"url",g)}else{g=o.find("#email_editable_false, #email_editable_true").filter(":checked").is("#email_editable_true");o=f(o.find(".emailListInput").val());o.length>0?b(n,"email",g,o):b(n,"email")}}function f(g){g=g.split(",");for(var j=[],o=0;o<g.length;o++){var n=
$.trim(g[o]);urls.isValidEmailAddress(n)&&j.push(n)}return j}function b(g,j,o,n){if(o===undefined)o=null;if(n===undefined)n=null;if(!(j==="email"&&!payments.isPro())){undoredo.startOperationBatch();g.applyLocalShare(j,o);if(n!==null)for(j=0;j<n.length;j++)g.applyLocalAddSharedEmail(n[j],o);undoredo.finishOperationBatch();pushpoll.scheduleNextPushAndPoll(true)}}function k(g,j,o){undoredo.startOperationBatch();for(var n=0;n<j.length;n++)g.applyLocalAddSharedEmail(j[n],o);undoredo.finishOperationBatch();
pushpoll.scheduleNextPushAndPoll(true)}function m(g,j){for(var o=0;o<g.length;o++){var n=g[o];if(n.email===j)return n}return null}function h(g,j){for(var o=0;o<g.length;o++){var n=g[o];if(n.access_token===j)return n}return null}var l=null,d=false;jQuery.fn.showSharePopup=function(){var g=$(this);g=projecttree.getProjectReferenceFromDomProject(g);if(!g.isAddedSubtreePlaceholder()&&g.hasAddedSubtreeDescendant())ui_sugar.showAlertDialog("It's not possible (yet) to share an item containing lists added from other accounts. If you want to share this item, move any such lists elsewhere first.",
"Error");else{var j=$("#sharePopup");j.dialog("option",{title:"Share list: "+content_text.getHtml(g.getName())});l=g;d=false;j.dialog("open");a()}};return{init:function(){$("#sharePopup").dialog({autoOpen:false,width:500,modal:true,position:["center",150],title:"Share list",close:function(){l=null;d=false}});$("#sharePopup .share_prompt #shareTypeSelector .shareTypeOption > :radio").live("click",function(){var g=$(this).closest(".shareTypeOption"),j=g.find(".shareTypeAdditionalInfo"),o=g.closest("#shareTypeSelector");
g.addClass("chosenShareTypeOption");g=o.find(".shareTypeOption").not(g);g.removeClass("chosenShareTypeOption");j.slideDown(200);g.find(".shareTypeAdditionalInfo").slideUp(200)});$("#sharePopup .url_shared_settings .is_editable.buttonset :radio").live("click",function(){var g=$(this).data("editable")===true;b(l,"url",g)});$("#sharePopup .email_shared_settings #sharedEmailsTable .is_editable.buttonset :radio").live("click",function(){var g=$(this).data("editable")===true,j=$(this).closest("tr").children("td.sharedEmail").text();
k(l,[j],g)});$("#sharePopup .email_shared_settings #sharedEmailsTable .sharedEmailRemoveLink").live("click",function(){var g=$(this).closest("tr").children("td.sharedEmail").text(),j=l;undoredo.startOperationBatch();j.applyLocalRemoveSharedEmail(g);undoredo.finishOperationBatch();pushpoll.scheduleNextPushAndPoll(true)});$("#sharePopup input.shareLink").live("click",function(){$(this).focus().select()});$("#sharePopup .share_prompt form").live("submit",function(){c();return false});$("#sharePopup .email_shared_settings form.emailEntryForm").live("submit",
function(){var g=$(this),j=g.find("#shared_email_editable_false, #shared_email_editable_true").filter(":checked").is("#shared_email_editable_true");g=f(g.find(".emailListInput").val());g.length>0&&k(l,g,j);return false});$("#sharePopup .email_shared_settings form.emailEntryForm .emailEntryFormSubmitButton").live("click",function(){$(this).closest("form.emailEntryForm").submit()})},ItemSharedInfo:Class.extend({init:function(g){if(g===undefined)g={};this.rawItemSharedInfo=g},isSharedViaUrl:function(){return"url_shared_info"in
this.rawItemSharedInfo},isSharedViaEmail:function(){return"email_shared_info"in this.rawItemSharedInfo},makeCopyOfRawSharedInfo:function(){return utils.deepCopyObject(this.rawItemSharedInfo)},getUrlSharingWritePermission:function(){return this.rawItemSharedInfo.url_shared_info.write_permission},getInfoForEmail:function(g){return m(this.rawItemSharedInfo.email_shared_info.emails,g)},getEmailInfos:function(){return this.rawItemSharedInfo.email_shared_info.emails},getSortedEmailInfos:function(){for(var g=
this.getEmailInfos(),j=[],o=0;o<g.length;o++)j.push(g[o]);j.sort(function(n,q){return n.email<q.email?-1:1});return j},shareViaUrl:function(g){"email_shared_info"in this.rawItemSharedInfo&&delete this.rawItemSharedInfo.email_shared_info;this.rawItemSharedInfo.url_shared_info={write_permission:g}},shareViaEmail:function(){"url_shared_info"in this.rawItemSharedInfo&&delete this.rawItemSharedInfo.url_shared_info;"email_shared_info"in this.rawItemSharedInfo||(this.rawItemSharedInfo.email_shared_info=
{emails:[]})},addSharedEmail:function(g,j,o){if(this.isSharedViaEmail()){var n=this.rawItemSharedInfo.email_shared_info.emails,q=m(n,g);if(q!==null)q.write_permission=j;else n.push({email:g,access_token:o,write_permission:j})}},removeSharedEmail:function(g){if(this.isSharedViaEmail()){for(var j=this.rawItemSharedInfo.email_shared_info.emails,o=null,n=0;n<j.length;n++)if(j[n].email===g){o=n;break}o!==null&&j.splice(o,1)}},registerSharedEmailUser:function(g,j){if(this.isSharedViaEmail()){var o=h(this.rawItemSharedInfo.email_shared_info.emails,
g);if(!(o===null||j!==null&&"user_id"in o))if(j!==null)o.user_id=j;else delete o.user_id}},getSharedEmailUserId:function(g){if(!this.isSharedViaEmail())return null;g=h(this.rawItemSharedInfo.email_shared_info.emails,g);if(g===null||!("user_id"in g))return null;return g.user_id},getOperationsToCreate:function(g,j,o){if(this.isSharedViaUrl()){var n={projectid:g,share_type:"url",write_permission:this.rawItemSharedInfo.url_shared_info.write_permission},q={previous_share_type:null,previous_last_modified:j};
return[operations.createOperationWithUndoData("share",n,q,o)]}else{var r=[];n={projectid:g,share_type:"email"};q={previous_share_type:null,previous_last_modified:j};r.push(operations.createOperationWithUndoData("share",n,q,o));n=this.rawItemSharedInfo.email_shared_info.emails;for(q=0;q<n.length;q++){var t=n[q];r.push(operations.createOperationWithUndoData("add_shared_email",{projectid:g,shared_email:t.email,write_permission:t.write_permission,access_token:t.access_token,send_email_if_new:false},{previous_last_modified:j},
o));"user_id"in t&&r.push(operations.createOperationWithUndoData("register_shared_email_user",{projectid:g,access_token:t.access_token,user_id:t.user_id},{previous_last_modified:j},o))}return r}}}),updateShareDialogIfOpenToProject:function(g){l===null||!l.equals(g)||d||a()},notifyShareOrUnshareCompleteIfNeeded:function(g,j){var o=g.containsOperationType("share"),n=g.containsOperationType("unshare");if(o||n)if(l!==null)if(j||!l.isValid())$("#sharePopup").dialog("close");else{a();n&&$("#sharePopup").dialog("close")}}}}(),
exporting=function(){jQuery.fn.exportIt=function(a){if(a===undefined)a=false;var c=$(this),f=projecttree.getProjectReferenceFromDomProject(c);c=$("#exportPopup");c.html($("#exportPopupTemplate").html());var b=f.generateExportData(a);a=b.htmlContainer;f=b.textContainer;b=b.opmlContainer;c.find(":radio#id_html").attr("checked",true);var k=c.children(".previewWindow");k.addClass("hasHtml");k.append(a);c.children(".textContainer").append(f);c.children(".opmlContainer").append(b);c.dialog("open");k.focus();
dom_utils.selectElementText(k.get()[0])};return{init:function(){$("#exportPopup").dialog({autoOpen:false,width:550,buttons:{Close:function(){$(this).dialog("close")}},modal:false,position:["center",150],title:"Export List",close:function(){$("#exportPopup").html("")}});$("#exportPopup form input.htmlButton, #exportPopup form input.textButton, #exportPopup form input.opmlButton").live("change",function(){var a=$(this),c=$("#exportPopup"),f=c.children(".previewWindow"),b=c.children(".htmlContainer"),
k=c.children(".textContainer");c=c.children(".opmlContainer");var m;if(f.hasClass("hasHtml")){m=b;f.removeClass("hasHtml")}else if(f.hasClass("hasText")){m=k;f.removeClass("hasText")}else if(f.hasClass("hasOpml")){m=c;f.removeClass("hasOpml")}m.append(f.children());var h;if(a.hasClass("htmlButton")){h=b;f.addClass("hasHtml")}else if(a.hasClass("textButton")){h=k;f.addClass("hasText")}else if(a.hasClass("opmlButton")){h=c;f.addClass("hasOpml")}f.append(h.children());f.focus();dom_utils.selectElementText(f.get()[0])})}}}(),
paste=function(){function a(n){n=n.split("\n");for(var q=[],r=0;r<n.length;r++){var t=n[r];$.trim(t).length>0&&q.push(new o(content_text.xmlEscapeTextForContentText(t)))}return q}function c(n){n=n.getLines();for(var q=[],r=0;r<n.length;r++){var t=n[r];$.trim(t.getPlainText()).length>0&&q.push(new o(t.getText()))}return q}function f(n){var q=n;if(!m()){n=n.html().replace(/<br>/ig,"\n").replace(/&nbsp;/ig," ");q=$("<div />").html(n)}return q}function b(n,q){function r(w){return w.replace(/\n/g,"").replace(/\t/g,
p)}var t=n.isNote(),v=n.getCaret();t&&n.addClass("copyOrPasteInProgress");var x=n.getContentCaretOffset(),e=$("#copyAndPasteBucket");e.show();e.offset({left:-9999,top:x.top});e.focus();var p="    ",s=content_text.getPlainTextForContent(n);x=r(s.substring(0,v.start));s=r(s.substring(v.start,v.end));x={start:x.length,end:x.length+s.length};s=new content_text.ContentText(n,t);s=IS_FIREFOX?s.getContentHtml():s.getContentHtmlWithSingleCharFormattingSpans();s=s.charAt(s.length-1)==="\n"?s.substring(0,s.length-
1):s;s=s.replace(/\n/g,"<br>").replace(/\t/g,p).replace(/  /g,"&nbsp; ");e.html(s);e.setCaret(x.start,x.end);setTimeout(function(){e.html("");e.removeAttr("style");q(v);t&&n.removeClass("copyOrPasteInProgress")},0)}function k(n){var q=n.isNote(),r=n.getCaret(),t=new content_text.ContentText(n,q);if(t.containsFormatting()){n.setContentHtml(t.getContentHtmlWithSingleCharFormattingSpans());n.setCaret(r.start,r.end);setTimeout(function(){var v=n.getCaret(),x=new content_text.ContentText(n,q);n.setContentHtml(x.getContentHtml());
n.setCaret(v.start,v.end)},0)}}function m(){return!IS_FIREFOX&&!IS_IOS&&!IS_IE}function h(n){n=n.replace(RegExp(String.fromCharCode(160),"g")," ");if(window.DOMParser===undefined)return null;var q=new DOMParser;try{var r=q.parseFromString(n,"text/xml")}catch(t){return null}n=$(r).children("opml");if(n.length!==1)return null;n=n.children("body");if(n.length!==1)return null;return l(n)}function l(n){var q=[];n.children("outline").each(function(){var r=$(this),t=r.attr("text")||null,v=r.attr("_note")||
null,x=r.attr("_complete")==="true"?true:null;t=t!==null?(new content_text.ContentText(t,false)).getText():"";if(v!==null)v=(new content_text.ContentText(v,true)).getText();q.push(new o(t,v,x,true));r=l(r);r.length>0&&q.push(r)});return q}function d(n){for(var q=[],r=function(p,s,w){if(p===undefined)p=null;if(s===undefined)s=null;if(w===undefined)w=null;var u={};p!==null&&projecttreeobject.setName(u,p);s!==null&&projecttreeobject.setNote(u,s);w!==null&&projecttreeobject.setCompleted(u,w);q.push(u)},
t=0;t<n.length;t++){var v=n[t];if(v instanceof o){var x=v.fromOpml?v.name:$.trim(v.name);r(x,v.note,v.isComplete)}else{v=v;q.length===0&&r();v=d(v);x=q[q.length-1];var e=projecttreeobject.getChildren(x)||[];projecttreeobject.setChildren(x,e.concat(v));x.expanded=true}}return q}var g=/^\s*(<\?\s*xml[^?]*\?>)?\s*<\s*opml[\s\S]*<\/\s*opml\s*>\s*$/i,j=0,o=Class.extend({init:function(n,q,r,t){if(q===undefined)q=null;if(r===undefined)r=null;if(t===undefined)t=false;this.name=n;this.note=q;this.isComplete=
r;this.fromOpml=t}});jQuery.fn.getInnerLines=function(n){if(n===undefined)n=true;for(var q=$(this),r=[];;){var t=q.find("ul, ol, li").first();if(t.length===1){var v=document.createRange();v.setStart(q.get(0),0);v.setEndBefore(t.get(0));if(!v.collapsed){var x;x=v.cloneContents();var e=new content_text.ContentText($(x),false);if(e.containsFormatting()){if(!m()){e=document.createElement("div");e.appendChild(x);x=f($(e));e=new content_text.ContentText(x,false)}x=c(e);v.collapsed||v.deleteContents()}else{x=
window.getSelection();x.removeAllRanges();x.addRange(v);v=x.toString();x.isCollapsed||x.deleteFromDocument();x.removeAllRanges();m()||(v=v.replace(/&nbsp;/ig," "));x=a(v)}r=r.concat(x)}v=t.is("li");x=t.getInnerLines(false);if(n||v)r=r.concat(x);else if(r.length>0&&!(r[r.length-1]instanceof o))r[r.length-1]=r[r.length-1].concat(x);else r.push(x);t.remove()}else{if(q.find(content_text.getContentClassesSelector()).length>0){n=f(q);n=c(new content_text.ContentText(n,false))}else{n=dom_utils.getFormattedElementText(q[0]);
m()||(n=n.replace(/\u00A0/g," "));n=a(n)}r=r.concat(n);break}}return r};jQuery.fn.handleCutInContent=function(){var n=$(this);if(m)IS_FIREFOX?setTimeout(function(){n.updateContentHtmlAfterUserEdit()},0):k(n);else{var q=n.isNote();b(n,function(r){var t=new content_text.ContentText(n,q);t=t.substring(0,r.start).concatenate(t.substring(r.end));n.setContentTextAsUserEdit(t.getText(),q);n.setCaret(r.start,r.start,"doNotScrollIfOnScreen")})}};jQuery.fn.handleCopyInContent=function(){var n=$(this);if(m())IS_FIREFOX||
k(n);else b(n,function(q){n.setCaret(q.start,q.end,"doNotScrollIfOnScreen")})};jQuery.fn.handlePasteIntoContent=function(n,q){if(q===undefined)q=false;var r=$(this),t=r.isNote(),v=r.getProject();if(projecttree.getProjectReferenceFromDomProject(v).isReadOnly())return false;if(document.activeElement===r[0]){j++;var x=j;if(IS_IE&&q)setTimeout(function(){r.handleDirectPasteIntoContent()},1);else{t&&r.addClass("copyOrPasteInProgress");var e=r.getCaret(),p=undoredo.saveClientViewStateForUndoRedo();v=r.getContentCaretOffset();
var s=$("#copyAndPasteBucket");s.html("");s.show();s.offset({left:-9999,top:v.top});s.focus();var w=null,u=function(){document.activeElement===s[0]&&s.blur();s.html("");s.removeAttr("style");t&&r.removeClass("copyOrPasteInProgress")},A=function(){w!==null&&clearTimeout(w);x===j&&setTimeout(function(){if(t){if(s.find(content_text.getContentClassesSelector()).length>0){var B=f(s);B=new content_text.ContentText(B,true)}else B=content_text.createContentTextContainerFromPlainText(dom_utils.getFormattedElementText(s[0]),
true);u();r.handlePasteIntoNote(B,e,p)}else{B=s.text();var E=null;if(B.match(g)!==null)E=h(B);if(E===null)E=s.getInnerLines();u();r.handlePasteIntoName(E,e,p)}},1)};if(q)A();else{$("body").one("paste",function(){A()});w=setTimeout(function(){u()},1E3)}}}};jQuery.fn.handlePasteIntoName=function(n,q,r){var t=$(this),v=new content_text.ContentText(t,false),x=v.substring(0,q.start),e=v.substring(q.end);v=function(B){undoredo.startOperationBatch(true,r);B=new content_text.ContentText(B.name,false);var E=
x.concatenate(B).concatenate(e);t.setAndSaveContentText(E.getText());B=q.start+B.getPlainText().length;t.setCaret(B,B,"doNotScrollIfOnScreen");undoredo.finishOperationBatch()};if(n.length===0)v(new o(""));else{var p=n[0]instanceof o&&n[0].note===null&&n[0].isComplete!==true;if(n.length===1&&p)v(n[0]);else{undoredo.startOperationBatch(true,r);v=t.getProject();p=projecttree.getProjectReferenceFromDomProject(v);var s=(new content_text.ContentText(v.getNotes().children(".content"),true)).isEmpty()&&v.is(".task"),
w=v.is(".selected");if(!w&&s){s=n[0];var u=x;if(s instanceof o){u=u.concatenate(new content_text.ContentText(s.name.replace(/\s*$/,""),false));s.note!==null&&p.applyLocalEdit(null,s.note);s.isComplete===true&&p.applyLocalComplete();n.shift()}t.setAndSaveContentText(u.getText());s=e.getText();$.trim(s).length>0&&n.push(new o(s))}if(w){w=n;s=[]}else{for(s=0;s<n.length&&!(n[s]instanceof o);)s++;u=n.slice(0,s);w=[];for(var A=0;A<u.length;A++)w=w.concat(u[A]);s=n.slice(s)}n=d(w);w=d(s);u=v.getParent();
s=v.getPriority();u=projecttree.getProjectReferenceFromDomProject(u);A=null;if(n.length>0){v.is("open")||v.showChildren("instant").setExpanded(true);v=p.applyLocalBulkCreateChildren(0,n);A=v[v.length-1]}if(w.length>0){v=u.applyLocalBulkCreateChildren(s+1,w);A=v[v.length-1]}A!==null&&A.getMatchingDomProject().getName().moveCursorToEnd();undoredo.finishOperationBatch()}}};jQuery.fn.handlePasteIntoNote=function(n,q,r){var t=$(this),v=new content_text.ContentText(t,true);v=v.substring(0,q.start).concatenate(n).concatenate(v.substring(q.end));
undoredo.startOperationBatch(true,r);t.setAndSaveContentText(v.getText());n=q.start+n.getPlainText().length;t.setCaret(n,n,"doNotScrollIfOnScreen");undoredo.finishOperationBatch()};jQuery.fn.handleDirectPasteIntoContent=function(){var n=$(this),q=n.getProject(),r=dom_utils.getFormattedElementText(n[0]);if(n.isNote()){q=content_text.createContentTextContainerFromPlainText(r,true);undoredo.startOperationBatch(true);n.setAndSaveContentText(q.getText());undoredo.finishOperationBatch()}else{r=a(r);if(!(r.length<=
1)){undoredo.startOperationBatch(true);var t=new content_text.ContentText(r[0].name.replace(/\s*$/,""),false);n.setAndSaveContentText(t.getText());r.shift();n=d(r);if(q.is(".selected")){r=q;q=0}else{r=q.getParent();q=q.getPriority()+1}q=projecttree.getProjectReferenceFromDomProject(r).applyLocalBulkCreateChildren(q,n);q[q.length-1].getMatchingDomProject().getName().moveCursorToEnd();undoredo.finishOperationBatch()}}};return{}}(),appearance=function(){function a(m,h){var l;$(h==="font"?FONT_OPTIONS:
THEME_OPTIONS).each(function(d,g){if(g.name===m){l=g;return false}});return l}function c(m){var h=m.type==="font"?$("#fontChooser"):$("#themeChooser");h.find(".galleryShowButton").html(m.pretty_name+" &raquo;");$(".option-thumb.current",h).removeClass("current");m=$(".option-name-"+m.name,h);m.addClass("current");$(".currentMark",h).remove();m.find(".option-pretty-name").prepend('<span class="currentMark">Current: </span>')}function f(){APPCACHE_ENABLED&&appcachehelper.update()}function b(m,h,l){if(l===
undefined)l=false;l=k(m.type,m.name);var d=m.type==="font"?"font_css":"theme_css";l={url:l,cache:true,dataType:"text",success:function(g){if(g!=null){g=$('<style id="'+d+'" >'+g+"</style>");$("head > #"+d).replaceWith(g);h(m.type)}}};if(IS_CHROME_APP)l.WF_doNotRewriteUrl=true;$.ajax(l)}function k(m,h){if(m==="font")var l="",d="fonts";else{l=IS_MOBILE?"mobile.":"desktop.";d="themes"}return ON_DEVELOPMENT_SERVER?"/get_css/"+h+"?type="+m:"/media/versioned/"+SOURCE_VERSION+"/"+d+"/"+l+h+".css"}return{buildVisualSelector:function(m,
h,l,d,g,j){l=$(l);l.empty();$(m).filter(function(){return this.name===h}).length>0||(h="default");d=$(m).filter(function(q,r){return r.is_free}).get();m=$(m).filter(function(q,r){return!r.is_free}).get();m=d.concat(m);for(d=0;d<m.length;d++){var o=m[d],n=$('<div class="option-thumb option-name-'+o.name+'" data-name="'+o.name+'" data-type="'+o.type+'"  />');if(o.type==="theme")n.append('<img src="/media/i/'+j+"/"+o.name+'_thumb.jpg"><div class="option-pretty-name">'+o.pretty_name+"</div>");else{n.append(o.pretty_name);
d==0&&n.append('<div style="font-size:11px;font-style:italic;color:#999;">default</div>');n.attr("style",o.font_styles)}o.is_free&&n.addClass("free");l.append(n);o.name===h&&c(o)}payments.isPro()||l.find(".option-thumb.free:last").after('<div class="moreInfo">'+g+"</div>")},getStyleObjectFromThumb:function(m){var h=m.data("type");m=m.data("name");return a(m,h)},setStyle:function(m){function h(o,n){var q=o.type==="font"?$("#fontChooser > .gallery"):$("#themeChooser > .gallery");$(".waiting",q).remove();
$(".option-name-"+o.name,q).append('<div class="waiting"></div>');b(o,function(r){n(r);c(o);$(".waiting",q).remove()})}var l=m.type==="font"?$("#fontChooser > .gallery"):$("#themeChooser > .gallery"),d=$(".option-name-"+m.name,l);$(".option-thumb .galleryProNotice",l).remove();if(!payments.isPro()&&!m.is_free){$(".galleryProNotice",l).clone().appendTo(d);return false}if(m.type==="font")h(m,function(){settings.changeSettings({font:m.name},false,f)});else{var g=a(m.font,"font"),j={theme:false,font:false};
l=function(o){j[o]=true;j.theme&&j.font&&settings.changeSettings({theme:m.name,font:g.name},false,f)};h(m,l);h(g,l)}},changeCSS:b}}(),friend_recommendation=function(){function a(){$("#promptContext").html("You've been using WorkFlowy for more than a week! We'd really appreciate it if you took a moment to let us know how useful WorkFlowy is to you.");$("#ratingDialog").dialog({modal:true,width:500,title:"What do you think of WorkFlowy?",open:function(){_gaq.push(["_trackPageview","/virtual/friend_recommendation_prompt/10_days/rating_prompted/"])},
close:function(){_gaq.push(["_trackPageview","/virtual/friend_recommendation_prompt/10_days/rating_dialog_closed/"])}})}function c(f){var b=$("#ratingDialog");_gaq.push(["_trackPageview","/virtual/friend_recommendation_prompt/10_days/rating_given/"+f]);if(f==="high"){f="<p>We're glad you like WorkFlowy. Please share it with your friends!</p>";payments.isPro()||(f+=$("#post-rating-dialog-text").html());var k=REFERRAL_LINK+"&utm_campaign=friend_recommendation_prompt_10_days&utm_medium=facebook&utm_source=wf";
b.html(f).dialog("option",{title:"Yay! Three stars!",buttons:{"Share WorkFlowy on Facebook":function(){FB.ui({method:"feed",link:k,picture:"https://www.workflowy.com/media/i/workflowy_icon_rounded_corners_512x512.png",name:"WorkFlowy - Simplify your life.",caption:"workflowy.com",description:"WorkFlowy offers a simple, but powerful way to manage all the information in your life. It'll help you stress less and do more.",actions:[{name:"Try WorkFlowy",link:k}]},function(m){m&&m.post_id&&_gaq.push(["_trackPageview",
"/virtual/friend_recommendation_prompt/10_days/facebook_post_completed"]);b.dialog("close")});_gaq.push(["_trackPageview","/virtual/friend_recommendation_prompt/10_days/facebook_share_button_clicked"])},Close:function(){$(this).dialog("close")}}});quota.updateProgressBars(projecttree.getMainProjectTree())}else{f='<p style="margin:20px 10px 10px;">Thanks, we hope you enjoy WorkFlowy.</p>';b.html(f).dialog("option",{title:"Thanks for your feedback!",buttons:{Close:function(){b.dialog("close")}}})}}
return{init:function(){$("#ratingDialog .star").live("click",function(){var f=$(this).parent(".rating").data("rating");c(f)});a()}}}(),keyboard_shortcut_helper=function(){function a(){settings.changeSettings({show_keyboard_shortcuts:true},true)}function c(){settings.changeSettings({show_keyboard_shortcuts:false},true)}return{init:function(){$("#keyboardShortcutHelper > .title").live("click",function(){$("#keyboardShortcutHelper").toggleClass("closed")});$("input[type=checkbox].keyboardShortcutHelper").live("change",
function(){var f=$(this);f.is(":checked")?a(f):c(f)})},toggle:function(){$("#keyboardShortcutHelper").hasClass("visible")?c():a()},registerSettingChange:function(){if(!IS_MOBILE){var f=SETTINGS.show_keyboard_shortcuts.value,b=$("#keyboardShortcutHelper"),k=$("input[type=checkbox].keyboardShortcutHelper");if(f){b.removeClass("closed").addClass("visible");k.attr("checked","checked")}else{b.removeClass("visible");k.removeAttr("checked")}}}}}(),forms=function(){var a=function(c,f){c.find(".errors").remove();
$.each(f,function(b,k){var m="";$.each(k,function(l,d){m+=d+" "});var h="input[name="+b+"]";c.has(h).length!==0?c.find(h).after('<div class="errors">'+m+"</div>"):c.prepend('<div class="errors">'+m+"</div>")})};return{ajaxify:function(c,f){c.live("submit",function(){if(c.data("submitting")===true)return false;c.data("submitting",true);var b={};$("input[type=text], input[type=password]",c).each(function(k,m){m=$(m);b[m.attr("name")]=m.val()});$.ajax({url:c.attr("action"),data:b,dataType:"json",type:"POST",
success:function(k){c.data("submitting",false);if("errors"in k)a(c,k.errors);else f!==undefined&&f.call(c,k)},error:function(){c.data("submitting",false);c.children(".errors").remove();c.prepend('<div class="errors">You must be online to do this. Please check your connection and try again.</div>')}});return false})}}}(),settings=function(){function a(){$.ajax({url:"/get_settings",dataType:"json",success:function(g){if(g!=null){userstorage.isEnabled()&&userstorage.updateSettingsFromServer(g);messages.init()}}})}
function c(){for(var g in SETTINGS)b(g)}function f(g,j){j?g.attr("checked","checked"):g.removeAttr("checked")}function b(g){switch(g){case "show_keyboard_shortcuts":keyboard_shortcut_helper.registerSettingChange();break;case "unsubscribe_from_summary_emails":f($("#summaryEmailsCheckboxSettings"),!SETTINGS.unsubscribe_from_summary_emails.value);break;case "backup_to_dropbox":f($("#backupToDropbox"),SETTINGS.backup_to_dropbox.value);break;case "email":g=SETTINGS.email.value;$(".userEmail").text(g);
break;case "username":g=SETTINGS.username.value;$(".loginForm input[name=username]").attr("value",html_utils.htmlEscapeText(g));break;case "saved_views_json":savedviews.registerSettingChange()}}function k(g,j,o){if(j===undefined)j=false;if(o===undefined)o=null;var n={},q={};for(settingName in g){var r=g[settingName],t=SETTINGS[settingName],v=t.value;t.value=r;n[settingName]=r;if(t.saveToServer)if(settingName==="saved_views_json")q.saved_views_json_delta=savedviews.generateViewListJsonDiff(v,r);else q[settingName]=
t.isFlag?r?"yes":"no":r;j&&b(settingName)}utils.objectIsEmpty(n)||userstorage.isEnabled()&&userstorage.saveSettings(n);utils.objectIsEmpty(q)||m(q,o)}function m(g,j){if(j===undefined)j=null;var o={url:"/change_settings",data:g,dataType:"json",type:"POST"};if(j!==null)o.success=j;$.ajax(o)}function h(g){g.fadeOut(100).hide();g=IS_MOBILE?"touchend":"click";$("body").die(g+".hideGallery")}function l(g){var j=g.form,o=g.button;j.hide=function(){o.removeClass("cancel");j.slideUp(function(){j.find(".errors").text("");
j.find("input[type=text], input[type=password]").val("")})};j.show=function(){o.addClass("cancel");j.slideDown()};o.clickOrTapHandler({event:function(){j.is(":visible")?j.hide():j.show()}});forms.ajaxify(j,g.successCallback)}function d(){var g=IS_MOBILE?"touchend":"click";$("#buttonBar").removeClass("open");$("body").unbind(g,d);return true}return{init:function(){c();setTimeout(a,1);$("#settingsPopup .setting").last().addClass("last");var g=IS_MOBILE?"touchend":"click";$(".menu-button").bind(g,function(){var j=
$("#buttonBar");if(j.hasClass("open"))d();else{j.addClass("open");$("body").bind(g,d)}IS_MOBILE&&$(this).removeClass("tapped");return false});IS_MOBILE&&$(".menu-button").bind("touchstart",function(){$(this).tapIt()});$("#settingsPopup").dialog({autoOpen:false,width:670,buttons:{Close:function(){$(this).dialog("close")}},modal:false,position:["center",150],title:"Settings",open:function(){appearance.buildVisualSelector(THEME_OPTIONS,SETTINGS.theme.value,"#theme-scroller","Free Theme","Pro Themes",
"themes");appearance.buildVisualSelector(FONT_OPTIONS,SETTINGS.font.value,"#font-scroller","Free Fronts","Pro Fonts","fonts")},close:function(){$(this).find(".gallery").each(function(){h($(this))})}});$(".option-thumb:not(.current)").clickOrTapHandler({event:function(){var j=$(this);j=appearance.getStyleObjectFromThumb(j);appearance.setStyle(j);return false}});$(".gallery > .closeMeButton").clickOrTapHandler({event:function(){var j=$(this).closest(".gallery");h(j)}});$(".gallerySelector > .galleryShowButton").clickOrTapHandler({event:function(){var j=
$(this).nextAll(".gallery");$(".gallery").not(j).fadeOut(100);j.fadeToggle(100);var o=IS_MOBILE?"touchend":"click";$("body").live(o+".hideGallery",function(n){if($(n.target).closest(".gallery").length===0){h(j);return false}});return false}});$("input.team_invite_link").live("click",function(){$(this).focus().select()});$("#summaryEmailsCheckboxSettings").bind("change",function(){var j=!$(this).is(":checked");k({unsubscribe_from_summary_emails:j})});appdetect.isIOSApp()&&$("#backupToDropbox").parent().hide();
$("#backupToDropbox").live("change",function(){var j=$(this).is(":checked");k({backup_to_dropbox:j});j&&window.open("/authorize_dropbox","_blank","width=900,height=700")});l({successCallback:function(j){j=j.email;k({email:j,username:j},true);this.hide()},button:$("#changeEmailLink"),form:$("#changeEmailForm")});l({successCallback:function(){showMessage("Password successfully changed.");this.hide()},button:$("#changePasswordLink"),form:$("#changePasswordForm")});$("#deleteAccountDialog").dialog({width:400,
modal:true,autoOpen:false,open:function(){var j=$("#deleteAccountFormTemplate").html();$(this).append(j)},close:function(){$(this).children("#deleteAccountConfirmation").remove()},title:"Confirm Account Deletion",buttons:[{text:"Permanently Delete Account",click:function(){$("#deleteAccountConfirmation").submit()}},{text:"Cancel",click:function(){$(this).closest(".ui-dialog-content").dialog("close")}}]});$("#deleteAccountLink").live("click",function(){$("#deleteAccountDialog").dialog("open")})},hideMenu:d,
registerSettingChange:b,changeSettings:k,saveShowCompleted:function(g){m({show_completed:g?"yes":"no"})}}}(),datetime=function(){var a=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];return{getCurrentTimeInMS:function(){return(new Date).getTime()},dateToDateTimeString:function(c){var f=c.getHours(),b=c.getMinutes(),k;if(f<12){k="AM";if(f==0)f=12}else{k="PM";if(f>12)f-=12}b=b<=9?"0"+b:String(b);return a[c.getMonth()]+" "+c.getDate()+", "+c.getFullYear()+" @ "+f+":"+b+" "+
k},convertMillisecondsToTimeDeltaString:function(c){c=Math.max(0,c);c=Math.floor(c/6E4);if(c<60)return c+" minute"+(c===1?"":"s");c=Math.floor(c/60);if(c<24)return c+" hour"+(c===1?"":"s");c=Math.floor(c/24);return c+" day"+(c===1?"":"s")},getCurrentTimeAsDebugTimestamp:function(){var c=new Date,f=utils.zeroPadInteger(c.getDate(),2)+"/"+a[c.getMonth()]+"/"+c.getFullYear();c=utils.zeroPadInteger(c.getHours(),2)+":"+utils.zeroPadInteger(c.getMinutes(),2)+":"+utils.zeroPadInteger(c.getSeconds(),2)+"."+
utils.zeroPadInteger(c.getMilliseconds(),3);return f+" "+c}}}(),utils=function(){function a(h){if(LOG_DEBUG_MESSAGES){if(typeof h==="function")h=h();c("["+datetime.getCurrentTimeAsDebugTimestamp()+"] "+h)}}function c(h){window.console!==undefined&&typeof window.console.log==="function"&&console.log(h)}function f(h){return!isNaN(h)}function b(){return((1+Math.random())*65536|0).toString(16).substring(1)}function k(h,l){try{var d=JSON.parse(h)}catch(g){l();return null}return d}var m=/[a-z]/i;return{Stack:Class.extend({init:function(h,
l){if(h===undefined)h=-1;if(l===undefined)l=1;this._stack=[];this._maxLength=h;this._lengthResizeBuffer=l},push:function(h){this._stack.push(h);this._maxLength>0&&this._stack.length>this._maxLength&&this._stack.splice(0,this._lengthResizeBuffer)},pop:function(){return this._stack.pop()},last:function(){if(!this.isEmpty())return this._stack[this._stack.length-1]},clear:function(){this._stack=[]},length:function(){return this._stack.length},isEmpty:function(){return this.length()===0}}),debugMessage:a,
debugAlert:function(h){if(LOG_DEBUG_MESSAGES){a(h);ui_sugar.showAlertDialog(html_utils.htmlEscapeText(h),"Debug Alert",false)}},consoleLog:c,printStackTrace:function(){for(var h=arguments.callee.caller;h!=null&&typeof h==="function";){c("name"in h&&h.name!==""?h.name:"(anonymous)");h=h.caller}},timeFunction:function(h){var l=h.name?h.name:"[unnamed]",d=datetime.getCurrentTimeInMS();h();h=datetime.getCurrentTimeInMS()-d;c(l+" ran in "+h+" ms.")},objectIsEmpty:function(h){for(var l in h)return false;
return true},objectSize:function(h){var l=0,d;for(d in h)l++;return l},objectPropertyNames:function(h){var l=[],d;for(d in h)l.push(d);return l},copyObject:function(h){return $.extend({},h)},deepCopyObject:function(h){return $.extend(true,{},h)},copyArray:function(h){return h.slice(0)},deepCopyArray:function(h){return $.extend(true,[],h)},createArrayOfIdenticalElements:function(h,l){for(var d=Array(l),g=0;g<l;g++)d[g]=h;return d},isAlpha:function(h){return m.test(h)},isDigit:f,isOnlyDigits:function(h){for(var l=
0;l<h.length;l++)if(!f(h.charAt(l)))return false;return true},isPrefixMatch:function(h,l){return h.lastIndexOf(l,0)===0},zeroPadInteger:function(h,l){var d=h.toString();if(d.length>=l)return d;return Array(l-d.length+1).join("0")+d},indexInArray:function(h,l){for(var d=0;d<h.length;d++)if(h[d]===l)return d;return-1},pushArray:function(h,l){h.push.apply(h,l)},regExpEscapeString:function(h){return h.replace(/[-\[\]{}()*+?.,\\^$|#]/g,"\\$&")},generateUUID:function(){return b()+b()+"-"+b()+"-"+b()+"-"+
b()+"-"+b()+b()+b()},parseJsonWithErrorHandling:k,parseJsonListWithErrorHandling:function(h,l){if(l===undefined)l=null;for(var d=[],g=0;g<h.length;g++){var j=false,o=k(h[g],function(){j=true});if(j){l!==null&&l();return null}d.push(o)}return d}}}(),payments=function(){function a(){if(l){$(".freeOnly").remove();$(".proOnly").removeClass("proOnly")}else{$(".proOnly").remove();$(".freeOnly").removeClass("freeOnly")}}function c(){if(typeof Stripe!=="undefined"){Stripe.setPublishableKey(STRIPE_PUBLIC_KEY);
jQuery.validator.addMethod("cardNumber",Stripe.validateCardNumber,"Please enter a valid card number");jQuery.validator.addMethod("cardCVC",Stripe.validateCVC,"Please enter a valid security code");jQuery.validator.addMethod("cardExpiry",function(){return Stripe.validateExpiry($(".card-expiry-month").val(),$(".card-expiry-year").val())},"Please enter a valid expiration");var j=$("#stripe-form");j.show();j.validate({submitHandler:m,rules:{"card-cvc":{cardCVC:true,required:true},"card-number":{cardNumber:true,
required:true},"card-expiry-year":"cardExpiry"}});b();d=true}}function f(){if(d){$("#plan-upgrade-dialog").dialog("open");l?_gaq.push(["_trackPageview","/virtual/payments/change_card_dialog/"]):_gaq.push(["_trackPageview","/virtual/payments/pro_upgrade_dialog/"])}else ui_sugar.showAlertDialog("Sorry, we've encountered an unexpected error. Please email help@workflowy.com if this problem persists after reloading the page.")}function b(){$(".card-number").attr("name","card-number");$(".card-cvc").attr("name",
"card-cvc");$(".card-expiry-year").attr("name","card-expiry-year")}function k(){$("#team-dialog").append('<div class="notice"><strong>Thanks for joining WorkFlowy for Teams!</strong> Please invite your team members, then reload WorkFlowy to activate your new features. <br><div class="fancyButton reloadButton" style="margin-top:10px;">Reload WorkFlowy</div></div>').dialog("open")}function m(j){$(".card-number").removeAttr("name");$(".card-cvc").removeAttr("name");$(".card-expiry-year").removeAttr("name");
$(j["submit-button"]).attr("disabled","disabled");var o=$(".payment-form");o.addSpinner();var n=function(r){if("error"in r)q();else{o.removeSpinner();if($("#choose-your-plan [type=radio]:checked").is(".team")){closeAllDialogs();k()}else{$("#payment-page").hide();$("#payment-succeeded").show()}$("#plan-upgrade-dialog").css("height","auto");$(j).find(":input").each(function(){$(this).val("")});IS_CHROME_APP&&indexeddbhelper.getStores().otherData.write(g,true);l?_gaq.push(["_trackPageview","/virtual/payments/change_card_succeeded"]):
_gaq.push(["_trackPageview","/virtual/payments/pro_upgrade_succeeded"])}},q=function(){$("#stripe-form > .globalerror").show();o.removeSpinner();l?_gaq.push(["_trackPageview","/virtual/payments/change_card_failed"]):_gaq.push(["_trackPageview","/virtual/payments/pro_upgrade_failed"])};Stripe.createToken({name:$(".payment-form input[name=name]").val(),number:$(".card-number").val(),cvc:$(".card-cvc").val(),exp_month:$(".card-expiry-month").val(),exp_year:$(".card-expiry-year").val()},100,function(r,
t){if(t.error){o.removeSpinner();$(j["submit-button"]).removeAttr("disabled");$(".payment-errors").html(t.error.message);b();_gaq.push(["_trackPageview","/virtual/payments/stripe_rejected_credit_card_info"])}else{var v=$('<input name="stripeToken" value="'+t.id+'" style="display:none;" />');j.appendChild(v[0]);var x={};j=$(j);j.find(":input").each(function(){if(!$(this).is("[type=radio]")||$(this).attr("checked")===true)x[$(this).attr("name")]=$(this).val()});$.ajax({url:l?j.attr("data-proaction"):
j.attr("data-freeaction"),data:x,dataType:"json",type:"POST",success:n,error:q})}});return false}function h(j,o,n){$.ajax({url:"https://api.stripe.com/v1/tokens",type:"GET",username:STRIPE_PUBLIC_KEY,data:{card:{name:j.name,number:j.number,exp_month:j.exp_month,exp_year:j.exp_year,cvc:j.cvc},_method:"POST"},success:function(q,r,t){n(t.status,q)}})}var l=null,d=false,g="showProWelcome";return{init:function(){if(l===null)l=USER_EMAIL_ADDED;a($("body"));if(l){$("body").addClass("pro_member");if(SUBSCRIPTION_CANCELLED)$(".showIfSubscriptionCancelled").show();
else HAS_ACTIVE_SUBSCRIPTION&&$(".showIfSubscriptionActive").show();$(".subscriptionEndsDateString").text(SUBSCRIPTION_ENDS_DATE_STRING)}for(var j=$(".card-expiry-month"),o=(new Date).getMonth()+1,n=1;n<=12;n++)j.append($('<option value="'+n+'" '+(o===n?"selected":"")+">"+n+"</option>"));j=$(".card-expiry-year");o=(new Date).getFullYear();for(n=0;n<12;n++)j.append($('<option value="'+(n+o)+'" '+(n===0?"selected":"")+">"+(n+o)+"</option>"));$(".reloadButton").clickOrTapHandler({event:function(){reloadPageFromServer()}});
n=$("#plan-upgrade-dialog").dialog({width:l?390:725,height:l?280:575,modal:true,title:l?"Change Payment Details":"Upgrade to WorkFlowy Pro",autoOpen:false});l&&n.dialog("option",{close:function(){$("#payment-page").show();$("#payment-succeeded").hide()}});$("#proPitchDialog").dialog({width:430,modal:false,title:"WorkFlowy Pro",position:["right","bottom"],autoOpen:false});$("#proPitchDialog > .upgrade-button").live("click",function(){_gaq.push(["_trackPageview","/virtual/payments/pro_pitch_dialog/learn_more_button_clicked/"])});
$("#tutorialProPitchSlide > .upgrade-button").live("click",function(){_gaq.push(["_trackPageview","/virtual/payments/new_user_tutorial_pro_pitch/learn_more_button_clicked/"])});$(".proPitch").live("click",function(){$("#proPitchDialog").dialog("open");_gaq.push(["_trackPageview","/virtual/payments/bottom_right_go_pro_button_clicked/"])});$(".upgrade-button, #premium-features-more-button").live("click",function(){f()});$(".team-upgrade-button").live("click",function(){payments.isPro()?$("#teamUpgradeDialog").dialog("open"):
payments.promptPayment();return false});$("#teamUpgradeDialog").dialog({width:500,autoOpen:false,title:"WorkFlowy for Teams",open:function(){$(this).find(":radio").eq(1).attr("checked","checked")}});$(".teamUpgradeButtonSubmit").live("click",function(){var r=$("#teamUpgradeDialog"),t=$(".error",r).hide();r.addSpinner();$.ajax({type:"POST",url:"/plan",data:{plan:$(":radio:checked",r).val()},success:function(){r.removeSpinner();r.dialog("close");k()},error:function(){r.removeSpinner();t.show()}})});
$("#premium-cancel-button").live("click",function(){payments.cancelPayment()});if(l){$("#pro_welcome_dialog").dialog({width:600,modal:false,autoOpen:false,title:"Welcome to WorkFlowy Pro"});var q=function(){$("#pro_welcome_dialog").dialog("open")};if(IS_CHROME_APP)indexeddbhelper.getStores().otherData.read(g,function(r){if(r===true){q();indexeddbhelper.getStores().otherData.remove(g)}});else!IS_MOBILE&&FIRST_LOAD_FLAGS.showProWelcome&&q()}c();if(IS_CHROME_APP&&d)Stripe.createToken=h;$("#team-dialog").dialog({width:670,
height:420,title:"Your Team",autoOpen:false,open:function(){$(this).append('<iframe src="/team/?is_in_dialog" style="width:630px; height:340px;"></iframe>')},close:function(){$(this).html("")}});FIRST_LOAD_FLAGS.showUpgradeDialog&&n.dialog("open")},cancelPayment:function(){function j(){var o=$("#proSettingsBox");o.addSpinner();$.ajax({url:"/cancel_pro",type:"POST",dataType:"json",success:function(n){o.removeSpinner();if(n.cancelled){$("#premium-cancel-button").replaceWith('<p id="premium-cancelled-message">Your Pro account has been cancelled.</p>');
showMessage("Your Pro account has been cancelled.");_gaq.push(["_trackPageview","/virtual/payments/cancelled_pro_account"])}else $("#premium-cancel-button").replaceWith('<p id="premium-cancelled-message">There was an error cancelling your WorkFlowy Pro membership. Please reload the page and try again. If it still doesn\'t work, email help@workflowy.com</p>')}})}ui_sugar.showAlertDialog("Please confirm that you would like to cancel your WorkFlowy Pro account.","Cancel Pro Account",true,[{text:"Yes, cancel it",
click:function(){j();$(this).dialog("close")}}],"No, keep it")},promptPayment:f,isPro:function(){return l},removeFreeOrProAsNeededFromDOMSubtree:a}}(),ui_sugar=function(){jQuery.fn.addSpinner=function(){$(this).each(function(a,c){$(c).css("position")==="static"&&$(c).css("position","relative");$(c).append('<div class="spinnerWrapper"><div class="spinner"></div></div>')});return this};jQuery.fn.removeSpinner=function(){$(this).each(function(a,c){$(c).find(".spinnerWrapper").remove()});return this};
jQuery.fn.flashColor=function(a){var c=$(this),f=$("<div>").css({backgroundColor:a,opacity:0,position:"absolute",top:0,left:0,width:"100%",height:"100%"});c.append(f);f.css({opacity:0.9}).animate({opacity:0},500,function(){f.remove()})};return{showAlertDialog:function(a,c,f,b,k){if(c===undefined)c="";if(f===undefined)f=true;if(b===undefined)b=null;if(k===undefined)k=null;a=$('<div class="alertDialog">'+a+"</div>");a.appendTo($("body"));b=b!==null?b:[];b.push({text:k!==null?k:"Close",click:function(){$(this).dialog("close")}});
a.dialog({width:500,modal:f,position:["center",150],title:c,close:function(){$(this).dialog("destroy").remove()},buttons:b})}}}(),quota=function(){function a(b){if(!(payments.isPro()||projecttree.getMainProjectTree().isShared()||IS_MOBILE))if(!b.isAuxiliary()){var k=b.getItemsCreatedInCurrentMonth();b=b.getMonthlyItemQuota();var m=k/b;if(m>1)m=1;$(".quotaUsedThisMonth").text(k);$(".quotaMonthlyItems").text(b);$(".quotaProgressBar").each(function(h,l){var d=$(".currentProgress",l),g=$(l).outerWidth();
d.css({width:m*g+"px"})});m>=0.7?c():f()}}function c(){var b=$(".hiddenQuotaProgressContainer");if(!b.is(":visible")){b.addClass("visible");_gaq.push(["_trackPageview","/virtual/payments/showed_quota_progress_bar"])}}function f(){var b=$(".hiddenQuotaProgressContainer");if(b.is(":visible")){b.removeClass("visible");_gaq.push(["_trackPageview","/virtual/payments/hid_quota_progress_bar"])}}return{init:function(){a(projecttree.getMainProjectTree());$(".overQuotaDialog").dialog({autoOpen:false,width:450,
modal:true,position:["center",180],title:"Usage Quota Reached"})},notifyQuotaStatsChangedForProjectTree:function(b){a(b)},notifyLocalCreateWhileOverQuotaForProjectTree:function(b){if(b.isShared()){$("#sharedOverQuotaDialog").dialog("open");_gaq.push(["_trackPageview","/virtual/payments/showed_shared_over_quota_notice"])}else{$("#overQuotaDialog").dialog("open");_gaq.push(["_trackPageview","/virtual/payments/showed_over_quota_notice"])}},updateProgressBars:a}}(),referral=function(){return{init:function(){function a(c,
f,b){f=f||"fb";b=b||"&utm_campaign=referral_free_space&utm_medium=facebook&utm_source=wf";f=REFERRAL_LINK+"."+f+b;FB.ui({method:"feed",link:f,picture:"https://workflowy.com/media/i/workflowy_icon_rounded_corners_512x512.png",name:"WorkFlowy - Organize Your Brain. For free!",caption:"workflowy.com",description:"Have you tried\u00a0WorkFlowy\u00a0yet? Excellent way to organize your to-dos and other thoughts.",actions:[{name:"Try WorkFlowy",link:f}]},function(k){k&&k.post_id&&c!==undefined&&c()})}$("#referralDialog").dialog({title:"Get Free Space",
autoOpen:false,width:560,modal:true,open:function(){if(IS_CHROME_APP){var c=$($("#referralDialogTemplate").html());c.find("input.referralLink").attr("readonly",false).val(REFERRAL_LINK).attr("readonly",true);c=c}else c=_.template($("#referralDialogTemplate").html())({referral_link:REFERRAL_LINK});$("#referralDialog").html(c)},close:function(){$("#referralDialog").html("")}});$("#getMoreSpaceDialog").dialog({title:"Get More Space",autoOpen:false,width:560,modal:false});$(".getMoreSpaceButton").live("click",
function(){$("#getMoreSpaceDialog").dialog("open")});$("#referral_tweet_button").live("click",function(){var c=escape($("#referral_share_message_text").val());window.open("http://twitter.com/share?text="+c+"&url=%20","Share this on Twitter","menubar=no,width=550,height=450,toolbar=no");_gaq.push(["_trackPageview","/virtual/referral/twitter/share_button_clicked"])});$("#old_tweet_button").live("click",function(){_gaq.push(["_trackPageview","/virtual/share_buttons/twitter/share_button_clicked"])});
$("#free_workflowy_items, .free_items, .referralButton").live("click",function(){if(experiments.enabled("email_referrals")){var c="/referrals/";if(IS_CHROME_APP)c="https://workflowy.com"+c;window.open(c)}else $("#referralDialog").dialog("open");metrics.track("referrals:dialog_opened")});$("#facebookReferral").live("click",function(){a(function(){_gaq.push(["_trackPageview","/virtual/referral/facebook/feed_story_published"])});_gaq.push(["_trackPageview","/virtual/referral/facebook/share_button_clicked"])})}}}(),
library=function(){var a=[{name:"Getting Started",youtubeid:"SOPYrxvojVo",slug:"starting"},{name:"Basics",youtubeid:"Haqx-rWV_ek",slug:"basics"},{name:"Zooming",youtubeid:"Hdini-H9faQ",slug:"zoom"},{name:"Tagging",youtubeid:"1oWUD6y8Wzg",slug:"tag"},{name:"Starring",youtubeid:"E0ElhjtGoho",slug:"star"},{name:"Completing",youtubeid:"DZ6E9HTedgM",slug:"complete"},{name:"Collaboration",youtubeid:"OPcOgM9r_vY",slug:"collaborate"},{name:"Search",youtubeid:"AWKbj4kVS6s",slug:"search"},{name:"Move",youtubeid:"o8fgVxXIFys",
slug:"move"},{name:"Delete",youtubeid:"0g5UkwWI2lc",slug:"delete"},{name:"Duplicate",youtubeid:"OVH5OM4aV5Y",slug:"duplicate"},{name:"Expand & Collapse",youtubeid:"8Nw0hUP58q0",slug:"expand"},{name:"Import & Export",youtubeid:"sYW5h7iUp_I",slug:"import"},{name:"Indent",youtubeid:"45M5xU3J_-0",slug:"indent"},{name:"Print",youtubeid:"CYDKRLBzESY",slug:"print"},{name:"Undo",youtubeid:"J4IlOOZmTwg",slug:"undo"},{name:"Settings",youtubeid:"vvZcGKq0ptQ",slug:"settings"}],c,f={id:"#videoLibraryPlayer",player:null,
width:400,height:225},b,k=true,m=function(){if(localstoragehelper.localStorageSupported()){var r=localstoragehelper.read("videoLibraryHistory");if(r!==null)try{b=JSON.parse(r)}catch(t){localstoragehelper.remove("videoLibraryHistory");b=[]}}if(b===undefined)b=[]},h=function(){var r;$.each(a,function(t,v){if($.inArray(v.youtubeid,b)===-1){r=v;return false}});return r},l=function(){$("#helpWindow").dialog("open");_gaq.push(["_trackPageview","/virtual/how_to/opened_in_onboarding_tutorial"])},d=function(){$("#libraryContainer").height($("#libraryContainer > .contents").outerHeight()+
15);var r=$("#libraryContainer").closest(".ui-dialog");if(r.is(":visible")){var t=[r.outerWidth(),r.outerHeight()],v=[$(window).width(),$(window).height()],x={top:v[1]-t[1]-20,left:v[0]-t[0]-20};if(t[1]>v[1])x.top=20;r.css({top:x.top,left:x.left});return r}},g=function(r,t){t=t||false;o.load({book:r,play:t});$("#currentBook .bookName").html(r.name);$(".book").removeClass("active");$("#book"+r.youtubeid).addClass("active");c=r;$("#libraryContainer").scrollTop(0)},j=function(){var r=$("#libraryContainer"),
t=$("#bookList > .content",r);$.each(a,function(v,x){var e=$.inArray(x.youtubeid,b)!==-1?"done":"";t.append('<a id="book'+x.youtubeid+'" class="book fancyButton '+e+'" href="#'+x.youtubeid+'" data-bookid='+v+">"+x.name+"</a> ")})},o=function(){var r;return{load:function(t){_.extend({play:false},t);r.load(t)},pause:function(){r.pause()},setStrategy:function(t){r=t}}}(),n=function(){function r(t){var v="https://youtube.com/embed/"+t.book.youtubeid,x="?rel=0&showinfo=0&wmode=transparent&fs=0&modestbranding=1";
if(t.play)x+="&autoplay=1";var e=$("<webview>");e.attr("src",v+x);e.css({width:f.width+"px",height:f.height+"px"});setTimeout(function(){$(f.id).html(e)},0);k=false}return{load:r,pause:function(){return r({book:c,play:false})}}}(),q=function(){var r=false,t=function(){var x=false;return function(){if(!x){x=true;k&&FIRST_LOAD_FLAGS.isNewUser&&f.player.playVideo();k||f.player.cueVideoById(c.youtubeid);k=false}}}(),v=function(x){var e=$("#afterLibraryVideoCompleteBox");x.data===0?e.show():e.hide();if(x.data===
1){x=c.youtubeid;if($.inArray(x,b)===-1){b.push(x);if(localstoragehelper.localStorageSupported()){e=JSON.stringify(b);localstoragehelper.write("videoLibraryHistory",e)}$("#book"+x).addClass("done")}_gaq.push(["_trackPageview","/virtual/how_to/video/play/"+c.youtubeid])}};return{load:function(x){if(r)f.player.loadVideoById(x.book.youtubeid);else{x=document.createElement("script");x.src="//www.youtube.com/iframe_api";var e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(x,e)}},
pause:function(){f.player.pauseVideo()},youTubeAPIReady:function(){r=true;f.player=new YT.Player($(f.id)[0],{height:f.height,width:f.width,videoId:c.youtubeid,events:{onReady:t,onStateChange:v},playerVars:{autoplay:0,showinfo:0,theme:"light",rel:0,modestbranding:1,autohide:1,fs:0}})}}}();return{displayBooks:j,init:function(){if(!IS_MOBILE){IS_CHROME_APP?o.setStrategy(n):o.setStrategy(q);m();j();$(".book").live("click",function(){var r=$(this);r.addClass("done");r=a[r.data("bookid")];g(r,true);return false}).live("mousedown",
function(){return false});$("#helpWindow").dialog({autoOpen:false,width:f.width+50,modal:false,title:"Help",open:function(){if(k){var r=k&&FIRST_LOAD_FLAGS.isNewUser?true:false;g(h()||a[0],r)}d()},close:function(){o.pause();$("#helpButton").flashColor("#fff");getCurrentlyFocusedContentOrInput()===null&&focusFirstProject()}}).closest(".ui-dialog").css("position","fixed");$("#helpRadio span").click(function(){$("#helpWindow .pane").hide();$("#helpWindow .pane."+$(this).data("pane")).show();$("#helpRadio > span").removeClass("current");
$(this).addClass("current");d()});$("#helpButton").click(function(){var r=$("#helpWindow");r.dialog("isOpen")?r.dialog("close"):r.dialog("open")}).mousedown(function(){return false});FIRST_LOAD_FLAGS.showNewUserTutorial&&l();$("#nextVideoButton").live("click",function(){g(h()||a[0],true)})}},videoHistory:b,startOnboardingTutorial:l,reposition:d,youTubeAPIReady:function(){q.youTubeAPIReady()}}}();function onYouTubeIframeAPIReady(){library.youTubeAPIReady()}
var apphooks=function(){function a(m,h){if(h===undefined)h=null;var l=m+":";if(h!==null)l+="#iOS#"+h;var d=document.createElement("IFRAME");d.setAttribute("src",l);document.documentElement.appendChild(d);d.parentNode.removeChild(d)}function c(){return projecttree.getAllProjectTreesHelper().haveUnsavedData()}function f(){c()&&pushpoll.scheduleNextPushAndPoll(true)}function b(){appdetect.isIOSApp()&&!c()&&!(APPCACHE_ENABLED&&appcachehelper.isCurrentlyDownloading())&&appdetect.getIOSAppVersion()>=3&&
a("ios-all-business-finished")}if(appdetect.isIOSApp()){var k=function(m){a("ios-log",m)};window.console={log:k,debug:k,info:k,warn:k,error:k}}return{haveUnfinishedBusiness:function(){return c()||APPCACHE_ENABLED&&appcachehelper.isCurrentlyDownloading()},finishAllBusiness:function(){f()},shouldWaitForCustomDocumentReady:function(){return true},haveUnsavedChanges:c,saveImmediately:f,notifyDocumentReady:function(){appdetect.isIOSApp()&&appdetect.getIOSAppVersion()>=4&&a("ios-document-ready")},notifyThatAllChangesAreSaved:function(){if(appdetect.isIOSApp())appdetect.getIOSAppVersion()<
3?a("ios-all-changes-saved"):b()},notifyThatAppCacheIsNowCached:function(){if(appdetect.isIOSApp()){appdetect.getIOSAppVersion()>=3&&a("ios-app-cached");b()}},notifyThatAppCacheIsNowUncached:function(){appdetect.isIOSApp()&&appdetect.getIOSAppVersion()>=3&&a("ios-app-uncached")},exitWhenBackgrounded:function(){appdetect.isIOSApp()&&appdetect.getIOSAppVersion()>=5&&a("ios-exit-when-backgrounded")}}}(),ranges=function(){function a(b,k){var m=b.is(".project")&&k.is(".project");if(b.is(".childrenEnd")&&
k.is(".childrenEnd")||m)return b.getProject().attr("projectid")===k.getProject().attr("projectid");return false}var c=Class.extend({init:function(b,k){if(k===undefined)k=false;this.startingProjectReference=b;this.isForMoving=k;this.ranges=[];var m=".project";if(k)m+=", .childrenEnd";var h=this.startingProjectReference.getMatchingDomProject();if(k){m=h.next(m);if(m.length===1&&this.startingProjectReference.isValidMove(m)){h.css({display:"none"});this.createElementRange(m)}else this.createElementRange(h)}else this.createElementRange(h)},
getIsForMoving:function(){return this.isForMoving},getStartingProjectReference:function(){return this.startingProjectReference},createElementRange:function(b){b=new f(b,this);this.ranges.push(b);return b},getRangeForPosition:function(b){for(var k;;){k=this.getClosestExistingRange(b);if(b<k.top){if(k.previous!==undefined||k.isFirst===true||k.createPrevious()===false)break}else if(b>k.top){if(k.next!==undefined||k.isLast===true||k.createNext()===false)break}else break}return k},getClosestExistingRange:function(b){var k=
this.ranges[0];$.each(this.ranges,function(m,h){if(h.distanceFromPosition(b)<k.distanceFromPosition(b))k=h});return k}}),f=Class.extend({init:function(b,k){var m=b.offset();this.verticalRangeFinder=k;this.top=m.top;this.left=m.left;this.projectReference=projecttree.getProjectReferenceFromDomProject(b.getProject());this.isChildrenEnd=b.is(".childrenEnd");this.height=b.children(".name").outerHeight()+b.children(".notes").outerHeight();this.width=b.outerWidth();if(this.verticalRangeFinder.getIsForMoving())this.isValidMove=
this.verticalRangeFinder.getStartingProjectReference().isValidMove(this.getElement())},getIsValidMove:function(){return this.isValidMove},getOffset:function(){return{top:this.top,left:this.left}},getWidth:function(){return this.width},getHeight:function(){return this.height},getElement:function(){var b=this.projectReference.getMatchingDomProject();if(this.isChildrenEnd)b=b.children(".children").children(".childrenEnd");return b},distanceFromPosition:function(b){return Math.abs(b-this.top)},createPrevious:function(){var b=
this.getElement(),k=b.getPreviousProject(this.verticalRangeFinder.getIsForMoving());if(a(b,k)||k.is(".selected")){this.isFirst=true;return false}else{this.previous=this.verticalRangeFinder.createElementRange(k);return true}},createNext:function(){var b=this.getElement(),k=b.getNextProject(false,this.verticalRangeFinder.getIsForMoving());if(a(b,k)){this.isLast=true;return false}else{this.next=this.verticalRangeFinder.createElementRange(k);return true}},equals:function(b){return this.projectReference.equals(b.projectReference)}});
return{VerticalRangeFinder:c}}(),moving=function(){function a(t){$(g).unbind(".cancelDrag");n=null;t=t.originalEvent;d.reset();d.setLastTouch(t.touches[0]);d.startY=d.lastTouch.clientY;t=m.getMatchingDomProject().getName();j=t.clone().addClass("draggableNameClone").append('<div class="highlight"></div>').css({position:"fixed",top:t.offset().top-$(document).scrollTop(),left:t.offset().left,width:t.outerWidth(),zIndex:1E3,fontSize:t.css("fontSize"),lineHeight:t.children(".content").css("lineHeight")}).appendTo("body")[0];
$(j).children(".content").removeAttr("contenteditable");t.css({opacity:0});b();t=m.getMatchingDomProject();t.is(".task")&&$(j).addClass("noHalo");t.css({height:0});t.children(".children").css({display:"none"});k();r.scrollIfNeeded();$(g).bind("touchmove.dragging",function(v){d.setLastTouch(v.originalEvent.touches[0]);d.deltaY=d.lastTouch.clientY-d.startY;r.scrollIfNeeded(true);b();k();return false}).bind("touchend.dragging",function(){c()}).bind("touchcancel.dragging",function(){c(true)});q=setInterval(function(){if(f()){c(true);
$(g).one("touchend",function(){return false})}},1E3);DRAG_MOVE_MODE=true}function c(t){if(t===undefined)t=false;DRAG_MOVE_MODE=false;clearInterval(q);r.stopScrolling();var v=m.getMatchingDomProject();if(l!==null&&!l.projectReference.equals(m)&&!t){undoredo.startOperationBatch();v=v.moveProject(l.getElement());undoredo.finishOperationBatch()}v.children(".name").css({opacity:""});v.css({height:"",top:"",display:""});v.children(".children").css({display:""});v.addClass("highlighted moveHovered");setTimeout(function(){v.removeClass("highlighted moveHovered")},
250);h=null;d.reset();l=null;$("#mobileMoveDropLine").hide().removeAttr("style");$(g).unbind(".dragging");$(j).remove()}function f(){var t=datetime.getCurrentTimeInMS()-r.mostRecentNewScroll;if(datetime.getCurrentTimeInMS()-d.lastTouch.time>5E3&&t>5E3)return true;return false}function b(){var t=d.deltaY-o.y;j.style.MozTransitionDuration=j.style.webkitTransitionDuration=0;j.style.MozTransform=j.style.webkitTransform="translate3d("+-o.x+"px,"+t+"px,0)"}function k(){if(h===null)h=new ranges.VerticalRangeFinder(m,
true);var t=h.getRangeForPosition(d.lastTouch.clientY+$(document).scrollTop()-o.y);if(t.getIsValidMove()){var v=t.getOffset();$("#mobileMoveDropLine").css({top:v.top,left:v.left,width:t.getWidth(),display:"block"});l=t}}var m,h=null,l=null,d={deltaY:0,scrollTop:0,lastTouch:null,setLastTouch:function(t){this.lastTouch={clientY:t.pageY-$(document).scrollTop(),pageY:t.pageY,time:datetime.getCurrentTimeInMS()}},reset:function(){this.scrollTop=this.deltaY=0;this.lastTouch=null}},g,j,o={x:5,y:2},n=null,
q,r={MAX_SCROLL_SPEED:1E3,mostRecentScrollTime:-1,mostRecentNewScroll:null,isScrolling:false,timeout:null,scrollTopHistory:[0],stopScrolling:function(){if(this.timeout!==null){clearTimeout(this.timeout);this.timeout=null}this.isScrolling=false;this.mostRecentScrollTime=-1},scrollIfNeeded:function(t){if(!(t===true&&r.isScrolling)){t=r.getSpeed();t!==0?r.scroll(t):r.stopScrolling()}},getSpeed:function(){function t(w){w=1-w/r.scrollRange();if(w>1)w=1;if(w<0)w=0;w=Math.pow(w,2);return r.MAX_SCROLL_SPEED*
w}var v=window.innerHeight?window.innerHeight:$(window).height(),x=d.lastTouch.clientY;v=v-x;var e=x<r.scrollRange(),p=v<r.scrollRange(),s=0;if(e)s=-t(x);else if(p)s=t(v);return Math.round(s)},scrollRange:function(){return(window.innerHeight?window.innerHeight:$(window).height())*0.15},scroll:function(t){r.isScrolling=true;var v=datetime.getCurrentTimeInMS(),x=0;if(r.mostRecentScrollTime!==-1)x=(v-r.mostRecentScrollTime)/1E3;t=Math.round(t*x);var e=$(document).scrollTop();$(document).scrollTop(e+
t);x<0.03&&k();this.scrollTopHistory.unshift(e);if(this.scrollTopHistory[0]!==this.scrollTopHistory[1])this.mostRecentNewScroll=v;this.mostRecentScrollTime=v;this.timeout=setTimeout(this.scrollIfNeeded,this.MS_PER_FRAME)},MS_PER_FRAME:16};return{setupMobileDragging:function(t){var v=navigator.userAgent.indexOf("Chrome")!==-1;if(!(IS_ANDROID&&!v)){g=this;v=$(this).getProject();m=projecttree.getProjectReferenceFromDomProject(v);var x=getCurrentlyFocusedContentOrInput()!==null;if(!(v.is(".selected")||
x||$(this).closest(".name")[0]===undefined||m.isInReadOnlyTree()))if(n===null){n=setTimeout(function(){a(t)},500);$(this).bind("touchmove.cancelDrag touchend.cancelDrag",function(){if(n!==null){clearTimeout(n);n=null}})}}}}}();
jQuery.fn.makeDraggable=function(){$(this).draggable({axis:"y",helper:"original",cursor:"pointer",distance:1,start:function(a,c){var f=$(this).getProject();DRAG_MOVE_MODE=true;clearTimeout(TIMEOUTS.hideControls);f.addClass("moving");var b=projecttree.getProjectReferenceFromDomProject(f);c.helper.movedProjectReference=b;selectOnActivePage(".dropTarget:visible").not(f.find(".dropTarget:visible")).each(function(){var k=$(this),m=k.getProject();m.is(".selected, .parent")||b.isValidMove(m)&&k.droppable({over:function(){$(this).getProject().before($("#sortDrop"))}})});
selectOnActivePage(".childrenEnd:visible").not(f.find(".childrenEnd:visible")).each(function(){var k=$(this);b.isValidMove(k)&&k.droppable({over:function(){$(this).before($("#sortDrop"))}})})},stop:function(a,c){DRAG_MOVE_MODE=false;c.helper.removeAttr("style");var f=c.helper.movedProjectReference.getMatchingDomProject(),b=$("#sortDrop");if(f.length==1){f.removeAttr("style");if(b.is(":visible")){var k=b.next(".project, .childrenEnd");undoredo.startOperationBatch();f=f.moveProject(k);undoredo.finishOperationBatch();
f.addClass("moving")}setTimeout(function(){selectOnActivePage(".moving").removeClass("moving")},500)}selectOnActivePage(".dropTarget.ui-droppable, .childrenEnd.ui-droppable").droppable("destroy");b.appendTo("#hidden")}});return this};
var messages=function(){function a(){var h=c().filter(".onboarding");if(h.length===0)return null;if(b()===m)return h.first();var l,d;for(i=0;i<h.length;i++){d=h.eq(i);if(d.data("messageid")===b()){l=i+1;break}}h=h.eq(l);if(h.length!==0)return h;return null}function c(){return $("#site_message > .message").filter("[data-channel="+k()+"]")}function f(){var h=JSON.parse(SETTINGS.last_seen_message_json_string.value);if(h[k()]===undefined)h[k()]={};return h}function b(){lastSeenMessageJSON=f();if(lastSeenMessageJSON.do_not_show===
true)return"do_not_show";return lastSeenMessageJSON[k()].messageid||null}function k(){return IS_MOBILE?"mobile":"desktop"}var m="first_time_use";return{init:function(){var h;if(FIRST_LOAD_FLAGS.isNewUser)h=m;else{h=!FIRST_LOAD_FLAGS.isNewUser&&b()===null;var l=a();if(l===null||h){h=c().not(".onboarding").first();l=h.length>0&&b()!=="do_not_show"&&h.data("messageid")!==b()?h:null}h=l===null?null:l.data("messageid")}if(h!==null){l=$(".message[data-messageid="+h+"]");if(l.length!==0){c().removeClass(".current");
l.addClass("current");$("#site_message").slideDown()}h=h;l=f();l[k()].messageid=h;h=JSON.stringify(l);settings.changeSettings({last_seen_message_json_string:h})}}}}(),savedviews=function(){function a(z){if(z===undefined)z=false;if(!(G===null||!G)){v=b(SETTINGS.saved_views_json.value);if(v===null)v=[];if(!z){n();J&&g()}}}function c(){D!==null&&clearTimeout(D);D=null}function f(z){z=$(z.target);z.closest("#savedViewHUD").length===1||z.closest(".pageStar").length===1||z.closest("#savedViewHUDButton").length===
1||d()}function b(z){var F=null;try{F=JSON.parse(z)}catch(C){return null}z=[];for(var M=0;M<F.length;M++)z.push(new R(F[M]));return new S(z)}function k(){var z=projecttree.getProjectReferenceFromDomProject(selectOnActivePage(".selected")),F=z.getNonPlaceholderReferenceIfApplicable(),C=F!==null?F:z;z=search.inSearchMode()?search.getSearchQuery().getSearchString():null;F={projectid:C.isTreeRoot()?null:C.getProjectId()};C=C.getProjectTree();if(C.isAuxiliary())F.auxiliaryRootProjectId=C.getRootProjectId();
F={zoomedProject:F};if(z!==null)F.searchQuery=z;z=new R(F);z.notifyWasJustViewed();return z}function m(z){if(z===undefined)z=false;var F=animations.getAnimationSpeed(O);if(animations.animationsAreInProgress())z&&d();else{var C=p;if(C===null||!C.isValid())z&&d();else{var M=k();if(C.equals(M))z&&d();else{var Q;Q=A!==null&&A.equals(C)?B==="right"?"left":"right":e.getSwitchDirection(M,C);A=M;B=Q;var X=C.getZoomedProjectReferenceIfValid(),V=C.getSearchString();selectOnActivePage(".mainTreeRoot").clearControlsUnderProject();
$(window).scrollTop(0);var Y=null,T=function(){$(".page:not(.active)").hide().remove();$(".page.active").removeAttr("style");$("body").removeAttr("style");Y!==null&&Y.removeAttr("style");if(!IS_MOBILE){var U=selectOnActivePage(".selected"),Z=U.getVisibleChildren().first();if(Z.length===0)Z=U.is(".mainTreeRoot")?null:U;if(Z!==null){U=Z.getName();F==="animate"?animations.getAnimationCounter().setContentToFocus(U.children(".content")):U.moveCursorToBeginning()}}X.setTitleAndFragmentPathForProject();
location_history.setLocationModificationInProgress(false);z&&d()};C=$(".page.active");C.removeClass("active");C.find(".content").removeAttr("contenteditable");M=createPage();M.addClass("active");CURRENTLY_ACTIVE_PAGE=M;shouldShowCompletedProjects()&&M.addClass("showCompleted");location_history.setLocationModificationInProgress(true);search.searchProjectTree(V,true,X);X.constructProjectTreeAsSelected();q(true);if(F==="animate"){animations.getAnimationCounter().addCallback(T);$("body").css("overflow-x",
"hidden");V=$(window).width();T=M.outerWidth();V=(V-T)/2+T;if(Q==="right"){Q="-";T=""}else{Q="";T="-"}var W={position:"absolute",top:0,width:C.css("width")};if(I)W.left=T+V+"px";else W.transform="translate("+T+V+"px, 0px)";M.css(W);if(I){M.incrementAnimationCounter().animate({left:"0px"},animations.getAnimationTiming("pageSlide"),function(){animations.getAnimationCounter().decrement()});P||C.incrementAnimationCounter().animate({left:Q+V+"px"},animations.getAnimationTiming("pageSlide"),function(){animations.getAnimationCounter().decrement()})}else{M.incrementAnimationCounter().transition({x:"0px"},
animations.getAnimationTiming("pageSlide"),function(){animations.getAnimationCounter().decrement()});P||C.incrementAnimationCounter().transition({x:Q+V+"px"},animations.getAnimationTiming("pageSlide"),function(){animations.getAnimationCounter().decrement()})}h(C);Y=h(M)}else T()}}}}function h(z){var F=$(window).scrollTop()+$(window).height();z=z.find(".selected .project:visible");for(var C=0,M=z.length;C<M;){var Q=Math.floor((C+M)/2);if(z.eq(Q).offset().top>F)M=Q;else C=Q+1}F=z.slice(C);F.hide();
return F}function l(z,F){if(z===undefined)z=null;if(F===undefined)F=null;if(z!==null)s=z;if(F!==null)w=F;L=true;if(!(J||E||H)){var C=$("#savedViewHUD");C.css({opacity:0});C.show();g(w);u=false;E=true;C.animate({opacity:1},100,function(){E=false;if(L)s&&!(!y&&(K||N))&&m(true);else d()});J=true;$("body").bind("click",f)}}function d(z){if(z===undefined)z=false;if(!z)if(!y&&(K||N))return;L=false;c();if(!(!J||E||H)){var F=$("#savedViewHUD"),C=F.find("#savedViewHUDPageContainer");H=true;F.animate({opacity:0},
400,function(){H=false;C.html("");F.hide();J=false;p=e=null;u=false;L&&l()});$("body").unbind("click",f)}}function g(z){if(z===undefined)z="none";var F=k(),C=v.copy();C=C.getValidViews();C.getLength()>0&&x!==null&&x.isValid()&&C.add(x);C.sortByMostRecentlyViewed();e=C;p=e.getNextView(F,z);z=$("#savedViewHUD").find("#savedViewHUDPageContainer");if(e.getLength()>0){F=e.getPageListHtml(p);z.html(F)}else{F=$("#noSavedViewsNoticeTemplate").html();z.html(F)}j("instant",true)}function j(z,F){if(F===undefined)F=
false;z=animations.getAnimationSpeed(z);var C=$("#savedViewHUD");F&&C.scrollLeft(0);var M=C.find(".savedViewPage.selectedSavedViewPage");if(M.length===1){var Q=C.width(),X=C[0].scrollWidth,V=C.scrollLeft(),Y=V+Q,T=M.outerWidth(true),W=M.position().left;T=W+T;var U=null;if(W<V){Q=M.prev(".savedViewPage");U=Q.length===1?Q.position().left+Q.outerWidth(true)*(2/3):0}else if(T>Y){M=M.next(".savedViewPage");U=(M.length===1?M.position().left+M.outerWidth(true)*(1/3):X)-Q}if(U!==null)z==="animate"?C.animate({scrollLeft:U},
150):C.scrollLeft(U)}}function o(z,F){if(F===undefined)F=null;if(F!==null)p=F;else{if(p===null)p=k();p=e.getNextView(p,z)}var C=$("#savedViewHUD");C.find(".savedViewPage.selectedSavedViewPage").removeClass("selectedSavedViewPage");if(p!==null){C=C.find(".savedViewPage[data-uniqueid="+p.getUniqueId()+"]");if(C.length===1){C.addClass("selectedSavedViewPage");j()}}}function n(){var z=selectOnActivePage(".pageStar"),F=k();if(v.contains(F)){z.addClass("starred");z.attr("title","Unstar this page")}else{z.removeClass("starred");
z.attr("title","Star this page")}}function q(z){if(z===undefined)z=false;if(G){var F=k(),C=v.getMatchingView(F);F=C!==null?C:F;C=C!==null;n();if(C){F.notifyWasJustViewed();z||(x=null)}else x=F}}function r(z){if(G)!J||H?l(true,"none"):o(z)}function t(){function z(){settings.changeSettings({saved_views_json:v.getJson()})}var F=selectOnActivePage(".pageStar").hasClass("starred"),C=k();if(F){v.remove(C);z();n();J&&g()}else{v.add(C);z();n();if(x!==null&&x.equals(C))x=null;if(J&&!H)g();else{l(false,"none");
c();D=setTimeout(d,1500)}$("#savedViewHUDButton").flashColor("#aaa")}}var v=null,x=null,e=null,p=null,s=null,w=null,u=false,A=null,B=null,E=false,H=false,J=false,L=false,K=false,N=false,y=false,D=null,G=null,I=null,O="animate",P=false,R=Class.extend({init:function(z){this.info=z;this.uniqueId=this._generateUniqueId();this.lastViewedTimestampInMS=0},getInfo:function(){return this.info},isValid:function(){return this.getZoomedProjectReferenceIfValid()!==null},getZoomedProjectReferenceIfValid:function(){var z=
this.info.zoomedProject,F=z.projectid===null?projecttree.ROOT_PROJECTID:z.projectid;z=projecttree.getProjectTreeByRootProjectId("auxiliaryRootProjectId"in z?z.auxiliaryRootProjectId:null);if(z===null)return null;F=z.getProjectReferenceByProjectId(F);if(!F.isValid())return null;return F=F.getPlaceholderReferenceIfApplicable()},getSearchString:function(){return"searchQuery"in this.info?this.info.searchQuery:""},equals:function(z){function F(M){var Q=M.zoomedProject;return{zoomedProjectInfo:Q,projectTreeRootProjectId:"auxiliaryRootProjectId"in
Q?Q.auxiliaryRootProjectId:null,searchQuery:"searchQuery"in M?M.searchQuery:null}}if(z===null)return false;var C=F(this.info);z=F(z.info);return C.projectTreeRootProjectId===z.projectTreeRootProjectId&&C.zoomedProjectInfo.projectid===z.zoomedProjectInfo.projectid&&C.searchQuery===z.searchQuery},getPageHtml:function(z){var F=this.getZoomedProjectReferenceIfValid();F=F.isMainTreeRoot()?"Home":F.getName();var C=this.getSearchString();return'<div class="savedViewPage '+(this.equals(z)?"selectedSavedViewPage":
"")+'" data-uniqueid="'+this.getUniqueId()+'"><div class="savedViewPageInnerContainer"><div class="savedViewPageName">'+content_text.getHtml(F)+'</div><div class="savedViewPageSearchStringContainer"><span class="savedViewPageSearchString">'+html_utils.htmlEscapeText(C)+'</span></div></div><div class="savedViewPageFader"></div></div>'},getUniqueId:function(){return this.uniqueId},getLastViewedTimestamp:function(){return this.lastViewedTimestampInMS},notifyWasJustViewed:function(){this.lastViewedTimestampInMS=
datetime.getCurrentTimeInMS()},_generateUniqueId:function(){var z=this.info.zoomedProject;z=[["zoomedProjectId",z.projectid],["projectTreeRootProjectId","auxiliaryRootProjectId"in z?z.auxiliaryRootProjectId:null],["searchString",this.getSearchString()]];for(var F="",C=0;C<z.length;C++){var M=z[C][0],Q=z[C][1];if(C!==0)F+=",";F+=M+":"+Q}return hex_md5(F)}}),S=Class.extend({init:function(z){this.viewList=z},getLength:function(){return this.viewList.length},contains:function(z){return this.indexOf(z)!==
-1},getViewByIndex:function(z){return this.viewList[z]},getMatchingView:function(z){z=this.indexOf(z);return z!==-1?this.viewList[z]:null},indexOf:function(z){for(var F=0;F<this.viewList.length;F++)if(this.viewList[F].equals(z))return F;return-1},copy:function(){return new S(utils.copyArray(this.viewList))},add:function(z){if(this.contains(z))return false;this.viewList.push(z);return true},remove:function(z){z=this.indexOf(z);if(z===-1)return false;this.viewList.splice(z,1);return true},getValidViews:function(){for(var z=
[],F=0;F<this.viewList.length;F++){var C=this.viewList[F];C.isValid()&&z.push(C)}return new S(z)},getNextView:function(z,F){var C=this.indexOf(z);if(this.viewList.length===0)return null;var M;switch(F){case "none":M=C===-1?0:C;break;case "left":M=C===-1||C===0?this.viewList.length-1:C-1;break;case "right":M=C===-1||C===this.viewList.length-1?0:C+1}return this.viewList[M]},getSwitchDirection:function(z,F){if(z===null)return"right";var C=this.indexOf(z);if(C===-1)return"right";return this.indexOf(F)<
C?"left":"right"},getViewByUniqueId:function(z){for(var F=0;F<this.viewList.length;F++){var C=this.viewList[F];if(C.getUniqueId()===z)return C}return null},sortByMostRecentlyViewed:function(){this.viewList.sort(function(z,F){var C=z.getLastViewedTimestamp(),M=F.getLastViewedTimestamp();return C<M?1:M<C?-1:z.getUniqueId()<F.getUniqueId()?-1:1})},generateDiff:function(z){var F=new S([]);z=z.copy();for(var C=0;C<this.viewList.length;C++){var M=this.viewList[C];z.remove(M)||F.add(M)}C={};if(z.getLength()>
0)C.added=z;if(F.getLength()>0)C.removed=F;return C},getViewInfoList:function(){for(var z=[],F=0;F<this.viewList.length;F++)z.push(this.viewList[F].getInfo());return z},getPageListHtml:function(z){for(var F="",C=0;C<this.viewList.length;C++)F+=this.viewList[C].getPageHtml(z);return F},getJson:function(){return JSON.stringify(this.getViewInfoList())}});jQuery.fn.transitionOrAnimate=function(z,F,C){var M=$(this);$.support.transition?M.transition(z,F,C):M.animate(z,F,C)};return{init:function(){if(G=
!IS_MOBILE&&!projecttree.getMainProjectTree().isShared()){I=true;a(true);$(".savedViewPage").live("click",function(){var z=$(this);z=e.getViewByUniqueId(z.attr("data-uniqueid"));if(z!==null){o(null,z);setTimeout(m,1)}}).live("contextmenu",function(){return false});$(".page.active .pageStar").live("click",function(){t()}).live("contextmenu",function(){return false});$("#savedViewHUDButton").bind("click",function(){L?d(true):l(false,"none");return false});$("#savedViewHUD").bind("mouseenter",function(){c()}).bind("mouseleave",
function(){d()}).bind("mouseout",function(z){z.relatedTarget||d()}).bind("mousemove",function(){u=true})}},registerSettingChange:a,generateViewListJsonDiff:function(z,F){var C=b(z),M=b(F);C=C.generateDiff(M);M={};if("added"in C)M.added=C.added.getViewInfoList();if("removed"in C)M.removed=C.removed.getViewInfoList();return JSON.stringify(M)},HUDIsVisible:function(){return J},hideIfModifierNotPressed:function(){if(D===null)!y&&(K||N)||d()},notifyViewChanged:q,pretendModifierKeysNotPressedUntilTheyAreReleased:function(){y=
true},updateModifierKeyStatus:function(z,F){if(G){var C=!K&&!N;K=z;N=F;var M=!K&&!N;if(!C&&M)if(y)y=false;else{if(C=J){if(C=!(E||H)){if(!(C=!u)){C=$("#savedViewHUD").find(".savedViewPage.selectedSavedViewPage");C=!(C.length===1&&C.prev(".savedViewPage").length===0)}C=C}C=C}C&&m(true)}}},switchToSelectedViewIfAppropriate:function(){J&&!(E||H)&&m()},switchLeft:function(){r("left")},switchRight:function(){r("right")},toggleCurrentViewSaved:t}}(),video=function(){function a(){$("iframe").each(function(c,
f){f=$(f);var b=$("<webview>");$(["id","class","src","style"]).each(function(k,m){var h=f.attr(m);typeof h!=="undefined"&&typeof h!==false&&b.attr(m,h)});setTimeout(function(){f.replaceWith(b)},0)})}return{init:function(){IS_CHROME_APP&&a()}}}(),experiments=function(){function a(c){return c in EXPERIMENTS&&EXPERIMENTS[c].group==="test"}return{init:function(){if(a("absolute_quota")){$(".monthlyOnly").remove();$(".absoluteOnly").removeClass("absoluteOnly")}else{$(".absoluteOnly").remove();$(".monthlyOnly").removeClass("monthlyOnly")}},
enabled:a,getExperimentsStringForGoogleAnalytics:function(){var c=[];for(experimentName in EXPERIMENTS){var f=EXPERIMENTS[experimentName],b="code"in f?String(f.code):experimentName;f=f.group.charAt(0);c.push(b+"="+f)}return":"+c.join(":")+":"}}}(),upgrade_warning=function(){function a(){ui_sugar.showAlertDialog('<h1>Please upgrade your browser</h1><p>WorkFlowy no longer supports editing in Internet Explorer 8. We have made these changes as part of an effort to support text formatting in the future. Please upgrade to one of the following: <a href="http://google.com/chrome">Google Chrome</a>, <a href="http://getfirefox.com">Firefox</a>, <a href="http://windows.microsoft.com/en-us/internet-explorer/ie-11-worldwide-languages">Internet Explorer 11</a>. Sorry for the inconvenience.</p><p>If you can\t upgrade your browser, you can use <a href="http://bit.ly/193umUg">old.workflowy.com</a></p>')}
function c(){ui_sugar.showAlertDialog("<h1>Please upgrade iOS</h1><p>WorkFlowy no longer supports editing in iOS versions older than 6. We've made this change in order to support text formatting and other features in the future.</p> <p>If you can't upgrade iOS, you can use <a href=\"http://bit.ly/193umUg\">old.workflowy.com</a></p>")}return{init:function(){if(IS_IE&&IE_VERSION<9)a();else if(IS_IOS&&IOS_VERSION<6)c();else if(IS_IOS&&!appdetect.isIOSApp()){var f=projecttree.getMainProjectTree();if(!(f.isShared()&&
f.isReadOnly())){f.isShared()||$("#ios-browser-editing-notice .install-app-section").css("display","block");ui_sugar.showAlertDialog($("#ios-browser-editing-notice").html())}}},testWarnings:function(){a();c()}}}(),metrics=function(){return{track:function(a){$.post("/metrics/track/",{event_name:a})}}}();
